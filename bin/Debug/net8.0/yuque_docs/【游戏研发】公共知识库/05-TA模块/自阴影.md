# 简介：
提供了一套高精度的角色自阴影方案

**角色：**支持最多两个光源产生的阴影，光源类型可以为平行光或聚光灯，使用自阴影后会自动禁用URP阴影

**场景：**支持最多两个光源产生的角色投影+URP阴影，光源类型同上

**<font style="color:#DF2A3F;">默认仅支持UT材质使用自阴影功能</font>**

**<font style="color:#DF2A3F;"></font>**

# <font style="color:#000000;">效果对比：</font>
![URP](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730093587977-ad8cc9b0-b367-41dd-bd0f-3cb007a7d454.png)

![自阴影](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730093602574-5c0e46cc-a58f-41c0-9f9f-a229be2c7c37.png)

**仅阴影：**

![URP](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730092956750-c97fe837-72e4-43e5-84f9-9c8f49b20dab.png)![自阴影](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730093000235-ec76c632-8200-4cdb-a840-0f4cfd2c99f6.png)

URP阴影会因为精度问题产生比较明显的锯齿和漏光现象，对于角色来说是不能接受的；自阴影功能可以为角色提供单独的阴影效果，使阴影精度大幅提高



# 使用说明：
## 前置设置 & 参数说明：
以下3步互有关联，缺少任何一步都会使自阴影功能无法正常工作，全部阅读完后再进行操作

### RenderFeature
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730094997448-040ffca2-ec7d-45c9-a197-e002b0f400f8.png)

SceneRenderer 中添加 CharacterAllInOneFeature，完成初始设置，**<font style="color:#DF2A3F;">这一步会由TA来完成</font>**

**<font style="color:#000000;">参数说明：</font>**

**Scene Obj Shadow Lod: **未实装**  
****Chara Shadow Lod: **未实装**  
****Main Self Shadow Quality: **光源一自阴影的精度等级**  
****Additional Self Shadow Quality: **光源二自阴影的精度等级**  
****Layer: **自阴影功能生效的层级（不在设置中的Layer不会产生自阴影）**<font style="color:#DF2A3F;">(Important)</font>****  
****Depth Bias: **阴影偏移距离，同URP**  
****Raise Shadowmap Resolution: **将自阴影的精度提升一个档次，特定情况下使用，由程序控制开启**  
****Perfect Culling For Shadow Casters: **<font style="color:#DF2A3F;">使用Terrian时可能会出现闪退的情况，若出现则启用该设置</font>**  
****Switch To URP Shadow_Chara Only: **关闭自阴影功能，切换回URP阴影，配合高中低配使用



### Global Volume
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730096093235-b686f5a3-9b1e-4c63-9f33-94827853c96e.png)

在Global Volume中 Add Override -> UT.Rendering -> CharacterAVolumeControl 添加角色效果组件



![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730098162426-28bbf979-570a-4a95-94d7-53bcc46c5400.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730096373122-0f3d40e2-123c-45b6-862e-28fdfb9475b3.png)

**参数说明：**

**光源一自阴影设置**

**启用光源一自阴影：**启用后开启自阴影功能，显示光源一自阴影参数及通用自阴影参数

**光源一光源：**指定场景内的一盏灯光用于自阴影投影（限平行光和聚光灯）

**光源一自阴影强度：**光源一投射自阴影的强度

**光源一自阴影范围线框显示：**需配合1.3挂载的脚本使用，启用后显示光源一投影的范围

eg.

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1724294882306-ad8905a4-f8e5-454b-85c1-6c19b2e2c801.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)

**光源二自阴影设置**

**启用光源二自阴影：**启用后开启自阴影功能，显示光源二自阴影参数及通用自阴影参数

**光源二光源：**指定场景内的一盏灯光用于自阴影投影（限平行光和聚光灯）

**光源二自阴影强度：**光源二投射自阴影的强度

**光源二自阴影范围线框显示：**需配合1.3挂载的脚本使用，启用后显示光源二投影的范围

**角色环境色设置**

**角色环境色：**仅 FAStandard 材质或勾选了 Use Character Ambient Color 的 FASceneObject 材质，用于调整材质的环境光颜色，FAstandard材质精简了环境光的计算，仅用一个颜色替代

**假阴影设置：**

功能重做中

**通用设置：**

**自阴影生效范围：**即剔除距离，距摄像机距离超过改值的物体会被剔除出自阴影范围计算，避免距离过远导致自阴影精度降低，根据项目需求调整

**重载生效Layer：**覆盖RenderFeature中设置的自阴影生效Layer，部分关卡有特殊需求时使用

**使用NdotL光照：**默认开启，开启时能根据法线计算出更柔和的阴影（非软阴影），默认开着就行

**角色主光源设置：**

**角色主光源强度：**仅FAStandard，单独调整角色受主光强度的倍率

**角色主光源颜色：**仅FAStandard，单独调整角色计算主光时的颜色

场景主光查看方式：

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730101315783-42563aa0-34f0-48d4-aafe-4f755a386031.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730101350174-7cb26e2c-f7a4-4e59-a343-9b70958be4c9.png)

Sun Source若为空，则场景内非Baked模式的亮度最大的平行光就是场景的主光源；Sun Source不为空时里面的光源就是场景的主光源，主光源可以自己指定

### 挂载脚本
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730100346927-70083684-80db-4dbc-a469-3a1af7d4da20.png)

在需要投射自定义阴影的物体上挂载CustomShadowController脚本，配**合二、设置ShadowVolume中**的**自阴影范围线框显示**调整物体投影包围盒的大小和位置



**参数说明：**

**BoundRadius：**用于调整物体投影包围盒的大小

**PositionBias：**用于调整物体投影包围盒的位置

其他参数目前无需调整



![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1724295572168-4794895e-9316-42e0-83f9-ca1ab29008f0.png)

仅需在最上的层级挂载一次

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1724295608364-d8085581-27ad-49ec-99c1-edb04c9ab612.png)

预制件中不好直接设置（没有ShadowVolume配合），可以在场景中调完后Apply回去



## 注意事项：
### 光源使用
正常情况下推荐只启用一个光源的自阴影功能，且这个光源尽量使用主光源；仅类似角色展示界面的情况允许2个光源的自阴影同时开启

### 保留序列化脚本
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730102014114-497399bc-a801-43b3-a394-2bcd7044d0ab.png)

Global Volume中设置光源时会自动创建一个脚本储存光源信息，不要移除或禁用该脚本，否则下次进入场景时光源信息将无法还原

### 多个Volume情况
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730102175975-ce40ceb0-5389-48d0-b217-200b9e67b9ac.png)

场景内存在多个Volume时，会使用高优先级的Volume中的参数

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1730102294158-629b4caa-9952-45a8-83b2-ce667cd26624.png)

若高优先级的Volume中的参数未开启重载，则会依次使用更低一级的Volume中的参数设置

