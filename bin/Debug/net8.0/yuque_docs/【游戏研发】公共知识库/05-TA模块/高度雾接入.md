提供给需要高度雾接入阅读（以FASceneObject为例）

##### 1.添加Height Fog
1.确认RenderData文件添加了EvironmentAllInOneFeature 

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723110196985-3a56bef2-1404-43c2-8a9f-1e904a8bb16d.png)



2.场景添加volume

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723623142219-83d16f98-e77b-4e99-a737-6931a0736661.png)

3.volume预设添加EnvironmentVolume添加雾效

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723629722762-ad11eb14-fb4e-4609-aa9a-3cea0da49389.png)

new一个或者拖入已有预设

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723623225352-8a03407d-7fd9-4328-8ed8-7611315999d7.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723623297194-aba117c8-3091-40af-81d4-503a2bc3410a.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723623312773-db56b677-1e89-48fe-b081-4357b95e2244.png)

打开高度雾

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723107515786-0f671237-1cbb-4f3f-90bd-c0a5f88eaa2f.png)

确认SetFogParamPass传参生效

##### ![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723025945974-2e5607ce-166f-4c50-ad31-79a30aa49473.png)
##### 2. 导入雾效计算函数
shader导入FACustomFogLib.hlsl和FAHeightFogDebug.hlsl（具体路径视项目而定）

输入部分定义

half _FogIntensity;

half _FogMode;

（要不要放CBUFFER视情况而定）

FACustomFogLib是雾效具体计算过程，FAHeightFogDebug是一个debug函数

雾效参数由SetFogParamPass从EnvironmentVolume中定义得到

雾效具体计算在FACustomFogLib里面的CustomMixFogColor函数（计算过程略）：

输入（float3顶点坐标）

输出（half3雾颜色，half影响因子）

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723109614845-7d191cfb-527c-48cb-b6e8-b0d8aa770ae8.png)

输出struct要加一个half4寄存器

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723518989261-1ce25227-5c67-4d1f-bef7-ec53e58ea08a.png)

再加一个float3寄存器从（这里是float4是要再拿一个FogFactor）

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723519027008-e2cd0b75-6c97-4ed5-9fa5-1c454fe7c3fd.png)

vertexInput.positionWS以便在片元阶段拿WS空间顶点坐标

##### 3.调用CustomMixFogColor函数
在顶点/片元着色器都可以，这里根据需求加了关键字切换

顶点计算消耗小于片元

输入（顶点（WS空间），输出结构体的xyz，输出结构体的w）

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723107708347-22ba6ae6-bf18-4117-9574-5098903eb579.png)

输出一个half4，xyz是雾颜色，w是影响因子

##### 4.插值雾效颜色和其他颜色
其他shader不用这个函数也可以，完成standard color和雾效颜色的插值就可以

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723179963842-9a01eef4-6977-4e80-aafc-6f2ea74fc21b.png)

（这里是在片元着色器计算的例子，与上面顶点着色器计算二选一）



![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723107810275-d3f772f8-a33c-421d-9db5-31a0fb1718af.png)

在片元着色器调用OutputSceneObjectPBRColor函数

第一个color就是前面算的standard color 略

第二个关键字_ENABLE_HEIGHT_FOG_SHADING_DEBUG根据需要开启，关键字在FAHeightFogDebug.hlsl里面

最后把color.rgb（shader最后输出的颜色）和前面得到的half4的xyz（input.fogColor.xyz（也就是前面的颜色））用w（input.fogColor.w（也就是前面的影响因子））插值

（片元着色器的input就是顶点着色器的output）

最后输出最终的color





##### 5.参数列表说明
useFog：总控开关，关掉的话会连着CustomHeightFog模式的FogIntensity一起失效

fogDensity：雾效强度

fogDensityMax：雾效强度限制最大值，实际雾效强度= 雾效强度 和 雾效强度限制最大值 中的较小值

fogOpacityTop：上半部分雾效透明度

fogOpacityBottom：下半部分雾效透明度

fogHeight：高度，控制雾效整体上移

heightFallOff：高度衰减，一般设为一个很小的值（0.0x）

fogTopColor：上半部分雾效颜色

fogBottomColor：下半部分雾效颜色

gradientTop：顶部渐变，控制雾效从下往上的渐变

gradientBottom：底部渐变，控制上下两层颜色的分界线上移/下移

fogStart：基于Camera计算的雾效衰减距离



##### 6.GUI面板说明：
说明：

两种FogMode：HeightFog和CustomHeightFog

HeightFog模式即正常的雾效模式，雾效受衰减距离影响

CustomHeightFog即简便雾效，雾效强度不受计算影响，转为由面板上的FogIntensity参数控制，

此时FogIntensity才生效，（HeightFog模式FogIntensity失效）



新的GUI：

把老的

<font style="color:#74B602;">  //[HideInInspector]_FogMode("Fog Mode", Float) = 0</font>

<font style="color:#74B602;">//[HideInInspector]_FogIntensity("Fog Intensity", Range(0.0, 1.0)) = 0.5</font>

删除

新写入LWGUI

[SubEnum(_, HeightFog, 0, CustomHeightFog, 1)] _FogMode ("Fog Mode", Float) = 1

[ShowIf(_FogMode, Equal,1)]

[Sub] _FogIntensity ("FogIntensity", Range(0.0, 1.0)) = 0.5

底下接入CustomEditor "LWGUI.LWGUI"

对应原shaderGUI定义0和1两个枚举由HeightFog和CustomHeightFog面板选项控制

_FogMode=0的时候用计算的强度，_FogMode=1的时候用面板设置的强度

CustomMixFogColor函数中：

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723026044872-3309b06a-1f6f-438c-ae20-999125a595ad.png)



HeightFog模式就是用volume控制雾效，此时_FogMode= 0

影响因子expFogFactor不受FogIntensity影响

CustomHeightFog模式就是用FogIntensity控制雾效，此时_FogMode = 1

影响因子expFogFactor等于1 - _FogIntensity，同时面板暴露FogIntensity参数控制雾效



##### 7.常见问题
1.添加雾后HeightFog模式没有反应，CustomHeightFog才能正常显示

因为fogStart有默认值，可能因为模型离Camera太近雾计算了衰减

解决方法：把模型放大/距离拉远

##### 
##### 8.其他
根据需求像素雾开关移至Renderdata，可全局切换顶点雾/像素雾

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1723186340286-5ea104be-94a0-44c8-b7e5-11941affd921.png)













