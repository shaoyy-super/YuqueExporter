

# 基础版：
基础方案大体参照FA现有模式，区别为移除单独给角色投影的CharacterSceneShadowPass，改为使用URP阴影

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1721212196804-5f99d87f-6284-4160-8815-6613716cb38a.png)



### 挂载脚本：
提供挂载在角色身上用以计算自阴影范围的脚本，Enum：1.角色，2.场景

### Volume：
自阴影功能开关：默认False，IsActive()返回这个开关的value

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1721209802871-422a3c82-5fdd-478a-8a44-61f30b047f55.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1721209825969-433e386e-71f1-46e3-82dc-5fe3021c9769.png)

继承原EnvironmentShadowParam和EnvironmentCustomShadowParam阴影部分参数（后续视情况删减）

获取场景内所有挂载脚本的功能（触发？实时？Editor模式？）

补光选项开关

       补光光源

            （为聚光灯时）需要URP投影

       补光相关设置

URP阴影范围倍率

场景投影LOD等级

角色投影LOD等级

阴影质量升档开关

Gizmo开关

挂载脚本的角色List存储



暂不做模式切换的Enum，先实现基础功能

### Feature:
参考EnvironmentAllInOnFeature，主要起管理Pass的功能（插入时机，激活与否）（联动全局阴影设置，如全局设置自阴影不生效时，不插入自阴影Pass）

### Pass：
CustomSelfShadowPass: 

1. 投影光源获取（仅平行光），光源未于Volume里指定时的逻辑处理：1.报错，2.读取当前场景主光源（或者编辑器下未指定时报错，打包后读当前场景主光源）
2. 进一步确定自阴影范围，各种剔除：未激活的角色，视口外的角色，设定最大距离外的角色（联动Volume），Enum为场景的物体，Layer剔除（后续版本添加）  优化：剔除后List为0则直接退出
3. 申请shadowmapRT（与Volume阴影质量升档及全局阴影质量联动），计算投影矩阵
4. 设置自阴影相关全局变量，画RT
5. Gizmo线框显示当前自阴影范围



### 角色Shader:
1. 加入ShadowCaster和SelfShadowCaster Pass，实现相关逻辑
2. ShadowCaster与SelfShadowCaster联动Volume LOD设置
3. 自阴影计算相关函数及函数库建立
4. 角色渲染Pass内，设定关键字，include 2中的自阴影lib，注意不引入URP阴影计算的逻辑（最好能把URP阴影那张shadowmap也毙了，有时间再尝试）



### **场景Shader:**
1. ShadowCaster联动Volume LOD设置

### 
# 展示，双光源：
FA中因为需要聚光灯投影，所以需要将聚光灯设作主光，由此产生了一系列的其他工作

因为现在把CharacterSceneShadowPass毙了，所以光源类型与主光与否都不再重要

现设计的逻辑为：

Volume补光开关开启时，提供额外光源选项，可以是平行光或聚光灯（为适应美术使用习惯，面板上可以通过修改GUI将这盏灯假装成主光，实际代码还是按照补光的逻辑走）；

因为移除了CharacterSceneShadowPass，角色不对场景进行投影，现增加AdditionalSelfShadowPass在实现角色自阴影的基础上，同时增加对场景投影的功能



### 




场景投影方法设计：为需要接收角色投影的物体（eg.地面）挂载脚本，Enum设置为2.场景，Enum为2代表参与自阴影投影计算，但不参与阴影范围计算；然后场景shader内开一个接收角色阴影的开关，材质内打开开关，并且Volume补光开启且光源类型为聚光灯时，计算URP阴影与AdditionalSelfShadow的混合（保险设置：美术很可能出现挂了脚本但没改Enum的情况，需要在Volume中增加保底检查，eg.检查挂载脚本的Actor使用的材质/其他角色特有的特征，不符合的就分到场景List）



可能的消耗，需要接收角色投影的场景物体需要采样两张shadowmap，加上这种物体（eg.地面）屏占比一般较大，开销可能高于CharacterSceneShadowPass的做法，不过这种情况目前只会出现在使用聚光灯时的展示场景，或许也还好？

### Feature:
Volume内补光开关开启时，添加AdditionalSelfShadowPass

### Pass：
CustomSelfShadowPass: （基础版，未涉及修改）

1. 投影光源获取（仅平行光），光源未于Volume里指定时的逻辑处理：1.报错，2.读取当前场景主光源（或者编辑器下未指定时报错，打包后读当前场景主光源）
2. 进一步确定自阴影范围，各种剔除：未激活的角色，视口外的角色，设定最大距离外的角色（联动Volume），Enum为场景的物体，Layer剔除（后续版本添加）  优化：剔除后List为0则直接退出
3. 申请shadowmapRT（与Volume阴影质量升档及全局阴影质量联动），计算投影矩阵
4. 设置自阴影相关全局变量，画RT
5. Gizmo线框显示当前自阴影范围

AdditionalSelfShadowPass：

1. 投影光源获取（平行光或聚光灯），光源未于Volume里指定时的逻辑处理：报错
2. 进一步确定自阴影范围，各种剔除：未激活的角色，视口外的角色，设定最大距离外的角色（联动Volume），Enum为场景的物体，Layer剔除（后续版本添加）  优化：剔除后List为0则直接退出
3. 申请shadowmapRT（与Volume阴影质量升档及全局阴影质量联动），根据光源类型计算对应的投影矩阵
4. 设置补光自阴影相关全局变量，画RT
5. Gizmo线框显示当前自阴影范围



优化项：

两个Pass内都有阴影范围的计算，但实际是一个东西，看看有没有什么方法能让他们共享，放Feature里做可以实现，但之前提过Feature里最好只做管理Pass相关的逻辑，如果实在不行的话就还是丢Feature里

### 角色Shader:
1. 添加SelfShadowCaster和AdditionalSelfShadowCaster，实现相关逻辑，添加关键字控制角色是否投URP阴影
2. 自阴影计算相关函数及函数库建立（两个SelfShadow的融合计算）（Additional Light是聚光灯时的阴影计算逻辑，Additional Light的获取方法？）（通过关键字跳过ShadowCaster）
3. 光照计算相关函数及函数库建立（启用AdditionalLight后与主光的融合）（Additional Light是聚光灯时的光照计算逻辑）
4. 角色渲染Pass内，设定关键字，include 2，3中的lib，注意不引入URP阴影计算的逻辑



### **场景Shader:**
1. ShadowCaster联动Volume LOD设置
2. 加入接收角色投影的开关选项
3. 添加AdditionalSelfShadowCaster，实现相关逻辑，通过关键字和本地开关控制启用情况
4. 自阴影计算相关函数及函数库建立（AdditionalSelfShadow和URP阴影的融合计算）（关键字和开关控制启用情况）
5. 场景渲染Pass内，设定关键字，include 3中的lib





### 展示模式：
**聚光灯模式（展示模式）：**

聚光灯（补光）：角色自阴影+角色对场景投影

平行光（场景自有）：角色自阴影

**双平行光（展示模式）：**

平行光（场景自有）：角色自阴影+角色对场景投影

平行光（补光）：角色自阴影



### 固定模式：
只有一个场景平行光：角色自阴影+角色对场景投影



### 主要拆分任务：
管线：（张毅杰）

1. Volume, Feature框架搭建&挂载Componet组件的管理方法 （1）
2. CustomSelfShadowPass: (1)

       阴影距离剔除计算修改

       (可以建立测试场景)

3. AdditionalSelfShadowPass:(2)（ 其中配合shader联调（1））



shader：（朱曈晖）

1. shadowMap的顶点shader（1）
2. shadow的角色着色shader片段（2）

     （可以建立测试场景）

3. shadow的场景着色shader片段（1）
4. 多光源阴影融合算法





# 流程：
1. 先使用FA的角色材质（移除材质出现错误的可能），实现基础版自阴影管线相关的所有逻辑
2. 基础版管线验证完成后（移除管线出错的可能），新建测试材质与函数库，实现自阴影逻辑
3. 增加多光源情况下管线与材质相关逻辑



### 


### 
