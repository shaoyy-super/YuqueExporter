## 需求：
Boss鱼和特殊Boss投射自阴影，Boss鱼单独打光且光源不影响场景



## 实现方法：
**前置三件套：**

SceneRenderer:

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725694356044-f596483e-15b3-49a1-a808-7b66be84394c.png)

设置默认自阴影生效Layer（按需设置）

CharacterVolume:

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725696430141-5bde9b9c-259c-495e-8d06-c0db7819316c.png)

捕鱼项目的比例较大，摄像机距离鱼群较远，为防止距离剔除导致自阴影不产生，自阴影生效范围可以先拉满



CustomShadowController:（挂模型上）

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725694482591-eeec2ffb-6c12-4513-b52f-fc0c01158001.png)

**为捕鱼项目增加了一个投射URP阴影的开关（见红框）**，目前其他项目没有同时投自阴影和URP阴影的需求，因此默认关闭，**捕鱼项目内需要手动打开**



建议先建一个场景给所有的Boss鱼和特殊怪的预制件挂上CustomShadowController脚本，开启Cast URP Shadow并调整好合适的Bound大小，不然后面Timeline里边单独改起来会很麻烦



### 方案：
#### 模型：
所有鱼的Layer都设置为Character，特殊Boss设为Character3，Boss鱼和特殊Boss因为要投自阴影挂载上CustomShadowController脚本



#### 新建FAStandard材质设置：
**鱼（非Boss）**

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725696156392-472cb4a8-1ab4-4a11-9bd3-5303a1b2b0ed.png)

把_SelfShadowIntensity和改成0，让他不计算自阴影



**通用：**

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725695907926-7f53973f-d07b-4a4b-9b91-727257c038a8.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725695949685-c87708fd-fb07-4127-9d3a-c4ffa5c6bf4d.png)

Debug模式检查Disabled Shader Passes里有没有SHADOWCASTER，有的话移掉



**当前所有鱼的材质都设置过了，有新增的话需要注意一下**



#### 灯光：
![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725694873080-73be6fb4-38d4-43d1-a2a7-a01fb8102e84.png)

**光源一为场景主光，cast layer排除特殊Boss的Layer，**其他的Layer按需设置（注意光源的Cast Shadow需要打开）

**<font style="color:#74B602;">（NEW）</font>**光源一需同时为场景主光

设置方法：

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725937279211-d2550066-d4ab-4206-96bf-3247d2849fdf.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725939070517-d234ab48-7df0-47ea-9ffe-86280ee522a4.png)

进入场景，Window-Rendering-Lighting打开灯光面板，Environment - SunSource中将Volume中的光源一光源置入Sun Source



![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725695041479-9f2d3149-a3f4-4495-8e02-e8c63cb43ef5.png)

**光源二为特殊Boss投影专用光，cast layer只包含特殊Boss的Layer**（注意光源的Cast Shadow需要打开）

如果在Timeline里新建CharacterVolume来调整光源二参数的话，需要把新建Volume的Priority提高，或者保证场景内的CharacterVolume光源二相关参数没有被设置（建议用提高Priority的做法，比较保险），新建CharacterVolume只调整光源二相关参数，其他的不要动





## 自阴影不产生问题排查：
1. 三件套检查：ChararterAllInOneFeature有没有挂到SceneRenderer上，Layer是否设置正确；场景内CharacterVolume是否挂载，自阴影功能是否打开，场景内是否加入了多个CharacterVolume；CustomShadowController是否挂载，是否启用，Bound范围是否覆盖了模型
2. 光源检查： 正在调试的光源是否加入了Volume，光源是否启用，光源投影是否打开，光源cast的layer是否正确
3. 距离检查： 如果Scene视图凑近了有自阴影，但Game视图没有，提高Volume“自阴影生效范围”参数
4. 材质检查：材质内_SelfShadowIntensity属性是否被调0

![](https://cdn.nlark.com/yuque/0/2024/png/45354151/1725697454712-76d6320b-ea03-456f-bc4d-639b5bf3e654.png)

5. 自阴影线框不显示：检查Volume内的自阴影线框显示是否打开，检查CustomShadowController是否挂载，Bound范围是否过小，然后参考步骤1，2，3
6. 以上都检查过了没有问题，找TA



