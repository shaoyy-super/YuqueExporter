# SP制作注意
## 建立SP项目时，需要确保Normal Map Format选择OpenGL格式。Unity的法线一般都是采用此格式。
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723483059311-3abf9e91-91d2-46e9-9f42-84c97fbcdfb8.png)



## 点击SP左上角的Edit栏目，找到下面的“自动设置项目初始配置”。该功能将会自动设置项目必需的通道以及相应的图层结构。（使用此功能，即可省去手动按贴图流程设置通道及建立图层结构的操作。）
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723483215935-fecd45cd-b1d8-4e0d-a514-e192d9a77909.png)

## （可选）如果是制作半透明材质，可点击Edit栏目下的“打开半透明”，这会在执行SP导出功能时，带上半透明选项，确保在Unity解析材质时能正确使用半透明的材质球。
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723483525459-e2de0ab7-baac-45c5-b23b-05ad7def9391.png)

    - **<font style="color:#DF2A3F;">注意！如果此选项会对整个FBX的材质生效，SP目前没法给一个TextureSet设置不透明，另一个TextureSet设置成半透明。如果要分开透明类型，只能分成两个FBX模型来做。</font>**
    - 如果要在SP里**预览半透明效果**，还需要自行设置SP的着色器参数（SP的插件接口暂时不提供这方面的功能设置）。
        * 找到下图标记红1的着色器栏目并点击打开；
        * 标记红2的地方是SP此时使用的着色器，一般默认为**asm-metal-rough**；
        * 找到标记红3地方，**Enable alpha blending**就是开启透明度混合，一般半透明效果开启这个选项即可。Enable alpha test是开启透明度测试，一般用于硬透，就是像素的透明度要么完全0，要么完全1。
        * （可选）标记红4的地方，Double sided用来开启双面，单层面片的半透明可能开启双面效果更好。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723483603240-3874ddfd-27ad-498a-8cbf-c55889e32f23.png)

        * （可选）点击asm-metal-rough着色器，会弹出一个窗口，提供选择其他着色器的可能。其中如下图所示的pbr-metal-rough-with-alpha-blending是另一种默认支持半透明的着色器，也可以选择用来预览半透明效果。
        * ![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723484004891-d789bbcf-3294-4fad-a9cb-c72f8e9dc49b.png)



## 贴图制作时需要遵循一定图层结构，并将内容写入到指定通道。（注意2的操作会自动设置好，需要注意不要破坏这些设置）
+ 如下图所示，注意2的操作会自动设置如下通道，
    - Mask1、Mask2、Mask3、Mask4是新增的用于填充遮罩区域的通道。
    - Opacity是用于填充透明度的通道。不透明材质使用时，只要图层设置中不写入Opacity就行。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723484229848-88459c92-192d-4c73-9dca-47b3e4f962e3.png)

+ 下图展示的是注意2自动设置的图层结构。这里使用时注意点比较多。![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723484571801-77443a1b-2fa3-4d5b-9dfe-c7ee5afcddf8.png)

### 区域 n（Folder n）：代表第n个区域，n越大、图层越靠上渲染时优先级越高。第1/2/3区域是染色区域，会使用细节法线Tiling，但不支持单独的区域颜色、粗糙度、金属度贴图，仅支持通过数值直接调整颜色、粗糙度、金属度。
### 遮罩 n（mask n）：代表第n个区域的遮罩图。这是代表第n个区域整体的遮罩图，必须放在{区域 n}图层组下面的第一个位置。该图层仅写入内容到maskn通道，已自动设置好无需调整。
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723485097130-82d298f5-c4ec-4f80-8bd8-254d1b109782.png)







### 材质 n（mat n)：代表第n个区域的内容图层。对于第1/2/3区域，都必须有一个{材质 n}图层放在{遮罩 n}图层下面紧邻的位置。该图层用于设置具体的可染色材质，同时必须要写入内容到color、rough、metal、nrm通道，也已自动设置好。若有特殊操作需求，可以在{材质 n}下面新建额外的图层自行使用。对于第4区域，有一个自动生成的{材质组(mat_group)}文件夹，需要绘制的不染色用图层统一放在此文件夹下即可，无顺序要求，写入通道也自行按需设置。
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723485356432-d4f85381-7f1d-4431-bca2-0edb2d8717b2.png)

#### 图层设置Material模式，即一个材质控制多个通道:
SP中图层设置材质分为两种模式，第一种就是一个材质控制多个通道，也就是先确定需要什么材质，然后再思考这个材质的内容需要写入到哪些通道。这种情况下，只能使用SD材质或者SP图层里的锚点。一般常用的也就是这种方法，毕竟颜色、粗糙度、金属度、法线一般都是由SD材质配置生成的。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723485724299-4f52d69f-6887-4186-ba9e-42a86cdd2bfa.png)

#### 图层设置Split模式，即多个通道有独立的材质设置：	
第二种就是多个通道各自设置自己的材质，也就是先确定需要哪些通道，然后对于每个通道再思考需要给它设置什么内容。可以给这个材质来设置写入内容到哪些通道。这些单独通道可以设置纯色、贴图、字体、SVG图片、SD材质，以及SP图层里的锚点。这种方法比较适用于没有专门制作的SD材质，只有一张细节法线贴图。这样就可以normal通道直接放法线贴图，color通道放纯色，直接改颜色，metal和rough通道是灰度，直接调数值。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723485999146-c6c24d5c-76ca-4078-abad-eb2beb06593e.png)

> 使用外部贴图时，注意导入贴图时保存到your assets里，作为sp资产存在，而不要保存到项目或者会话里。
>
> ![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723614454650-96f95d71-d2be-4e67-be69-8a00765b4cd9.png)
>



### {材质 n}的制作中有不少自由发挥的空间，但自由发挥也有可能导致使用者不明白会产生什么效果，因此这里需要明确几个关键点。
1. **SP导出的贴图内容取决于通道**。可以使用下图中的下拉框，来筛选只显示特定通道的内容。SP导出的贴图会与此处筛选后显示出的内容保持一致。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723486639275-8087fa54-6927-4e10-985a-5bf17046858a.png)

2. **通道的内容取决于各个图层是否写入到该通道**。因此，使用者需要明确知道自己新建图层时，会用到哪些通道，以及这些通道是用来做什么的。同时，尽量不要去改变{遮罩 n}和{材质 n}图层的通道设置，除非自己有什么特殊需求以及明白其原理。
3. 此流程中，按照**高配可染色、低配可染色、通用不染色**三种配置，通道代表的含义也各不相同。但总体来说，制作时是按照**通用不染色**来制作的，然后SP插件会自动适配剩下两种配置并进行贴图导出。
    1. 对于高配可染色来说：
        1. color：仅包含{区域 4}中的颜色；
        2. normal：仅包含{区域 4}中的法线及模型法线；
        3. rough：包含全部图层的粗糙度。但由于遮罩，Unity仅使用其中{区域 4}的部分；
        4. metal：包含全部图层的金属度。但由于遮罩，Unity仅使用其中{区域 4}的部分；
        5. emiss：包含全部图层设置的自发光。
        6. ao：包含全部图层及模型的AO。
        7. op：包含全部图层的透明度。
    2. 低配可染色：
        1. color：仅包含{区域 4}中的颜色；
        2. normal：包含全部图层的法线及模型法线；
        3. rough：包含全部图层的粗糙度。但由于遮罩，Unity仅使用其中{区域 4}的部分；
        4. metal：包含全部图层的金属度。但由于遮罩，Unity仅使用其中{区域 4}的部分；
        5. emiss：包含全部图层设置的自发光。
        6. ao：包含全部图层及模型的AO。
        7. op：包含全部图层的透明度。
    3. 通用不染色：
        1. color：包含全部图层的颜色；
        2. normal：包含全部图层的法线及模型法线；
        3. rough：包含全部图层的粗糙度；
        4. metal：包含全部图层的金属度；
        5. emiss：包含全部图层设置的自发光。
        6. ao：包含全部图层及模型的AO。
        7. op：包含全部图层的透明度。
4. 根据3中不同配置下通道意义，可以发现**通道和图层所在组息息相关**。这里明确一点，在SP插件进行自动导出时，会根据不同配置需求，对部分特定图层进行程序自动操作：
    1. 进行高配导出时，程序会自动关闭{材质 1}、{材质 2}、{材质 3}图层的color、normal通道。导出后会还原。
    2. 进行低配导出时，程序会自动关闭{材质 1}、{材质 2}、{材质 3}图层的normal通道。导出后会还原。
    3. 进行通用不染色导出时，程序会不做任何修改直接导出。



## 导出贴图时，可以直接点击File栏目下的几个导出按钮。
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723487776247-f642923a-f280-4c89-b5b3-699e0ff62dbc.png)

+ **导出贴图及材质信息**：此功能将导出高配、低配、通用不染色三种配置的贴图以及json材质文件。
+ **高配：导出贴图及材质信息**：此功能将仅导出高配贴图及json材质文件。
+ **低配：导出贴图及材质信息**：此功能将仅导出低配贴图及json材质文件。
+ **通用不染色：导出贴图及材质信息**：此功能将仅导出通用不染色贴图及json材质文件。
+ **调试：导出贴图及材质信息**：此功能将导出高配贴图、一些额外的调试用贴图，以及json材质文件。



## （可选）可以使用SP插件自带的四种导出预设来手动导出贴图进行测试。不过该过程需要注意一些导出设置。
+ 如下图所示，导出模版里会多出四个SP插件的预设
    - Unity_HighPreset：对应高配可染色；
    - Unity_HighPreset_Debug：对应调试用的高配可染色；
    - Unity_LowNoPaintPreset：对应通用不染色；
    - Unity_LowPreset：对应低配可染色。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488113401-a6924687-28ea-4380-808a-1f85eb5d569d.png)

+ 如下图所示，自行导出贴图时也需要注意，文件格式采用tga格式，padding填充方法采用no padding或者**Dilation infinite(以这个为主)**方法。这两个设置也是注意5中自动导出贴图的设置。

![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488176917-1624d69b-0028-4db6-ba04-78d8ce47ac8d.png)padding填充的设置会对导出的贴图产生较大的影响，同时其也会影响Unity中MipMap的效果，以下具体说明以下不同padding填充的区别：

#### 非填充，SP筛选BaseColor视图
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488643473-e20bba33-1a5e-4cc8-b2a7-d3810030933e.png)

#### No padding
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488773101-8233cbfc-f516-42a8-b922-43230c35b3c4.png)

#### Dilation infinite
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488692947-4ad8e1d2-cb91-4a8f-82a7-5051df39ce12.png)

#### Dilation + transparent
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488869144-3a2d97e0-b8c9-476a-a537-3df18ff3a056.png)

#### Dilation + default background color
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488908320-f8d4edba-3622-440a-b49a-9a6a554d8b12.png)

#### Dilation + diffusion
![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723488933237-58f54c83-d267-43d2-a766-d5de72b2882c.png)





## 关于SD材质或者Split模式中Normal用到细节法线的贴图，SP插件也会自动将三个可染色区域的normal通道渲染到一张平面上，uv复位，然后导出成128x128的细节法线贴图。
+ 128x128是因为SP能调的最低分辨率就是128x128。
+ 这种细节法线贴图，在制作时也有要求，必须得在2k分辨率下，仅包含4~10个左右最小可重复结构。这样才能确保其分辨率降到128x128，甚至在Unity中被压缩到64x64后，依然能保持足够高的信息量。
+ 因为精度较高，在Unity中Tiling过高时，斜面上容易出现过渡条纹，这时候需要开启三线性过滤，或者提高贴图各向异性等级。不过因为三线性过滤消耗太大，所以实测后发现将贴图各向异性等级设为2性价比比较好。目前Unity端在解析SP材质时会自动对细节法线做此处理。

> <font style="color:rgb(69, 84, 99);">只有Metal, Vulkan and OpenGL 三种APIs，可以分开独立控制mipmap过滤和各向异性过滤等级,。其他图形Api里，一旦打开各向异性，会默认开启三线性过滤。</font>
>





# SP export_materials插件
## 介绍
记录Substance Painter中Python插件的安装及用法。

## 用法
### General Usage (Substance Painter插件通用安装方法)
要求：Substance Painter Version 10.0.0及以上

1. 将SubstancePainterPythonPlugins -> plugins目录内的所有文件复制到Substance Painter用户文档目录的python -> plugins目录下。

> + Substance Painter用户插件目录完整路径一般为：`C:\Users\{User}\Documents\Adobe\Adobe Substance 3D Painter\python\plugins`
> + {User}是电脑的用户名，不同电脑，用户名各不相同。
>

2. 打开Substance Painter，点击界面左上方工具栏中的 **Python** 栏目，点击想要打开的插件名字，确保勾选上即可。

> + 如果找不到对应插件名，可以点击Python栏目最下面的"重载插件目录(Reload Plugins Folder)"。
> + 插件名字和plugins目录下的python文件同名，且Substance Painter加载插件时，只会加载plugins目录下一级内的python文件，不会递归加载子级文件夹中的python文件。
>
> ![](https://cdn.nlark.com/yuque/0/2024/png/1660870/1723489215336-9eb95622-db00-4be4-b92e-528e4ff8f8c0.png)
>



### export_materials.py (SP材质及贴图导出插件)
1. 使用插件提供的“**自动设置项目初始配置**”设置好通道及图层。
2. 给图层添加内容。
3. 点击界面左上方工具栏中的 **File(文件)** 栏目，再点击 **导出贴图及材质信息（Export textures and save material settings to json）** 即可。
4. 观察Substance Painter界面下方的 **Log(日志)** 窗口，找到导出文件所在目录。

> + 一般导出的文件和打开的sp项目文件在同一目录下。假如sp项目文件名为meetmat.spp，那么导出的文件就在同级目录的meetmat_export文件夹内。
>

4. 导出文件夹内的目录结构说明如下:
+ TexturesHighPreset：存放高配且可染色配置的贴图
+ TexturesLowPreset：存放低配但可染色配置的贴图
+ TexturesLowNoPaintPreset：存放给一般着色器或第三方使用的贴图（即配合一般着色器使用，而不是项目指定的着色器） 
+ xxx_export_material.json 存储mesh、材质、uv等信息，用于Unity获取相关材质信息。



## 日志
1.0.1 支持Mesh信息、材质信息、UV信息、SD材质sbsar文件，以及贴图文件的自动导出。

1.0.2 支持单独导出高配、低配、通用、调试，支持半透明模式、支持自动初始化项目、支持单独导出细节法线。



# 示例项目
在内网用文件浏览器访问如下目录获取SP测试项目及SP插件脚本：

+ "\\192.168.0.231\AI及Web3游戏研发中心\公共资源\05_美术资料\贴图制作流程材料\SP测试项目\test_f007_cloth.spp"
+ "\\192.168.0.231\AI及Web3游戏研发中心\公共资源\05_美术资料\贴图制作流程材料\SP插件\plugins.zip"

