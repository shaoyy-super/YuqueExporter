基于一个基本的PBR Metallic Roughness光照模型修改

贴图导出通道：

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725003911084-34b31d58-ff62-4e04-812c-73af2b937fcb.png)

代码结构：

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725879037135-2067b43a-78d0-4d14-b1dc-5229ad2dd30f.png)

### 基本棉质材质实现
##### 前置阅读：
![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725007252890-a02ad346-714e-47b2-a58a-d3319cd1c936.png)

棉/麻/织物等材质是由一根根的线织出来的，对光线进行吸收和散射，入射光与视线相反时，纤维会对光进行前向散射，入射光与视线相同时，纤维会对光进行前后散射，呈现出边缘照明效果，还有一层在表面绒毛的存在，这是一层的绒纤维，属于一层树立在表面的短绒毛，但是这层绒毛的方向和长短都是不确定的, 需要实现这两层的渲染效果, 在实现直接光的镜面高光时，需要使用两层高光去实现, 正常的表面使用反向的GGX高光，然后再使用一层高光来表现表层上面的绒毛的镜面高光效果。

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725008174731-cab25ab1-90b3-4e11-bb94-014938deade5.png)



##### 直接光部分：
毛绒材质与普通PBR材质主要差异在高光部分

对原BRDF函数进行修改

把原本的高光部分拆成两道高光对应底层毛绒和第二层短绒毛效果



原BRDF：

<font style="color:blue;">float3</font><font style="color:darkmagenta;"> BRDF</font><font style="color:black;">( </font><font style="color:blue;">float3</font><font style="color:black;"> DiffuseColor, </font><font style="color:blue;">float3</font><font style="color:black;"> SpecularColor, </font><font style="color:blue;">float</font><font style="color:black;"> Roughness, </font><font style="color:blue;">float3</font><font style="color:black;"> N, </font><font style="color:blue;">float3</font><font style="color:black;"> V, </font><font style="color:blue;">float3</font><font style="color:black;"> L,</font><font style="color:blue;">float3</font><font style="color:black;"> LightColor,</font><font style="color:blue;">float</font><font style="color:black;"> Shadow)</font>

<font style="color:black;">{</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> a2 = </font><font style="color:darkmagenta;">Pow4</font><font style="color:black;">( Roughness );</font>

<font style="color:black;"></font><font style="color:blue;">float3</font><font style="color:black;"> H = </font><font style="color:darkmagenta;">normalize</font><font style="color:black;">(L + V);</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> NoH = </font><font style="color:darkmagenta;">saturate</font><font style="color:black;">(</font><font style="color:darkmagenta;">dot</font><font style="color:black;">(N,H));</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> NoV = </font><font style="color:darkmagenta;">saturate</font><font style="color:black;">(</font><font style="color:darkmagenta;">abs</font><font style="color:black;">(</font><font style="color:darkmagenta;">dot</font><font style="color:black;">(N,V)) + 1e-5);</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> NoL = </font><font style="color:darkmagenta;">saturate</font><font style="color:black;">(</font><font style="color:darkmagenta;">dot</font><font style="color:black;">(N,L));</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> VoH = </font><font style="color:darkmagenta;">saturate</font><font style="color:black;">(</font><font style="color:darkmagenta;">dot</font><font style="color:black;">(V,H));</font>

<font style="color:black;"></font><font style="color:blue;">float3</font><font style="color:black;"> Radiance = NoL * LightColor * Shadow * PI;</font>

<font style="color:black;"></font>

<font style="color:black;"></font><font style="color:blue;">float3</font><font style="color:black;"> DiffuseTerm = </font><font style="color:darkmagenta;">Diffuse_Lambert</font><font style="color:black;">(DiffuseColor) * Radiance;</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> D = </font><font style="color:darkmagenta;">D_GGX_UE4</font><font style="color:black;">( a2, NoH );</font>

<font style="color:black;"></font><font style="color:blue;">float</font><font style="color:black;"> Vis = </font><font style="color:darkmagenta;">Vis_SmithJointApprox</font><font style="color:black;">( a2, NoV, NoL );</font>

<font style="color:black;"></font><font style="color:blue;">float3</font><font style="color:black;"> F = </font><font style="color:darkmagenta;">F_Schlick_UE4</font><font style="color:black;">( SpecularColor, VoH );</font>

<font style="color:black;"></font><font style="color:blue;">float3</font><font style="color:black;"> DirectLighting = DiffuseTerm + SpecularTerm;</font>

<font style="color:blue;"></font><font style="color:blue;">return</font><font style="color:black;"> DirectLighting;</font>

<font style="color:black;">}</font>

<font style="color:black;"></font>

<font style="color:black;">修改原函数的DVF项</font>

<font style="color:black;">第一道高光：</font>

<font style="color:#74B602;">float D = D_Charlie_Filament( Roughness, NoH );</font>

<font style="color:#74B602;">float Vis = Vis_Cloth( NoV, NoL );</font>

float3 F = F_Schlick_UE4(<font style="color:#74B602;"> 0.04</font>, VoH );

float3 SpecularLighting = ((D * Vis) * F) * Radiance;

<font style="color:black;">第二道高光：</font>

<font style="color:#74B602;">float D2 = D_Charlie_Filament( SheenRoughness, NoH );</font>

<font style="color:#74B602;">float Vis2 = Vis_Cloth( NoV, NoL );</font>

<font style="color:black;">float3 F2 = </font><font style="color:#74B602;">SheenColor</font><font style="color:black;">;</font>

<font style="color:black;">float3 SheenLighting = ((D2 * Vis2) * F2) * Radiance;</font>

<font style="color:black;"></font>

<font style="color:black;">D项搬运自</font>

[Cloth Shading | Krzysztof Narkowicz (wordpress.com)](https://knarkowicz.wordpress.com/2018/01/04/cloth-shading/)

V项：参考UE

F项搬运自

[Physically Based Rendering in Filament (google.github.io)](https://google.github.io/filament/Filament.html#materialsystem/clothmodel)



第二道高光是绒毛的高光，需要不同的颜色和Roughness

定义一个颜色SheenColor

  float SheenRoughness = saturate(SAMPLE_TEXTURE2D(_RoughnessMap,sampler_RoughnessMap,UV).r * _SheenRoughness);

采样Roughness贴图并*_SheenRoughness得到第二个粗糙度SheenRoughness



<font style="color:black;">由于绒毛没有金属度，第一道高光的F项直接把SpecularColor换成0.04（非金属反射率）</font>

<font style="color:black;">第二道高光的反射改为一个颜色</font>

<font style="color:black;"></font>

<font style="color:black;">多了一道高光，处理一下能量守恒，其他光照需要减弱：</font>

<font style="color:black;">加一个反射率参数SheenDFG（计算过程在下面）</font>

<font style="color:black;">float sheenScaling = 1.0 - max(max(SheenColor.r,SheenColor.g),SheenColor.b) * SheenDFG;</font>

<font style="color:black;">DiffuseLighting *= sheenScaling;</font>

<font style="color:black;">SpecularLighting *= sheenScaling;</font>

<font style="color:black;">衰减值=  1-（SheenColor的最高通道）*反射率</font>

<font style="color:black;">（漫反射/镜面反射）*衰减值</font>

<font style="color:black;"></font>

<font style="color:black;">float3 DirectLighting = DiffuseLighting + SpecularLighting + SheenLighting;</font>

<font style="color:black;">直接光 = 漫反射 + 第一道高光 +第二道高光 </font>

<font style="color:black;"></font>

实现不同视角不同的反射率：

 half2 LUT_UV = half2(saturate(dot(WorldNormal, ViewDir)), _SheenRoughness);

  half SheenDFG = SAMPLE_TEXTURE2D(_ClothDFG_LUT,sampler_ClothDFG_LUT,LUT_UV).r ;

SheenDFG传入BRDF计算

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725006828656-802d2952-abfa-45d9-938f-2420c29421ee.png)

<font style="color:rgb(77, 77, 77);">根据视角dot法线作为u的值，然后以粗糙度作为v的值去采样一张LUT贴图作为当前第二层高光的强度</font>

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725006888291-b61ac607-9975-4e58-81e8-535f464662f4.png)

实现绒毛材质的<font style="color:rgb(77, 77, 77);">边缘的比较发亮，不同观察角度反射率实现</font>

<font style="color:rgb(77, 77, 77);">再找一张短绒毛贴图</font>

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725007670871-736f554d-deab-4ed8-9f41-c238557d2a14.png)![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725007702305-86a756a0-95a9-421b-89f2-ff56fdb357ad.png)![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725007715124-bc8af59d-3f63-403d-8cdf-6846773a0368.png)

  half4 SheenColor = SAMPLE_TEXTURE2D(_SheenMap,sampler_SheenMap,UV* _SheenMap_ST.xy + _SheenMap_ST.zw) * _SheenColor;

<font style="color:rgb(77, 77, 77);">采样短绒毛贴图并*_SheenColor，控制第二道高光的颜色效果。</font>

<font style="color:rgb(77, 77, 77);">调整合适的偏移缩放</font>

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725008039557-594c456f-6dd8-423c-87e4-3d4a958e6d55.png)

第二层高光得到基本毛绒效果

##### <font style="color:rgb(77, 77, 77);">间接光部分：</font>
漫反射部分照搬球谐函数

镜面反射部分也拆成两层

原IBL：

	half3 R = reflect(-V,N);

	R = RotateDirection(R,EnvRotation);

	half3 SpeucularLD = GlossyEnvironmentReflection(R,WorldPos,Roughness,Occlusion);

	half3 SpecularDFG = EnvBRDFApprox(SpecularColor,Roughness,NoV);

	float SpecularOcclusion = GetSpecularOcclusion(NoV,Pow2(Roughness),Occlusion);

	float3 SpecularAO = AOMultiBounce(SpecularColor,SpecularOcclusion);

	float3 IndirectSpecular = SpeucularLD * SpecularDFG * SpecularAO;





修改后：	

	half3 R = reflect(-V,N);

	R = RotateDirection(R,EnvRotation);

第一层镜面反射

	half3 SpeucularLD = GlossyEnvironmentReflection(R,WorldPos,Roughness,1.0f);

	half3 SpecularDFG = ClothDFG * 0.04f;  与直接光同理 

	float SpecularOcclusion = GetSpecularOcclusion(NoV,Pow2(Roughness),Occlusion);

	float3 SpecularAO = AOMultiBounce(float3(0.04,0.04,0.04),SpecularOcclusion);

	float3 IndirectSpecular = SpeucularLD * SpecularDFG * SpecularAO;

第二层镜面反射

	half3 SheenSpeucularLD = GlossyEnvironmentReflection(R,WorldPos,<font style="color:#74B602;">SheenRoughness</font>,1.0f);

        同理Roughness修改为<font style="color:#74B602;">SheenRoughness</font>

	half3 SheenSpecularDFG = SheenColor * SheenDFG;

	float SheenOcclusion = GetSpecularOcclusion(NoV,Pow2(<font style="color:#74B602;">SheenRoughness</font>),Occlusion);

	float3 SheenAO = AOMultiBounce(<font style="color:#74B602;">SheenColor</font>,SheenOcclusion);

        同理SpecularColor修改为<font style="color:#74B602;">SheenColor</font>

	float3 SheenSpecular = SheenSpeucularLD * SheenSpecularDFG * SheenAO;

        能量守恒

	float sheenScaling = 1.0 - max(max(SheenColor.r,SheenColor.g),SheenColor.b) * SheenDFG;

	IndirectDiffuse *= sheenScaling;

	IndirectSpecular *= sheenScaling;



	IndirectLighting = IndirectDiffuse + IndirectSpecular + SheenSpecular;

<font style="color:black;">间接光 = 漫反射 + 第一道高光 +第二道高光 </font>

<font style="color:black;"></font>

<font style="color:black;">挂上贴图</font>

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725009368349-5865812e-6c99-4705-abaa-f608eea9ecd2.png)

基本棉质材质实现

### 毛绒效果实现
##### 前置阅读：
[毛发渲染总结 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/378015611)

[转载 _unity shader毛发实现 - 哔哩哔哩 (bilibili.com)](https://www.bilibili.com/read/cv16246017/)

[unity shader - 毛发渲染，飘逸的毛发_毛发shader-CSDN博客](https://blog.csdn.net/alla_Candy/article/details/121439493?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ECtr-1-121439493-blog-128277149.235%5Ev43%5Epc_blog_bottom_relevance_base5&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ECtr-1-121439493-blog-128277149.235%5Ev43%5Epc_blog_bottom_relevance_base5&utm_relevant_index=2)



如何让材质长毛常见做法：

多Pass

RenderFeature多次渲染

模型分多层

Geometry Shader/Tessellation Shader



本例采用

[Generating Fur in DirectX or OpenGL Easily - Tutorials made easy! (xbdev.net)](https://www.xbdev.net/directx3dx/specialX/Fur/index.php)

模型分多层，每层写入不同顶点色作为<font style="color:rgb(77, 77, 77);">layer</font>，<font style="color:rgb(77, 77, 77);">多层渲染，然后再通过一张noise渐变图，根据layer进行alpha剔除，来模拟出来绒毛向外生长的效果。</font>

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725011472063-ed7d2725-eddf-4f49-baec-3d72155fe6f9.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725011487620-f3055797-2037-447d-a265-d475a828a0d7.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725011719358-57fd6b90-d948-496d-b77e-a032e22d7036.png)

##### <font style="color:rgb(77, 77, 77);">修改模型：</font>
模型导入Max

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012099380-14be240f-d421-4093-ac20-a3497dca9ec3.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012190234-613f9e0a-25a3-4e94-b514-90abb63d9761.png)

选中元素层级

复制20层（或者根据需求调整）

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012622511-e487b387-7ed0-416c-a7ae-98fe5181363f.png)

每层写入顶点色作为权重

本例使用R通道

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012447143-928584ef-bb19-48f7-a89d-7f1b3c9d8e9b.png)

写入方法：

256/20 = 12.8

第1层写入0

第2层写入13

第3层写入26

.。。。。。。

第20层写入255

导出后与原模型对比

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012800432-eeac32df-eacb-4fc2-be10-38faccc52d90.png)![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725012809959-0dff49d9-e63d-4665-bc7e-c23dfd853fdc.png)

顶点数三角面爆增，顶点色写入说明成功

其他带骨骼模型或者层级很复杂模型处理方式待补充。。。

##### <font style="color:rgb(77, 77, 77);">对模型按layer进行剔除：</font>
获取顶点色作层级layer：

 float4 color    : COLOR;

输入结构体加一个float4获取顶点色

 float furLayer  : TEXCOORD5;



 output.furLayer = input.color.r; 

输出结构体也记得加一个槽传递顶点色的R作为layer



在顶点着色器通过layer实现法线外扩：

float3 positionWS =  TransformObjectToWorld(input.positionOS.xyz);

拿到世界顶点

positionWS += normalInput.normalWS * input.color.r * _FurLength * 0.01;

世界顶点 = 世界顶点 +世界法线 *顶点色（层级）*外扩长度调整参数*0.01

output.positionWS = positionWS;

传递给输出结构体

此时可以通过调整_FurLength将不同层级的模型沿法线方向通过权重向外扩张

形成多层结构

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725015595533-44314cb8-e656-4de0-9c54-5e4100554648.png)



采样noise渐变图作为alpha

half furAlpha = saturate(SAMPLE_TEXTURE2D(_FurPatten, sampler_FurPatten, furUV).r * 2 - input.furLayer * input.furLayer * _EdgeFade);

加一个值_EdgeFade控制绒毛强度,layer平方使过度更线性

step一个0.01防止最下面的那层被剔除（小于0.01直接furAlpha为1）

furAlpha = lerp(furAlpha, 1.0, step(input.furLayer, 0.01)); = lerp(furAlpha, 1.0, step(input.furLayer, 0.01));



直接输出furAlpha，已经可以看到多层绒毛效果

黑色部分被剔除

白色部分被保留

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725244398340-1759d4b5-eed3-42aa-995f-3d8cd6f5deb0.png)



  clip(color - (1-BaseAlpha));

对黑色部分进行alpha剔除

初步得到绒毛

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725245129924-1f7d0ab4-4e34-4fe4-b45e-9e8e9e2f89b5.png)

##### <font style="color:rgb(77, 77, 77);">加入重力和风力影响：</font>
###### 重力：
 half2 furUV = UV * _FurFlowMap_ST.xy + _FurFlowMap_ST.zw + <font style="color:#ED740C;">_FurDiection </font>* input.furLayer * input.furLayer

添加Vector4向量_FurDiection修改_FurFlowMap的UV实现修改朝向

X方向为竖直方向（重力）Y方向为水平方向

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725263037335-aa794164-a5d0-4e28-8676-45385e072e53.png)![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725263056922-7aad83c8-3c22-486d-940a-5d3df0b7da19.png)

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725266751274-9bab2f49-955e-488c-b01f-2daab18dbff3.png)![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725266764611-982cc58c-05f7-477e-8ab2-e3a40bc7280d.png)

###### 风力：
  half2 fruFlowUV = UV * _FurFlowMap_ST.xy + _FurFlowMap_ST.zw + _TimeParameters.x * _FurWind * 0.01;

加入Time影响，添加Vector4向量_FurWind控制风力方向

 half2 <font style="color:#74B602;">furFlow</font> = SAMPLE_TEXTURE2D(_FurFlowMap, sampler_FurFlowMap, fruFlowUV).rg;

 furFlow = (furFlow * 2 - 1) * _FurWindIntensity ;

采样一张方向图RG通道控制方向

furFlow*2-1：把通道（0，1）范围转换到到（-1，1）

添加_FurWindIntensity控制风力大小

 half2 furUV = UV * _FurFlowMap_ST.xy + _FurFlowMap_ST.zw + <font style="color:#ED740C;">_FurDiection</font> * input.furLayer *        input.furLayer + <font style="color:#74B602;">furFlow</font>;

把风力影响加入对UV的修改

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725267392403-933368df-6306-4693-a9f8-a995d8f2df1c.png)

实现绒毛扰动    



##### 添加AO影响：
_Occlusion = lerp(_OcclusionStrength, 1.0, input.furLayer);

抛弃AOMap

把AO也添加layer影响

_OcclusionStrength控制AO

实现AO按层级影响

单独输出AO：

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725268509467-f564527b-47c4-4f9c-8592-b1050fd5c9cf.png)

添加SSAO

调整参数

得到最终绒毛效果

![](https://cdn.nlark.com/yuque/0/2024/png/45145007/1725447591274-37876af6-1c5c-47ad-b092-84ad414f4693.png)



##### 参数列表：
 BaseMap 主贴图

 BaseColor 主颜色

 MetallicMap 金属度贴图

 Metallic 金属度

 RoughnessMap 粗糙度贴图

 Roughness 粗糙度  

 NormalMap法线贴图

 Normal法线强度

 SheenMap 棉质材质第二层绒毛贴图

 SheenColor 棉质材质第二层绒毛贴图颜色

 SheenRoughness 棉质材质粗糙度

 ClothDFG_LUT 实现棉质材质反光的LUT贴图

 EnvRotation 环境光角度

 FurLength 绒毛长度

 FurPatten 绒毛alpha裁剪贴图，调整Tilling可根据模型大小调整绒毛密度,Tilling需要与FurFlowMap保持一致

 EdgeFade 绒毛强度

 FurDiection 绒毛方向 X垂直 Y水平 后面两个数没用

 FurFlowMap 风力扰动方向贴图，Tilling需要与FurPatten保持一致

 FurWindIntensity风力强度

 FurWind风力方向 X垂直 Y水平 后面两个数没用

 OcclusionStrength AO强度

##### 常见坑点：
sheenmap，FurPatten ，FurFlowmap等不显示颜色的图千万不能勾sRGB

       















