## 一.简述
综合灵活性和可维护性，决定以层级占用的不同来区分衣服子类型为基础，制定换装美术资源解决方案。这么做有以下好处：

+ 无需维护子类型之间的双向互斥关系，程序根据层级占用判定是否互斥
+ 允许占用某个部位的多层，更加灵活
+ 提供了变体制作的规范，即对某件衣服实现新的sub_type
+ 便于变体进行相似度计算，选出最符合的变体

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719801686856-19e6cbc2-90a1-4951-9c5f-386213538acb.png)



## 二.层级占用
如下，根据衣服到皮肤之间的距离来决定层级，<font style="color:#DF2A3F;">根据层级判定宽松度，允许高层包裹低层</font>。根据是<font style="color:#DF2A3F;">否占用来判断裤腿/衣袖等部位的长度</font>。<font style="color:#DF2A3F;">综合长度和宽松度来判断是否冲突</font>。

| | <font style="color:#000000;">0层区间（紧身）</font> | <font style="color:#000000;">1层区间（正常）</font> | <font style="color:#000000;">2层区间（宽松）</font> |
| --- | :---: | --- | --- |
| <font style="color:#000000;">Elbow_R</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">Elbow_L</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">Arm_L</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">Arm_R</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">Waist</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">Thigh_R</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Thigh_L</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Knee_R</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Knee_L</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Leg_R</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Leg_L</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31-1.5cm</font> | <font style="color:#000000;">距离皮肤1.5以上</font> |
| <font style="color:#000000;">Foot</font> | <font style="color:#000000;">距离皮肤0-0.3cm</font> | <font style="color:#000000;">距离皮肤0.31以上</font> | <font style="color:#000000;"></font> |


![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719805329027-25c20c8d-ff97-492f-9e41-4187b172f3ef.png)

分层占用示意图：

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802242669-dbb99166-1ebf-4df3-b69a-ec8d33c43889.png)



### 如何确认占用了哪些部位
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802264035-d0d8b652-f657-4323-96fd-39ab2de6d3ae.png)



### 如何确认占用了哪层
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802429189-e4affb47-db4a-4d40-97b7-0557bae6c389.png)



### 冲突规则：
两件衣服占用了任一部位的同一层即认为冲突。

如下图，某些冲突在视觉上看上去并没有冲突，这应该是少数情况，如果频繁发生，说明裸模区域的划分需要调整。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802460640-8b8da829-8cda-406f-9772-c0a066693bfc.png)



### 占用多层的使用示例
如黄线，表示一个裤子。

按照此时若只占用0层，就会允许鞋子穿上，造成穿模。如果只占用1层，就会允许袜子穿上，导致穿模。

允许占用多个层，过滤掉这种可能穿帮的情况。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802581600-a59a2c71-45e8-4c48-9ae2-2559698c5373.png)



### 极端特殊情况：
如下图，没有任何一层发生冲突，但不符合现实逻辑

暂时不处理，如果遇到，可以考虑检测最外层是否发生穿插占用。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802626007-71d9ee1d-1f28-463e-89c9-73a46cfeabd2.png)



### 布料模拟不能影响层级
除了飘带，头发等可以使用布料，裤筒，衣袖这种有宽松度概念的不允许使用布料。

裙摆应<font style="background-color:#FBDE28;">限制其摆动范围</font>，尽量不允许它侵入到0，1层的腿部，避免穿模。



## 三.变体
### 概念：
为了解决部分类似“长手套不能搭长袖”的问题，需要为某款原始的“长手套”(sub_type:102)制作一个“短手套”(sub_type:100)的变体。

如下图，当某个手套为了适配不同的衣袖而制作变体时，应选择新加或者选择其他一种sub_type来适配。

不应该有某款具体的手套为了某款具体的上衣做适配而制作变体的情况，如果出现这种情况，考虑用套装的方式来实现。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719802922436-404ce6a0-aac7-49ac-be3a-bce13550c490.png)



### 变体带来的问题
如下图，如果不对适配做规则约束：

1.变体数量上将不受控制，上衣如果适配所所有手套和下衣，最少会有几十种变体，难于管理和维护。

2.很难实现稳定性，简单的例子，一个手套有三种长度变体，一个上衣的衣袖也有三种长度变体，那么不冲突的组合就有六种。

3.制作上和实际穿搭时，要考虑变体对整个网可能的影响，变体不全时，有各种取舍问题需要讨论。例如一个上衣的a变体只能适配手套，b变体只能适配下衣。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719803191225-3194cfe9-9894-404a-b2b8-764804ebb7ce.png)



### 单向变体适配：
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719803208204-481b87f7-7c7c-48f2-a8ff-1a69c67f6687.png)

为了解决上述问题，如上图，综合衣服的现实逻辑及变体的可维护性和灵活性，做出以下单向变体制作约束：

手套-上衣冲突：手套做变体，不允许上衣做变体适配手套

下衣-上衣冲突：上衣做变体，不允许下衣做变体适配上衣

袜子-下衣冲突：袜子做变体，不允许下衣做变体适配袜子

鞋子-下衣冲突：下衣做变体，不允许鞋子做变体适配下衣

袜子-鞋子冲突：设计上避免穿模

将来可能的：

背饰-头发：头发做变体

头盔-头发：头发做变体

兜帽-头发：头发做变体



### 变体相似度
一个长手套，可能有中长，和短两种变体，这两种变体在和中长衣袖进行冲突监测时，都会通过。但依据现实逻辑，应当稳定的选择中长变体。



在此引入相似度概念：指某个衣服的变体，与该衣服原始样式的相似程度。在冲突发生时，优先使用相似度高的变体。在无冲突时，使用相似度100%的变体版本，即原始样式。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719803353698-c9b4fb5f-bc2e-4334-995a-b7c4e2989964.png)

如上图，以102“长手套-紧身”为原始版本：

红框103变体中，占用的部位没有改变，只是层级发生了变化。扣5%的相似度，相似度为95%。

黄框101变体中，占用的部位发生了减少，扣10%相似度，相似度为90%。

102会在配置中标记为原始版本，相似度为100%。

于是总是优先使用102，其次103，最后考虑101。



### 变体相似度升级
手套针对上衣做变体，当上衣脱下变为默认上衣时，手套将不应该再使用变体，而是使用原始版本。

定义此种状况为变体相似度升级。



### 变体组合选取逻辑简述
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719803208204-481b87f7-7c7c-48f2-a8ff-1a69c67f6687.png)

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719803847937-05c5ac94-2cf9-4384-b89e-cfdc6e61347b.png)

用户主动更换本层：

1.选取一种和上层无冲突的变体：

无法找到：通知上层，要求上层<font style="color:#DF2A3F;">脱下</font>。确定本层使用原始版本。

找到多个：选取相似度最高的变体进行使用。

找到1个：使用。

经过此步，已经确定了本层使用哪个变体

2.通知下层，要求下层<font style="color:#DF2A3F;">适配上层</font>



<font style="color:#DF2A3F;">脱下</font>：如上衣下衣鞋子头发等必需的改为使用默认的，手套项链之类的非必需的，直接去掉。不通知上层，通知其他子节点尝试<font style="color:#DF2A3F;">升级变体相似度</font>。

<font style="color:#DF2A3F;">适配上层</font>：优先选取变体适配，如变体更换成功，将不通知下层。如无，本层脱下。

<font style="color:#DF2A3F;">升级变体相似度</font>：尝试升级，不论成不成功，均不通知上下层。



## 四.套装
### 散件组合套装
+ 默认脱下所有部位，再进行组合套装更换，如需保留头发等，在对应套装里配置白名单
+ 不进行组合内部的冲突检查
+ 不必填写套装的占用部位，由组合内的散件决定
+ 允许对套装内的每一个部位进行脱下或者更换。



### 真套装
+ 只能整体进行脱下或着穿上
+ 不必填写占用部位
+ 顶掉所有位置，也会被任何位置顶掉。不支持真套装与其它任何散件共存



## 五.资源相关
### 挂点饰品
+ 预制体上的每一个节点上应都带上该饰品部位的简称，如使用Cap_Model->Cap_Root->Cap_xxx这样的骨骼命名结构，不可重复。
+ 预制体的命名应能体现：角色类型（男/女），部位，sub_type(后两位)，编号。如：F_Cap_01_001
+ 特殊情况下允许骨骼节点上有布料碰撞框，如背饰。其他衣服部位要添加碰撞框时，需程序配合实现，自行添加无效。

### 非挂点服装
如鞋子，上衣等

+ 输出所有的人体和捏人骨骼，命名保持和裸模骨骼一致。衣服独有骨骼放在正确的层级，不允许与人体或者捏人骨骼进行层级穿插，命名需带上部位名，不可重复。
+ 预制体上所有的布料放在固定的父节点下，如：预制体根节点->ClothRoot下
+ 预制体的命名应能体现：角色类型（男/女），部位，sub_type(后两位)，编号。如：F_Upper_01_001
+ 不允许有布料碰撞框组件。

### 布料
+ 只允许使用骨布，不允许使用代理网格的方式模拟，同时不允许开启自碰撞或相互碰撞，避免性能问题。
+ 部位的布料组件只允许控制衣服独有的骨骼，不允许控制人体骨骼。
+ 部位的布料组件上应挂载脚本，用于选取需要填充哪些部位的碰撞框。

### 袜子
+ 在单个模型中，需要有三个脚型的skinmesh，位置保持一致，程序运行时控制显隐，脚踝上部的袜子拆出mesh

### 鞋子
+ 鞋子有和脚对应的三种跟高配置。对于某个跟高配置，不止指鞋所容纳的脚形状一致，还指foot骨骼到蒙皮上鞋底的y轴高度固定，以便做盆骨骨骼高度调整。



## 六.配置表结构
### 衣服表
具体的衣服配置，每新加一件衣服，或者变体时，需要更新此表

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1720007323296-5b1d591c-fc63-4e09-8706-a5bea095ab3c.png)

### 绑点表
用于挂点饰品指定挂载位置

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719804895036-b870de54-3da4-451a-9f75-7f9b8cf44bc2.png)

### 衣服类型表
规定了主类型和子类型，以及层级占用。在新加子类型或主类型时，需要更新此表

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719976842644-6ed5019b-a51a-4ee7-a172-9590169d4cdf.png)

### 部位命名
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1720065314816-6990800f-25f3-41ef-b427-f613c580610c.png)

