## 1.裸模拆分
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719390404158-833f803f-94b4-4776-8586-e3d451b8fd37.png)

## 2.衣服种类
上衣：袖子长短*3  宽松度*2  腰部长度*2  宽松度*2

下衣： 裤腿长度*3  宽松度*2  腰部长度*2  宽松度*2

鞋子：高跟*3  鞋帮高度*3 宽松度*2

袜子： 袜子长度*4  宽松度*2

手套： 长度*3    宽松度*2   

连衣裙：做成1个预制体，配置上衣参数+下衣参数。不考虑腰部冲突



挂点饰品，不参与冲突检测：

帽子

发饰    单个饰品/多个发饰的集合？

腕饰   不考虑与衣袖/手套的穿模问题，从袖口设计上避免。

背饰  可能会与头发有穿模问题

手持   提供动画层级权重

项链   不考虑与上衣领口的穿模问题，无法避免穿模

戒指  不考虑与手套的穿模问题，无法避免穿模

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391409308-e97a9f3d-5094-469f-857c-2e46ebfde17b.png)



## 3.部位冲突检测
3.1头部冲突

3.1.1发型-帽子

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391422827-187e410c-2b77-40a5-b379-8f9268420776.png)

3.1.2发型-发饰

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391451922-5b3001e3-e493-4081-9aff-626461e42fcf.png)

3.1.3帽子-发饰

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391464098-10b0ce97-bc8a-47c5-b05e-525b2c306c58.png)

3.1.4发型-连帽衫

3.1.5发型-背饰

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391491464-6bdade80-8db3-47c8-9039-97998b7807ec.png)

3.1.6头部结论

每款发型实现一组挂点，根据发型本身的形状，调整帽子挂点和发饰挂点的位置

发型上会和大部分帽子穿模的部分，拆单独mesh，按区域归类，帽子按区域隐藏这部分头发

发饰与帽子的穿模从挂点分布来避免

发型背部注意预留背饰的空间



3.2衣服冲突

3.2.1叠穿

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391625084-d0f466d8-f69a-44c2-8c93-de442ddeea39.png)

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391630915-be2f4c02-b07d-4fd9-a783-6191df2313cd.png)

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391635761-f1ede2c7-8a4d-4702-bb43-9df2f10934d3.png)

3.2.2细分类检测冲突的方案：

| | <font style="color:#000000;">短衣袖</font> | <font style="color:#000000;">中衣袖</font> | <font style="color:#000000;">长衣袖</font> |
| --- | :---: | :---: | :---: |
| <font style="color:#000000;">短手套</font> | <font style="color:#000000;">无冲突</font> | <font style="color:#000000;">无冲突</font> | <font style="color:#000000;">无冲突</font> |
| <font style="color:#000000;">中手套</font> | <font style="color:#000000;">无冲突</font> | <font style="color:#ff0000;">冲突</font> | <font style="color:#ff0000;">冲突</font> |
| <font style="color:#000000;">长手套</font> | <font style="color:#000000;">无冲突</font> | <font style="color:#ff0000;">冲突</font> | <font style="color:#ff0000;">冲突</font> |


| | <font style="color:#000000;">贴身短袖</font> | <font style="color:#000000;">非贴身短袖</font> | <font style="color:#000000;">贴身中袖</font> | <font style="color:#000000;">非贴身中袖</font> | <font style="color:#000000;">非贴身长袖</font> |
| --- | :---: | :---: | :---: | :---: | :---: |
| <font style="color:#000000;">贴身短手套</font> | | | | | |
| <font style="color:#000000;">贴身中手套</font> | | | | | |
| <font style="color:#000000;">贴身长手套</font> | | | | | <font style="color:#000000;">无冲突</font> |
| <font style="color:#000000;">蓬松长手套</font> | | | | | <font style="color:#000000;">冲突</font> |


冲突配置表：

| <font style="color:#000000;">短手套</font> | | | | | | |
| --- | --- | --- | --- | --- | --- | --- |
| <font style="color:#000000;">中长手套</font> | <font style="color:#ff0000;">长袖</font> | <font style="color:#ff0000;">中长衣（长袖）</font> | <font style="color:#ff0000;">长袖+短裤（裙）</font> | <font style="color:#ff0000;">长袖+中长裤</font> | <font style="color:#ff0000;">长袖+中长裙</font> | |
| <font style="color:#000000;">长手套</font> | <font style="color:#ff0000;">长袖</font> | <font style="color:#ff0000;">中长衣（长袖）</font> | <font style="color:#ff0000;">中长袖</font> | <font style="color:#ff0000;">长袖+短裤（裙）</font> | <font style="color:#ff0000;">长袖+中长裤</font> | <font style="color:#ff0000;">长袖+中长裙</font> |
| <font style="color:#000000;">.....</font> | | | | | | |




优点：简单易用直观，两个衣服是否冲突，可以直接根据类型看出来。

缺点：不考虑宽松度，自由度偏低。当出了一种衣服后，需要定义它属于哪种。(如果没有，需要新加，同时理一遍其它衣服的冲突列表)

eg.阔袖长袖与紧身中手套，理论上可以同时显示，在此处会被检测为冲突。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391747542-db669693-64a1-490f-8c8b-559330d83213.png)

3.3分层占用

可以对自己独有的部分进行隐藏，然后提供挖孔版的皮肤。

共享的，可能发生冲突的部位，允许控制隐藏，占用0层的允许提供挖孔皮肤。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719391777125-8ab5c0c8-3e0d-47a4-a245-976161d3457a.png)

可控裸模部位：

| <font style="color:#000000;">手套：</font> | <font style="color:#000000;">Hand_L/R</font> | <font style="color:#ff0000;">Elbow_L/R</font> | <font style="color:#ff0000;">Arm_L/R</font> | | |
| --- | --- | --- | --- | --- | --- |
| <font style="color:#000000;">上衣：</font> | <font style="color:#000000;">Body</font> | <font style="color:#ff0000;">Elbow_L/R</font> | <font style="color:#ff0000;">Arm_L/R</font> | <font style="color:#ff0000;">Waist</font> | |
| <font style="color:#000000;">下衣:</font> | <font style="color:#000000;">Hip</font> | <font style="color:#ff0000;">Thigh_L/R</font> | <font style="color:#ff0000;">Knee_L/R</font> | <font style="color:#ff0000;">Waist</font> | <font style="color:#ff0000;">Leg_L/R</font> |
| <font style="color:#000000;">袜子：</font> | <font style="color:#ff0000;">Foot_L/R</font> | <font style="color:#ff0000;">Thigh_L/R</font> | <font style="color:#ff0000;">Knee_L/R</font> | | <font style="color:#ff0000;">Leg_L/R</font> |
| <font style="color:#000000;">鞋子：</font> | <font style="color:#ff0000;">Foot_L/R</font> | | <font style="color:#ff0000;">Knee_L/R</font> | | <font style="color:#ff0000;">Leg_L/R</font> |




3.3.1上衣袖子-手套 

占用：在衣服的可控裸模部位中，衣服的mesh和该裸模部位有重合就算。              

0层：紧贴皮肤层，不可与该部位皮肤同时显示           0cm？    

1层：皮肤近距离层，例如可以从袖口处看到小臂皮肤            0.1cm-5cm？  

 裙摆比较特殊，应该算作2层。2层只有裙摆，不必检测冲突，故不存在2层概念。蓬松裙应不占用腿部0层和1层

可同时占用0层和1层：用于多褶皱袖口及锥形形状

| <font style="color:#000000;">上衣：</font> | | <font style="color:#000000;">0层占用状态</font> | <font style="color:#000000;">1层占用状态</font> | <font style="color:#000000;">是否隐藏该部位裸模</font> |
| --- | --- | --- | --- | --- |
| | <font style="color:#000000;">Body</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">true</font> |
| | <font style="color:#000000;">Elbow_L/R</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">占用0层的才可以设置为true</font> |
| | <font style="color:#000000;">Arm_L/R</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">占用0层的才可以设置为true</font> |
| | | | | |
| <font style="color:#000000;">手套：</font> | | <font style="color:#000000;">0层占用状态</font> | <font style="color:#000000;">1层占用状态</font> | <font style="color:#000000;">是否隐藏该部位裸模</font> |
| | <font style="color:#000000;">Hand</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">true</font> |
| | <font style="color:#000000;">Elbow_L/R</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">true</font> |
| | <font style="color:#000000;">Arm_L/R</font> | <font style="color:#000000;">true</font> | <font style="color:#000000;">false</font> | <font style="color:#000000;">true</font> |


当手套和衣袖的0层或者1层发生占用状态重合时，认为冲突发生

隐藏裸模部位取并集

<font style="color:#000000;">占用0层的才可以设置为true：</font>

<font style="color:#000000;">eg.如果袖子不占用中臂0层，但隐藏了中臂裸模。此时如果手套提供了中臂皮肤，将隐藏失败，不符合预期。即如果需要隐藏该部位裸模，必须占用0层。</font>

<font style="color:#000000;"></font>

<font style="color:#000000;">优点：考虑层级，能识别部分“假冲突”情况，允许1层包住0层。即允许紧身衣袖塞进宽松手套，允许紧身手套塞进宽松衣袖。</font>

<font style="color:#000000;">缺点：新出一个模型时，需根据层级和占用概念，正确设置每个裸模部位层级占用状态。不能直观的看出两件衣服是否冲突</font>

<font style="color:#000000;"></font>

<font style="color:#000000;">3.3.2手套，袜子的附加点缀物</font>

<font style="color:#000000;">1.占用1层</font>

<font style="color:#000000;">2.起一个弱1层概念，即可隐藏的1层。需要单拆mesh。不考虑1层是否完全被袖子覆盖，只要1层有冲突，就隐藏所有的装饰物</font>

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392201500-30bb75aa-2743-4137-9183-376e36ad5d6a.png)



3.3.2衣长-高腰/低腰

3.3.3脚-袜子-鞋子

袜子替换裸模脚/腿

鞋子包裹裸模脚/腿

目前的高跟鞋方案：为了方便动画复用，使用同一套骨骼，鞋子自带脚的蒙皮。新设定：使用捏人系统抬高跨骨位置，来让模型脚底贴地，不改变模型本身的root坐标高度。



为了实现袜子：

1.根据跟高选出三种鞋子，对应三个脚的裸模

2.鞋子不再允许带脚的模型，根据鞋子的跟高，选取一种裸模的脚显示

3.鞋子不允许隐藏脚或者腿，即鞋子不允许贴脚贴腿，不允许占用0层

4.每种袜子从脚踝处分割，实现三种脚的模型

5.如果有长筒贴腿的靴子，不允许穿任何袜子

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392344194-beaf636e-e05c-415f-b3fe-7488e6268731.png)



裤子在0层上与袜子检测冲突

在1层上与鞋子检测冲突

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392360343-decba2e6-7f35-46d1-a5e7-ef8dd7e6d970.png)



半透或者提供皮肤的衣服制作时，需考虑到后续要支持肤色变化，纹身的需求



3.3.4套装

真套装：不可拆卸某个部位，必须同时存在或同时不存在。

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392390627-29cdcc9a-5927-42b9-816a-1e32322142bc.png)

组合套装：由多个散件组合。传入部位数组，同时清空所有已穿戴部位。

3.3.5是否处理冲突

1.每件衣服出多个预制体，资源数量增加

![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392417598-29337010-b2ca-46b4-b859-fc0c481484cb.png)

2.直接将冲突部位顶替为默认模型

## 4.资源处理
![](https://cdn.nlark.com/yuque/0/2024/png/43256925/1719392441576-440d2a48-27e1-42b6-b9ff-0d823dd12299.png)

非挂件衣服：                  

Fbx转Prefab：与裸模骨骼做对比，剔除所有重复的骨骼。序列化蒙皮骨骼名字数组，序列化每条裙摆跟骨骼父节点到部位预制体上。                 

布料系统：

    保留含有布料组件的节点                    

    碰撞框放在角色主体骨架上，运行时为衣服布料组件设置碰撞框列表。             

    碰撞框进行分组，如上半身，左右手，左右腿。布料组件上序指定所需分组集合。如果不指定，默认不进行设置。



## 5.配置
走excel配置。部件上预制体上只序列化骨骼等信息

| <font style="color:#000000;">分层方案配置：</font> | | | | | |
| --- | --- | --- | --- | --- | --- |
| <font style="color:#000000;">id</font> | <font style="color:#000000;">type</font> | <font style="color:#000000;">prefab_name</font> | <font style="color:#000000;">0层占用部位（array）</font> | <font style="color:#000000;">1层占用部位（array）</font> | <font style="color:#000000;">隐藏部位（array）</font> |
| | <font style="color:#000000;">上衣</font> | | | | |
| | <font style="color:#000000;">上衣</font> | | | | |
| | <font style="color:#000000;">连衣裙</font> | | | | |
| | <font style="color:#000000;">鞋子</font> | | | | |
| | <font style="color:#000000;">袜子</font> | | | | |
| | <font style="color:#000000;">手套</font> | | | | |
| | <font style="color:#000000;">发型</font> | | | | |
| | <font style="color:#000000;">发饰</font> | | | | |
| | <font style="color:#000000;">帽子</font> | | | | |
| | <font style="color:#000000;">手持</font> | | | | |
| | <font style="color:#000000;">腕饰</font> | | | | |
| | <font style="color:#000000;">背饰</font> | | | | |
| | <font style="color:#000000;">项链</font> | | | | |
| | <font style="color:#000000;">戒指</font> | | | | |
| | <font style="color:#000000;">…</font> | | | | |
| | <font style="color:#000000;">每种类型只能穿戴一个。提供一个默认的上衣与下衣和鞋子</font> | | | | |


| <font style="color:#000000;">细分类方案配置</font> | | | | |
| --- | --- | --- | --- | --- |
| <font style="color:#000000;">id</font> | <font style="color:#000000;">type</font> | <font style="color:#000000;">sub_type</font> | <font style="color:#000000;">prefab_name</font> | <font style="color:#000000;">隐藏部位（array）</font> |
| | <font style="color:#000000;">上衣</font> | <font style="color:#000000;">短袖</font> | | |
| | <font style="color:#000000;">上衣</font> | <font style="color:#000000;">中长袖</font> | | |
| | <font style="color:#000000;">上衣</font> | <font style="color:#000000;">长袖</font> | | |
| | <font style="color:#000000;">上衣</font> | <font style="color:#000000;">中长衣（长袖）</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">短裤</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">中长裤</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">长裤</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">过膝长裙（宽松）</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">过膝长裙（紧身）</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">蓬蓬裙（宽松）</font> | | |
| | <font style="color:#000000;">下衣</font> | <font style="color:#000000;">长裤（收脚、小脚）</font> | | |
| | <font style="color:#000000;">鞋子</font> | <font style="color:#000000;">低帮鞋</font> | | |
| | <font style="color:#000000;">鞋子</font> | <font style="color:#000000;">高帮鞋</font> | | |
| | <font style="color:#000000;">鞋子</font> | <font style="color:#000000;">中长靴</font> | | |
| | <font style="color:#000000;">鞋子</font> | <font style="color:#000000;">长靴</font> | | |
| | <font style="color:#000000;">鞋子</font> | <font style="color:#000000;">绑带类贴腿鞋（中长以下）</font> | | |
| | | <font style="color:#000000;">…</font> | | |
| | <font style="color:#000000;">拆分大类型和小类型，每种大类型只能穿1个</font> | | | |




## 6.问题总结
6.1.发型改变时，如果不调整帽子和发饰的挂点，可能会穿模。考虑到帽子-发型，帽子-发饰，发型-发饰这三种的可能的穿模

6.2.背饰/兜帽衫与长发的穿模问题

6.3.考虑不同上衣/连衣裙的袖长与手套的冲突关系。冲突点在于：长度/宽松度，手套外部装饰。

6.4.上衣和下衣的腰部冲突，长度/宽松度 

6.5.现行高跟鞋方案下，袜子如何制作？任意长度的袜子和任意鞋帮高的鞋子如何解决穿模问题。袜子上可能会有凸起的点缀，高筒靴是否贴腿，贴腿的话，袜子和裤子怎么办

6.6.下装与鞋子/袜子的腿部的冲突检测，长度/宽松度，袜子装饰物等。

6.7.同部位叠穿，上衣和外套

6.8.手饰项链等挂点饰品与该部位衣服的冲突。不允许穿戴？直接穿模？其他方案？

6.9.发生冲突时，如何解决？多个模型变体？直接顶替？

6.10.将来可能会有纹身，改变肤色的需求，需要兼容

