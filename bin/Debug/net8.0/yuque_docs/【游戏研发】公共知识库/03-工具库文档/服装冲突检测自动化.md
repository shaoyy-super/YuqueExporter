# 一.服装冲突
如下表，穿搭在一起发生穿帮（mesh穿插）的情况，认为冲突。

对于发生冲突的服装，将限制用户将其组合在一起穿搭。

| 连衣裙(Dress) | 手套(Glove) | 穿搭发生穿帮 |
| --- | --- | --- |
| ![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740711781905-7c4fa674-b4dc-45d9-b623-2d311a8c8b82.png) | ![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740711820250-526237bc-d322-4713-a53e-49ed8879eacf.png) | ![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740711840742-2524a85a-4c9f-4868-9d5c-fcf2b39682cd.png) |






如下表，绿色标记了对应的行和列需要进行冲突检测

| | 鞋子 | 手套 | 连衣裙 | 下衣 | 上衣 |
| --- | :---: | :---: | :---: | :---: | :---: |
| 上衣 |  |  |  |  |  |
| 下衣 |  |  |  | <font style="background-color:#74B602;"></font> | <font style="background-color:#74B602;"></font> |
| 连衣裙 |  |  |  |  |  |
| 手套 |  |  | <font style="color:#DF2A3F;"></font> |  |  |
| 鞋子 |  |  |  |  |  |




# 二.检测流程
整个检测工具设计上应满足下面四个需求：

+ 便捷性
+ 按需计算，降低计算量。计算过的，Mesh没变化就不再计算了
+ 冲突检测结果可视化
+ 允许美术对自动检测结果进行修正



## 窗口功能
实现一个unity窗口，通过文件夹扫描，拿到各部位的所有预制体。用TreeView按"部位->预制体列表"的结构显示，需添加搜索栏。

考虑到搜索还是有点麻烦，可以扩展右键预制体的菜单，点击一个按钮后，打开此窗口，选中该预制体，直接进行刷新检测。

该分区最好可以反应一个预制体的Mesh有没有发生变化，并且按这个排序。类似红点的功能。主要是让美术知道，哪些需要重新计算。

类似下图（可以继承UT.RS.EditorTreeWindow.TreeWindow实现）

![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740714190953-3d4955c0-fd66-4c44-b3ba-a43cb48ee609.png)



## 检测过程
可以考虑jobSystem或者其它多线程方式

支持中断检测，中断时应放弃本次的已检测结果

支持进度显示，可以直接调用编辑器的进度显示UI



## 检测结果展示
如下图，左侧分区选中一个预制体后，中间分区显示另一个TreeView，显示可能发生冲突的部位及预制体列表。如选择了上衣预制体，右侧TreeView应显示下衣和手套，及对应部位的所有预制体。（支持搜索）



中间分区TreeView预制体列表中的每个预制体的名字都设置颜色并代表不同含义：

红色：冲突

绿色：不冲突

白色：还没有经过检测，不确定

同时给手动标记了的加上"_C"后缀

该分区应按照颜色和后缀进行排序。



选中中间分区的预制体后，显示右侧的一个分区，该分区显示一个手动标记按钮，和多角度的截图。（如果拖慢执行速度，可以选择点击一个按钮，点了之后再生成截图）

![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740719282750-c917003e-d82c-4666-b921-f7b2179f9001.png)

该机制主要是考虑到，检测出来mesh穿插，但美术觉得可以接受。或者没有检测出冲突，但美术不想让它们一起穿（可能并不会发生这种情况）

这个标记有三种选项：使用自动检测结果，强制认为冲突，强制认为没冲突



# 三.注意点
## 冲突区
由于服装的整个模型面数可能达到7000以上，考虑只检查冲突区内的三角面穿插情况。（可以用bounds判断点在不在冲突区域内。）



![手套和上衣/连衣裙的冲突区](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740720599124-2f9aab13-4672-45dc-b35a-5b0379a56837.png)



![上衣下衣冲突区](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740720673733-4c3364ce-59f4-410e-b783-7e3696f6d275.png)



![下衣/连衣裙与鞋子的冲突区](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740720713845-1d520d41-476c-4d9b-8997-7011aac46e13.png)



## 封口
美术为了避免内部皮肤穿模，会挖空衣服盖着的皮肤，为了防止特定视角可以看到挖孔，美术会在内部拉一块mesh进行封口，这块mesh应和衣服本体拆开，并使用特殊命名规则标识出来。

![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740722874438-4aff476e-fbbe-460c-bed8-f04325900b5b.png)



## 动作
（二期开发

考虑TPose下不穿模，可能其它动作下会，应使用多个动作姿势进行检测

# 四.配置存储
手动标记存在一张不进运行时的表里。



综合自动检测结果，和手动标记结果，用bit矩阵存储冲突关系，转成多个int，存进excel。

逻辑上类似这样，该有五个类似这样的冲突表：

![](https://cdn.nlark.com/yuque/0/2025/png/43256925/1740722390184-9ec5bb93-9f78-4f2a-a9e5-143e0d5a4ac1.png)



预制体idx分配表和冲突表分表存储，并保持idx分配稳定。

在进行全量冲突关系更新的时候，可以更改idx分配。



# 五.相关插件
CGALDotNetUnity  

UnityNativeCollision

Non-Convex Mesh Collider Automatic Generator

