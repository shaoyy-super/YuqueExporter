# 公会对象 的获取
### 客户端获取：
local guild = me:GetMyGuild();

### 服务器获取：
服务器公会对象只存在于session服务器

local guild = KGuild.GetGuildById(guild_id);

### 数据接口
数值组变量：

-- 增加数值变量-- param var_key 数值组键guild:GetVar(var_key);-- 增加数值变量-- param var_key 数值组键-- param value 数值guild:SetVar(var_key, value);

数值变量：

-- 获取数值变量-- param value_key 数值键guild:GetValue(value_key);-- 增加数值变量-- param value_key 数值键-- param add_value 数值增加值guild:AddValue(value_key, add_value);-- 减少数值变量-- param value_key 数值键-- param sub_value 数值减少值guild:SubValue(value_key, sub_value);

结构型数据：

公会结构数据类似玩家结构性数据，使用MiscVar接口，使用 proto 定义结构具体内容

定义在 GuildMiscVarDef.lua 内。具体结构序列化反序列化在 Guild/MiscVars/ 目录下。

--

-- brief 获取混杂变量

-- param guild_id 公会ID

-- param key 键

--

function GuildMiscVar.GetMiscVar(guild_id, key)--

-- brief 设置混杂变量

-- param guild_id 公会ID

-- param key 键

-- param value 值

--

function GuildMiscVar.SetMiscVar(guild_id, key, value)

# 公会脚本的调用
### 调用所有在线公会脚本
---- brief 调用所有在线公会的脚本-- params-- return--function Guild:CallAllOnlineGuildScript(global_table, function_name, ...)举例： -- 通知在线公会变更公会时间线

Guild:CallAllOnlineGuildScript("GuildStageHelper", "DoStageCallBack", time_line_id)

### 调用单个公会脚本。
回调会返回公会对象作为第一个参数

---- brief 加载公会数据-- param id 公会ID-- param ... 回调函数-- return 加载标识--function GuildLoader:Load(guild_id, ...)举例：-- 公会加道具接口

function Guild:AddItemByGuildId(player_id, guild_id, item_config_id, count, source)

    GuildLoader:Load(guild_id, function(guild)

        local attr_type = self.kGuildItemValuePair[item_config_id];

        if attr_type == self.GUILD_VALUE_EXP then

            self:AddExp(guild, count, source);

        elseif attr_type == self.GUILD_VALUE_FUND then

            self:AddFund(guild, count, source);

        elseif attr_type == self.GUILD_VALUE_MEMBER_WEEK_CONTRIBUTE then

            self:AddMemberContribution(player_id, guild, count, source)

        else

            guild:AddValue(attr_type, count, source);

        end

    end)

end

### 协议调用公会脚本：
---- brief 调用公会脚本--@param guild_id 公会id--@param param 参数function Rpc:CallGuildScript(guild_id, param)

通过上述接口调用的脚本，会自动加载公会并且作为第一个参数

举例：--发起公会数值扣除Rpc:CallGuildScript(player.GuildId, { "Guild", "SubGuildValue", type, value });--实际调用脚本--

-- brief 减少公会数值

-- param guild_id 公会ID

-- param type 数值类型

-- param value 数值量

--

function Guild:SubGuildValue(guild, type, value)

    guild:SubValue(type, value);

end

### 调用所有成员脚本
---- brief 所有成员客户端脚本调用-- param param 参数-- param filter 过滤函数--function Guild:CallAllMemberClientScript(guild, param, filter)---- brief 所有成员场景服脚本调用-- param param 参数-- param filter 过滤函数--function Guild:CallAllMemberSceneScript(guild, param, filter)

### 获取公会基础数据：
不需加载公会即能访问，scene也能访问

--

-- brief 获得公会基础数据

-- param guild_id 公会ID-- param ... 基础数据列表   ["id", "level", "name", "declaration", "joinlimit", "needapprove",   "flag", "membercount", "leader_id"]

-- return ...

--

function Guild:GetGuildBaseData(guild_id, ...)

### 调用所有公会脚本：（存在于公会没有动态加载的项目中）
KGuild.DispatchAllGuildExecuteFunction(...)举例：-- 通知所有公会清除BOSS积分

KGuild.DispatchAllGuildExecuteFunction("GuildBoss", "OnResetGuildBossRank")

# 公会提供的事件
### 创建
EventManager.OnGlobalEvent("OnInitGuild", guild);

### 登录
EventManager.OnGlobalEvent("OnGuildLogin", guild);

### 跨天
EventManager.OnGlobalEvent("OnGuildDailyRefresh", guild)

### 数值类型数据变化
-- 触发数值变化EventManager.OnGlobalEvent("OnGuildValueChange", guild, key, value);

### 公会成员增减
EventManager.OnGlobalEvent('OnGuildRemoveMember', guild, member_id);EventManager.OnGlobalEvent('OnGuildAddMember', guild, member_data);

# 业务开发：
公会许愿池：

+ 数据层：

定义数据结构： miscvar.guild.wish.proto

// [START declaration]syntax = "proto2";package GuildMiscVar;// [END declaration]// [START messages]// 公会许愿池message GuildWishs{    // 捐助次数    message DonateRecord    {        optional int32 donator_id       = 1;        //捐助者id        optional int32 donate_times     = 2;        //捐助次数    }    // 许愿    message Wish    {        optional int32  belong_id               = 1;         //归属者id        optional int32  fragment_id             = 2;         //碎片id        optional int32  donate_number           = 3;         //捐助进度        optional int32  create_time             = 4;         //生成时间        optional int32  wish_multiple           = 5;         //许愿加倍        repeated DonateRecord  donator_list     = 6;         //捐献人集合        optional int32  wish_state              = 7;         //节点状态    }    repeated Wish wishes                 = 1;    //许愿}// [END messages]

在GuildMisvVarDef.lua 导入pb 名 "miscvar.guild.wish.pb"，

全局定义key : **GuildMiscVar.GUILD_MISCVAR_WISH = 10005; -- 公会许愿**

-- 混杂变量格式文件列表GuildMiscVar.kFormatFileList = {    "miscvar.guild.member.pb",    "miscvar.guild.applylist.pb",    "miscvar.guild.log.pb",    "miscvar.guild.guildland.pb",    "miscvar.guild.wish.pb",    "miscvar.guild.leave_record.pb",    "miscvar.guild.guild_collection.pb",    "miscvar.guild.rank.pb",    "miscvar.guild.guild_pvp.pb",    "miscvar.guildchat_preserve.pb",    "miscvar.guildchallenge.guild.pb"};GuildMiscVar.GLOBAL_MISCVAR_SCRIPT_BEGIN   = 10000;   -- 脚本定义开始GuildMiscVar.GUILD_MISCVAR_MEMBERS         = 10001;   -- 成员列表GuildMiscVar.GUILD_MISCVAR_APPLY_LIST      = 10002;   -- 申请GuildMiscVar.GUILD_MISCVAR_LOGS            = 10003;   -- 日志GuildMiscVar.GUILD_MISCVAR_LAND            = 10004;   -- 公会领地GuildMiscVar.GUILD_MISCVAR_WISH            = 10005;   -- 公会许愿

+ 逻辑层：

开启许愿功能：

注册数值变化事件：

EventManager.RegisterGlobalEvent("OnGuildValueChange", OnGuildValueChange);

关注公会等级变化：

-- 公会等级 变更local function OnGuildValueChange(guild, key, value)    -- 是否经验 或者等级    if key ~= Guild.GUILD_VALUE_LEVEL then        return;    end    -- 打开公会许愿池    if value >= GlobalSetting.GetGuildWishOpenLvl() then        GuildWish:OpenWishFunction(guild.Id);    endend

玩家许愿:



在Scene服需要扣除物品，然后再Session构建许愿数据。如果许愿数据构建失败，返还Scene玩家资源。

跨天删除：

关注跨天：

EventManager.RegisterGlobalEvent("OnGuildDailyRefresh", OnGuildDailyRefresh);local function OnGuildDailyRefresh(guild)

    -- 清空许愿池，并已完成的发奖    GuildWish:ClearAllWishAndSendReward(guild.Id);

end

