Coder：@周亦单

Reveiwer：[@柴猛](undefined/chaimeng-olowk)



# 1、问题记录


 Page_DancePlay_Ctrl  

- [x] PreloadCo无效协程使用
- [x] PreloadCo里， 保存协程对象的变量不应该作为对象的“字段”  
- [x] Release从OnClose里单独拆一个函数，没什么意义  
- [x] OnKeyboardHit 等键盘事件键盘事件传递层数太多了  
- [x] danceMapUrl 命名规范

 DanceModeBase  

- [x]  GetDanceActor、GetDanceCamera、GetScore  等方法没用
- [x] 改完1后， is_preloaded相关的部分都没用了
- [x] 取Registry不应该用基类的名字  
- [x] OnBaseUpdate里的判空没必要  
- [x] OnKeyboardLeft等键盘处理函数，不适合放在基类，不通用
- [x] LoadActor() 角色的初始的位置信息，应该在加载的时候就提供出来  

 KeyPressDanceMode  

- [x] DoPreloadCo无效协程使用
- [x] LoadCamera同步方法包协程
- [x] DoPreload 里协程本身用法不对
- [x] Dance接口定义与基类不一致
- [x] 配置表名要定义到CfgEnum里
- [x] Ready() 里PlayerPrefsX落地纯浪费性能【策划需求，但是有更好的实现方式，不要侵入正常代码】
- [x] 多处命名不规范
- [x] DanceCo()  跟前面相似的协程问题
- [x] Dance里 run_co  没必要存在
- [x] PlayStageEnterAnim、PlayRoleInAnim两个0.1s等待很奇怪，而且分两个stage枚举也鸡肋【应该用TML做表演】
- [x] StartPlay()里对ui ctrl的调用太多，重新思考各模块的定位&职责  
- [x] End()里返回应该走GoBack
- [x] ShowResult()的状态，如果被玩家主动关闭打断，会导致外层协程无法中止
- [x] AddJudgeResult()里多个max_perfect_combo更新无意义
- [x] AddScore()不应该用if分支取配置数据
- [x] OnBtnHit()里 更新key_map应该用一个当前键下标来代替tabel remove  
- [x] OnBtnHit()里有大块重复代码
- [x] OnBtnHit()里调用self.play_ui的3个接口，是否应该合并为1个
- [x] OnTouchModeChanged()避免跟 play_ui  相互调用来串流程的做法
- [x]  TryPlayDance(time)  里UCB用法不对
- [x]  TryPlayDance(time) 遍历DanceMapConfig的做法不好  
- [x]  TryPlayDance(time) played_dance_cfg_id用1个table来记录当前的进度非常浪费的
- [x]  ShowJudgeResult(result_type)  里timer没关
- [x]  ShowJudgeResult(result_type)  注册Timer时最后的self参数没用  
- [x]  ShowJudgeResult(result_type)  self.judge_result_timer_id = nil没用  
- [x]  TryShowKey()   wrong_timer_id  没用了
- [x]  GenKeyDirList()处理非法键组的方式不好，效率低、有死循环风险
- [x]  GenKeyDirList()可选键池是固定的，不应该放到最内层循环里创建  

 DanceActor 

- [x] 命名规范
- [x] 异步加载动作播放，有动作停掉的问题
- [x]  Reset()   不要反复、链式取C#对象  

  UnityActorCtrl  &  UnitAnimatorMgr  

- [x]  loadAnimClipList只有清空一种清理方式，可能出现控制冲突
- [x]  loadAnimClipList  的管理不完备
- [x]  CleanStateOverrideAnimation ()非编辑器也应该清理

 DanceCamera  

- [x]  一般不应该直接控制默认的虚拟相机  
- [x]  所有对全局相机的控制都没有还原  

 DanceMgr  

- [x] GetMusicList()   data应该用local  
- [x] GetMusicList() 不应该转存一份配置表，还改名字【根据正式的流程，应该每次只取1条数据】
- [x] GetPlayModeList()  各种名字，应该直接记录string id
- [x] GetStageList()  不应该转存配置表，还改名字
- [x]  不同LoadFileType相关的处理太分散了，好几处if-else  
- [x]  LoadDanceMusic不要随便包装一个通用的方法  
- [x]  GetRandomMusicID()   music_list是数组形势，随机直接取下标、不用循环  
- [x]  GetRandomPlayMode() 可以直接实现随机逻辑，不写死
- [x]  GetRandomStage()  直接在区间做随机
- [x] GetMusicInfo(id)  配置里直接把music_id改成id，代码里就不用循环了
- [x]  Log  应该local
- [x] 有1处命名规范问题
- [x]  整个DanceMgr里有不少跟C#交互的内容，最好在C#侧做一个独立的模块（要保证业务无关）减少Lua直接访问C#的次数（这里跟周晓峰那边的文件处理可以考虑合并）  

AudioMgr

- [x] 不重复的Id直接搞个自增的就完了  
- [x] LoadDanceMusic、PlayDanceMusic  音频的处理不好
- [x]  PauseDanceMusic多余包一层
- [x] _ LoadDanceMusicCo失败也要执行回调

 DanceKeyItem  

- [x]  Ctor()  go直接取组件  
- [x]   ShowDebugInfo   很模板化的if-else尽量简化  
- [x]  SetDir 修改角度做法不合理

 UI_DanceKeyPressMode_Ctrl  

- [x]  Log  要local
- [x]  方法命名规范
- [x]   onBtnHit等几个按键的处理，事件最初的接收者应该在同一个模块
- [x]  CheckInput(input_dir)  注册timer的self没用
- [x]  OnUpdate  设置slider走C4L的接口
- [x]  CreateKeys 里每次创建 DanceKeyItem  很浪费，key_list反复插入、新建也是
- [x]  GetNextActiveKey、GetKeyResult  通过记录进度游标，省去循环遍历
- [x]  OnHideUI   PrefabMgr:Release用的不对

 Page_DanceMain_Ctrl  

- [x] Log local并且要按需声明  
- [x]  OnShow  的参数字段是变量，按变量的命名规范走；参数可传的变量、含义应该在方法的注释里写清楚
- [x]  Release没用的方法  

 UI_DanceMusicShow_Ctrl  

- [x]  OnShowUI   变量生命周期  
- [x]  OnHideUI  销毁要注意顺序

UI_DanceResult_Ctrl

- [x] OnInitScoreItem(go, index)   GetComponent  问题呢
- [x] OnInitScoreItem(go, index)   常量table不能定义在多次调用的函数内  
- [x] OnInitScoreItem(go, index)   string配置可以带参数，避免代码里做拼接  
- [x] OnInitScoreItem(go, index)  重复创建函数调用 SetNativeSize  
- [x] ShowScoreList()  panel的 接口应整合为1个
- [x] OnInitInfoItem(go, index)  跟OnInitScoreItem一样的问题
- [x] OnInitInfoItem(go, index)   直走传id的接口设置文字  
- [x] ShowInfoList()  跟ShowScoreList一样的问题
- [x] OnBtnBack、OnBtnRightBack   返回走GoBack  
- [x] OnHideUI() panel的接口整合

UI_DanceResult_Panel  

- [x] RegisterUpdate、UnregisterUpdate、OnUpdate  设计有问题
- [x] Close()  空方法

 UI_DanceSelect_Ctrl  

- [x]  EnterDance()  DanceMgr存储3个玩家选择结果的做法不好  
- [x]  OnInitPlayModeItem 同上面Item的问题
- [x]  OnInitPlayModeItem 应避免Item里反复创建闭包  
- [x]  OnInitStageItem同上  
- [x]  CheckDifficult 星级判断的逻辑，应该是M层
- [x]  OnInitMusicItem同前 







