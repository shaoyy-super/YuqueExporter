# 一、简介
内容：把剩余的CSharp脚本去除

目的：逻辑代码直接在Lua层实现



# 二、结构设计
内容：

:::tips
1. 删除FishAttr.cs
2. 删除GameController.cs  原有逻辑，新增API接口
3. 修改FishComponent.lua
4. 修改FishMgr.lua

:::

目的：先对自己的功能大结构上的规划，才能指导后面逐步做更详细的设计



# 三、详细结构设计
本次修改主要影响的lua代码

ActorSystem.lua --- 调用相关位置的代码

GunSystem.lua --- 查找目标相关

BulletSystem.lua --- 计算目标位置

Scripts.lua --- 技能脚本

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736478371081-581671a5-4a4f-4f85-9efc-ac22f5f41bae.png)

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736478412783-d0542f39-0919-4129-ac70-171d06bbdefa.png)

修改原有的FishComponent 新增方法



主要的方法修改统计

1.设置位置，欧拉角等

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736478829420-40d511c1-2001-4554-8876-0acaea18053d.png)

FishComponent:SetPosition(x,y,z)

FishComponent:SetLocalEulerAngles(x,y,z)

2.设置缩放

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736478871169-93ff42e4-495d-4651-9fe6-008e660cd641.png)

FishComponent:SetLocalScale(x,y,z)



3.获取位置，获取UI位置![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736479040038-14d70559-81b0-4979-987a-127106ba0793.png)

FishComponent:GetPosition() : x,y,z

FIshComponent:GetUIPosition(): x,y

4. 计算鱼的碰撞

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736479273165-279a350f-b03c-4903-80cf-efd39aee8d3a.png)

FishComponent:GetBoxCollider(int): 返回碰撞体 --<font style="color:#1DC0C9;">- </font><font style="color:#1DC0C9;background-color:#EFF0F0;">这个东西必须吗？感觉没啥必要</font>

因为FishAttr 删除，ShadowCollider 放到GameController 内部 并增加映射关系 Dictionary<int,int>



新增

GameController:AddFishShadowCollider(int cs_actor_id):int 返回碰撞id

~~GameController:ConvertFishShadowInColliderPosition(int collider_id ) :Vector3 ~~

~~GameController:ConvertFishShadowOutColliderPosition(int collider_id ) :Vector3~~

<font style="background-color:#FBDE28;">函数名字有点奇怪，重命名 </font>

~~GameController:GetFishHeadColliderPosition(int collider_id ) :Vector3 ~~

~~GameController:GetFishTailColliderPosition(int collider_id ) :Vector3 ~~

~~GameController:GetFishColliderPosition(int collider_id):Vector3~~

GameController:IsInScreen(int collider_id):bool

方法用来判定鱼是否在屏幕内，是否需要该功能？[@何佳蔚](undefined/littleorange-8k8nt) 鱼在屏幕外可以被锁定吗？





5.Object的接口改掉

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736486783769-3679dd12-666d-440d-b2a1-b5bf9af83a3c.png)

~~新增函数~~

~~GameController:GetFishGameObjectByColliderID(int id):int  ~~

函数最终使用的FishBase 

这里需要在lua层 新增函数



FishMgr:GetFishByColliderID(collider_id):FishBase

FishMgr:GetFishByGameObjectID(cs_actor_id):FishBase



6.目标选择逻辑

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736487660787-fef1d460-b44d-459f-91a0-c2825a63e253.png)

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736487925754-ea72baeb-a17b-4051-b8fb-0cd1c484a7d1.png)



因为最终都会查找到FishBase,所以在最开始的阶段最好就存储FishBase，而不是FishAttr



修改目标选择逻辑



新增方法

FishMgr.sort_fishes --- 用于保存视野里的鱼

FishMgr:AddSortFish(FishBase)  ---增加鱼到视野内部

FishMgr:RemoveSortFish(FishBase) --- 移除鱼到视野内部

基本和CSharp逻辑对应

<font style="background-color:#FBDE28;">注意逻辑解耦，这里原来的逻辑 “是否在视野内和是否可以攻击”耦合，把是否可以攻击变成FishBase的某个属性</font>

<font style="background-color:#FBDE28;">也就是FishComponent.can_attack ，这里只保留视野内相关的逻辑</font>

需要在鱼移动之后判定鱼是否要移除



7. 这个逻辑是什么到时候整理一下

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736489419679-25cce6a0-b347-4338-8fe1-cc588731eae9.png)



8.Fish的状态变化处理

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736490718353-065d3674-21ee-47e1-9102-ec373a05c971.png)

FishAttr.Update 中会判定鱼的状态，改到AutoMoveSystem.lua 鱼移动之后判定一下鱼的状态

关于时间的，则到ActorSystem:OnLifeCheck



UML 类图

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1736502313144-41e58f8c-ca6b-4014-8215-0bbe7ee6d71b.png)



# 四、流程设计
1.先把FishAttr.cs 移动到Component上以组件的形式提供方法，保证可以运行游戏，此时可以合并主干

2.收集Component 上的方法，并改成CSharp API调用的方式



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论





---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

