# 一、简介
背包系统的功能如下：

1. 展示背包内的物品列表，根据物品类型分类展示。

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1720779019407-c22701d8-a2dd-46bc-8baf-04bfcf5c0ca3.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)

2. 展示玩家角色的模型及当前的穿着，并且可以通过点击背包内的服装进行换装。
3. 角色的穿着存放在若干个衣柜中，可以点击对应的衣柜穿上衣柜中设置的衣服，此时角色换装并保存后，会保存到当前选中的衣柜中。

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1720777624060-f32ecca0-eb5b-49c3-bf42-e2d1ce470e45.png?x-oss-process=image%2Fformat%2Cwebp)

4. 长按道具图标后，显示对应的道具详情弹窗，可以查看道具的获取途径。

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1720781619271-ad9ab05a-e44b-4ef5-9166-97071b869848.png?x-oss-process=image%2Fformat%2Cwebp)

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1720781874124-afe8af13-3ed4-49a4-a1dc-e4ac80a4980f.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_579%2Climit_0)

5. 在背包界面可以对角色模型进行旋转缩放等操作。
6. 点击背包界面角色模型旁边的预览按钮，可以打开预览界面，在这个界面可以切换单人或者双人的展示。如果最后一个装备的服装是套装的一部分，可以切换展示整个套装。

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1722940299977-6dba3cde-8a20-4c09-88d4-2b7142fe2a70.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)



# 二、结构设计
:::info
1. **新增流程控制脚本**
    1. Page_Bag_Ctrl，负责背包系统的跳转管理。
    2. Page_ClothPreview_Ctrl，负责服装预览的跳转管理。
2. **新增VM脚本**
    1. BagVM，存储角色背包数据以及收发服务器消息。缓存换装数据AvatarData，C#端通过item_id获取AvatarData。
3. **新增UI脚本**
    1. UI_Bag_Ctrl和UI_Bag_Panel，负责背包界面的显示逻辑。
    2. UI_Bag_Item，负责背包内每个道具的显示逻辑。
    3. UI_ItemTips_Ctrl和UI_ItemTips_Panel，通用界面，负责物品详情界面的显示逻辑。
    4. UI_ItemGainWay_Ctrl和UI_ItemGainWay_Panel，通用界面，负责物品获取途径界面的显示逻辑。
    5. UI_ClothPreview_Ctrl和UI_ClothPreview_Panel，负责服装预览界面的显示逻辑。
4. **新增角色控制脚本**
    1. DressActor。负责角色模型加载、动画播放以及向Actor.cs发起换装请求。
5. **新增通用脚本**
    1. TransformDragController.cs，负责控制物体旋转、位置、缩放。
    2. InputReceiver.cs，负责接收玩家输入。通过回调方式通知。
6. **新增数据缓存脚本**
    1. ActorCacheMgr.cs，负责缓存数据。
        1. AvatarData数据，Lua端发起换装请求前，先将本次换装所需的AvatarData存入BagVM中，C#端拿到换装各部位ID之后，先从ActorCacheMgr中检查是否有缓存，没有的话ActorCacheMgr通过回调从BagVM中取数据并缓存。
        2. 模型资源缓存，维护一个资源缓存列表，在加载资源之前，先检查是否在缓存中，没有的话再加载。列表默认长度50，超出长度后从头开始回收资源，并将新的资源放入对应位置。
7. **新增C#脚本**
    1. Actor.cs：负责角色的换装逻辑。
    2. AvatarData.cs：Lua通知C#换装时，传递的换装数据。
    3. TrackAimController.cs和TrackAimAnimator.cs：负责角色的头部和眼球跟踪。

:::





# 三、详细结构设计
:::info
1. **配置表格式转换**
    1. 道具数据在Item表中。
    2. 物品的获取途径，在itemBook文件中的Item_Score表中。
    3. 服装的冲突判定，在itemConflict文件中的Item_Conflict表中。
2. **道具图标资源**：
    1. 通用道具放到Art/UI/Icon/Item文件夹中。
    2. 服装图标放在Art/UI/Icon文件夹中，按部位分文件夹。
    3. 资源压缩格式为ASTC 4x4
3. **道具的获取途径跳转：**
    1. 通过Goto表，找到对应模块之后，检查该模块的Page是否有对应的跳转方法CanEnter()，并将表中配置参数传过去，如果没有找到CanEnter()方法，默认使用PageMgr的goto方法跳转到该模块。
4. **网络交互**
    1. **背包：**
        1. 通过IDBGetItemListReq协议获取，参数一nRoleID为玩家ID，参数二bagType为背包类型，背包系统需要获取的背包数据类型为enmBagType_Normal。
        2. 返回的参数中，arrItemUnit是道具列表，单个道具的数据类型为ItemUnit
            1. ItemUnit重要的参数如下：
                1. nItemInsID：道具的实例ID
                2. nItemID：道具的配置ID
                3. useMeans：用途
                4. nQuantity：如果useMeans是Time类型的，这个参数就是道具的有效时长，反之则是道具的数量。
                5. nOwnTick：道具的获取时间，配合上面的nQuantity可以获得该道具的剩余时长及有没有过期。
            2. 返回后将道具列表存入BagVM中
        3. 当道具发生变化时，通过IDBItemUpdateNoti通知。需要在收到通知时更新道具列表
    2. **换装:**
        1. ADBGetAccountInfoReq获取玩家信息的时候，会返回参数stAvatarInfo，是玩家当前的装扮列表
        2. 通过 IDBUpdateAvatarReq发起换装请求，参数一nRoleID是玩家ID，参数二stAvatarInfo是装扮列表，参数三nPlanID为当前选择的衣柜ID。
    3. **衣柜:**
        1. 衣柜ID从0开始。
        2. 新增配置表ClothPlan，配置每个衣柜的解锁条件。
        3. 通过IDBChangeAvatarPlanReq切换衣柜，参数一nRoleID为玩家ID，参数二nPlanID为衣柜ID，返回的arrAvatarItem为当前衣柜的装扮列表。
        4. ADBGetAccountInfoReq获取玩家信息的时候，返回的参数stRolePrivateInfo中的nPlanUsed为当前选中的衣柜ID。
5. **换装**
    1. **移植版署版的换装系统，包括一下几个脚本**
        1. Player.cs及其基类Actor包含了所有换装相关的逻辑，全部移植过来，合并成Actor类。
        2. AvatarCameraController包含了相机移动、角色旋转等逻辑，其中一些输入相关的逻辑需要移植到TransformDragReceiver脚本中，其他逻辑可以移植到TransformDragController中。
        3. BodyController是角色动画的基础控制脚本，可以用BagActor代替。
        4. TrackAimAnimator和TrackAimController是负责角色的头部及眼部追踪的，需要移植过来。
    2. **换装资源**
        1. 正式版换装资源需要按需下载，当前版本先将资源放到本地，将模型Prefab、贴图、材质按部位分类放在Avatar文件夹下，每个模型一个文件夹。![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1724379660829-8c310c32-c932-4366-8350-7bc39f4e2308.png)
        2. 服装的图标按部位分文件夹放到Art/UI/Icon文件夹中。![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1724379874519-2b385609-b9a6-465b-946d-bafdff9ca7da.png)
    3. **换装的逻辑分离**
        1. 版署版中数据和换装逻辑都在C#中，移植过来之后，将数据存在Lua，C#只负责换装逻辑。
        2. 换装的请求由Lua端发起，C#端收到换装的数据之后执行换装。换装数据包括资源路径、部位、换装后动画Timeline等。
    4. **换装的撤回功能**
        1. 使用一个列表，记录操作，操作包括：穿上、脱下以及对应的道具实体ID。
        2. 撤回时依次从列表尾部取出最后一个操作后反转并应用到角色上。
        3. 当保存穿着时或者退出背包系统时清空操作列表。
    5. **保存、还原、撤回功能**
        1. 在进背包的时候记录原始装扮。
        2. 保存按钮：点击后向服务器发送换装请求。每次装扮发生变化时，对比当前装扮是否与原始装扮一致，一致的话置灰，不一致就激活。
        3. 撤回按钮：当操作列表发生变化时，判断操作列表中是否有数据，有的话就激活，否则置灰。
        4. 还原按钮：点击后将当前装扮换成原始装扮。当前装扮发生改变时，判断是否与原始装扮一致，是的话置灰，否则激活。
    6. **捏脸数据移植**
        1. 创建角色的时候，会读取一套眼部追踪的数据。这套数据是二进制的，需要通过捏脸工具提供的接口解析成Json文件，然后设置到TrackAimAnimator脚本中。
        2. 这个版本不考虑捏脸，所以没有必要将捏脸相关代码移植过来，直接将解析后的Json保存下来在游戏中读取。
6. **类的依赖关系及重要方法**

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1724398109408-5d530d5b-09cb-47d9-9e20-fb9d03e7427b.png)

:::



# 四、流程设计
1. 背包系统的流程

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1724138916935-c6d93fef-6fd5-4901-ac64-3faeba74d53c.png)

2. 换装的流程

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1724328964642-07e7ffac-4063-41bd-a9ba-90e9efce862e.png)



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

