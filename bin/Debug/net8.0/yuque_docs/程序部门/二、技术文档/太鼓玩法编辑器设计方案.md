# 一、简介
太鼓玩法编辑器是一套可视化的工具和界面，能帮助音乐制作人、音乐爱好者等用户直观地设计和调整太鼓玩法的按键功能，使其更加高效、便捷地创建和编辑游戏谱面。

主要功能如下![](https://cdn.nlark.com/yuque/0/2025/png/44683805/1736923010663-bec71da1-68e3-4206-a35f-f235e19af06e.png?x-oss-process=image%2Fformat%2Cwebp)

主界面如图![](https://cdn.nlark.com/yuque/0/2025/png/44683805/1736924202327-5c08e750-ddb1-44d9-ae42-a1541a62cf83.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)

左上角按键区域显示全部按键预设，通过点击选中。中间的预览区域可以随时预览谱面。右上角按键预览区域显示当前选中的按键预设的动态动画。下方编辑区域用于谱面编辑。



# 二、结构设计
内容：

:::tips
1. **新增流程控制脚本**
    1. Page_RhythmEditor_Ctrl，控制整个编辑器流程
2. **新增UI脚本**
    1. UI_RhythmEditor_Ctrl和UI_RhythmEditor_Panel，负责编辑器UI显示
    2. UI_RhythmEditorPreview_Ctrl和UI_RhythmEditorPreview_Panel，负责预览UI功能
    3. UI_RhythmEditorPresetKey_Ctrl和UI_RhythmEditorPresetKey_Panel，负责按键选择区域UI功能
    4. UI_RhythmEditorPreviewKey_Ctrl和UI_RhythmEditorPreviewKey_Panel，负责按键预览区域UI功能
    5. UI_RhythmEditorBeatMap_Ctrl和UI_RhythmEditorBeatMap_Panel，负责编辑区域UI功能
3. **新增按键控制脚本**
    1. UI_RhythmEditorPresetKeyItem，负责按键预设区域的单个按键逻辑
    2. UI_RhythmEditorKeyItem，负责谱面编辑区域的按键逻辑
4. **新增轨道小节显示脚本**
    1. UI_RhythmEditorBeatItem，负责在轨道中显示每小节分割线
5. **新增VM脚本**
    1. RhythmEditorVM，负责整个编辑器流程的数据存储及服务器通讯

:::



# 三、详细结构设计
:::info
1. **歌曲信息获取**
    1. 按照游戏流程，需要先选中歌曲才能进行谱面编辑，所以当前选中歌曲信息可以通过UGCMainVM:GetSelectUGCCreationData()获取。
    2. 获取信息包括：作品名、BPM、舞步、当前谱面、歌曲Clip等。
2. **预览功能实现**
    1. 加载默认舞台场景和默认角色，通过RenderTexture显示到预览区。
    2. 全屏预览通过放大RenderTexture实现。
    3. 如果有舞蹈动作，播放舞蹈动作，否则播放角色待机动作。
    4. 根据当前时间推算音符出现的位置。
    5. 预览界面只能显示，无法进行游玩，判定时播放完美判定。
3. **按键预览区域**
    1. 根据当前选择的按键预设，显示对应的动画。
    2. 固定显示一条轨道，根据选择的按键预设加载对应的按键，使用DoTween将按键从右到左移动到轨道判定点，移动时间1秒。
    3. 循环播放。
4. **音符编辑区域**
    1. **音符轨道显示**
        1. 轨道长度计算：总长度=总节拍数*每节拍像素长度*缩放。
        2. 总节拍数=音乐长度（秒）/每节拍长度（秒）。
        3. 每节拍长度=60 / bpm。
        4. 缩放：通过点击高级设置中的加减按钮，调整缩放值，默认为1，每次点击加号缩放*2，点击减号缩放/2。
        5. 使用UIScrollRect显示节拍分割线
            1. 子物体结构如图![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1737697846226-05b18588-96af-4cdc-bd7b-c36d3c71b0ff.png)。
            2. BeatLine为最右边的线，表示该节拍在轨道中结束点。
            3. TrackGroup下根据当前选择的轨道数，当前版本默认4条轨道，后续需要支持动态修改，这里TrackLine根据轨道数动态生成。
            4. TextBeat显示当前小节号。
            5. TextTime显示当前小节的开始时间。
            6. BeatItem高度固定，宽度=每节拍像素长度*缩放/每小节节拍数。
            7. 每小节节拍数可以通过设置按钮动态调整。![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1733993274694-1ae3076d-651d-449b-9b4c-cf2651789d0e.png)
    2. **音符显示逻辑及其结构**
        1. **音符：**![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1737699116827-12d5702b-6f73-4b3c-97cb-bdb67e9a7a03.png)，ImgIcon显示箭头图标，Line显示长音符的连线，Line的长度根据当前长音符的长度改变。
        2. **预设音符**：预设音符显示在左上角按键预览区，主要分为单音符和长音符，其他区别在于音符的方向。
    3. **音符操作逻辑**
        1. **添加**，选中任一预设音符，点击轨道区域进行添加。
            1. 通过BeatItem接收点击事件，获取点击的具体坐标点，通过事件通知UI绘制音符。
            2. **对齐至格线**：高级设置中，勾选对齐至格线，取鼠标点击位置右方最近小节线放置音符，否则取鼠标点击位置放置音符。
            3. 单音符添加规则：
                1. 无法放置于负数时间段。
                2. 同一时间同一轨道只能放置一个。
            4. 长音符点击轨道后放置第一个节点，然后进入绘制状态，点击其他位置放置长音符的结尾时间。
            5. 长音符的绘制规则：
                1. 首个音符放置规则同单音符。
                2. 音符的结尾只能绘制于首音符的右侧。
                3. 当音符结尾已绘制，点击其他符合规则的位置，则会重新绘制音符的结尾。
        2. **删除**
            1. **单音符：**右键点击删除。
            2. **长音符：**右键点击先删除连线，再次点击删除音符。
        3. **移动**
            1. **单音符：**拖拽。
            2. **长音符：**拖拽首个音符。
        4. **多选**
            1. 点击多选按钮，进入框选状态，按住左键拖拽会显示蓝色框选区域，松开左键后，框选区域内的音符全部进入选择状态，之后可以使用鼠标或快捷键进行删除、复制、移动。
            2. 由于音符无法重叠，需要将复制的新音符进行偏移。
        5. **撤销**
            1. 使用栈存储操作步骤，撤销时依次从栈顶取出操作步骤进行还原。
        6. **恢复**
            1. 使用单独的栈存储撤销的步骤，恢复时依次从栈顶取出撤销步骤进行恢复。
        7. **暂存**
            1. 点击暂存按钮，将最新谱面保存到本地，下次进入该作品的谱面编辑，先检查是否有暂存谱面，优先加载。
        8. **完成**
            1. 点击完成按钮，提交最新谱面到服务器。
            2. 通过CreationHttpManager.Inst.UploadFileToCos()将谱面json文件提交到云端。
            3. 提交完毕后调用CreationHttpManager.Inst.PostCreation()通知服务器更新作品状态。
5. **类的引用关系**

![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1737709839037-5e8bfd3e-0dd3-419f-ba52-149dee700fc3.png)

:::





# 四、流程设计
**时序图：**

![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1737710101752-c7f284d6-e311-4723-bf2f-a1a1d90d95fd.png)



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

