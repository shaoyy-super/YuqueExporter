### 环境初始化
参考[thoughts 文档](https://thoughts.teambition.com/workspaces/5dfb64dfdd03ff001360619e/docs/5dfdbb0ae8307b00012b8809)

### 安装Mariadb
+ 安装Mariadb

yum install mariadb-server -y

+ 修改配置

vim /etc/my.cnf

# 替换下面字段datadir=/data/mysql

socket=/data/mysql/mysql.sock

innodb_file_per_table = 1log_bin=mysql-bin

log_bin_index=mysql-bin.index

expire_logs_days=7

binlog_format=mixed

max_binlog_size=100m

binlog_cache_size=4m

max_binlog_cache_size=512m

+ 创建数据目录

mkdir -p /data/mysqlchown -R mysql.root /data/mysql/

+ 链接sock文件

ln -s /data/mysql/mysql.sock  /var/lib/mysql/

+ 启动服务

systemctl start mariadb.servicesystemctl enable mariadb.service

+ 查看端口

netstat -tnlp | grep 3306

+ 设置密码

# 设置密码（Dm2018Pwd123）mysql_secure_installation

### 安装mmonit
+ 创建用户

useradd dm

+ 安装

上传mmonit软件包至dm用户的家目录，并解压tar xf mmonit-3.7.3-linux-x64.tar.gz

+ 配置守护进程

vim /etc/systemd/system/mmonit.service[Unit]

Description = Easy, proactive monitoring of Unix systems, network and cloud services

After = network.target

Documentation= [https://mmonit.com/documentation/](https://mmonit.com/documentation/)



[Service]

Type=simple

KillMode=process

User=dm

Group=dm

ExecStart = /home/dm/mmonit/bin/mmonit -i

ExecStop = /home/dm/mmonit/bin/mmonit stop

PIDFile = /home/dm/mmonit/logs/mmonit.pid

Restart = on-abnormal



[Install]

WantedBy = multi-user.target

+ 启动服务

systemctl daemon-reload

systemctl enable mmonit

systemctl start mmonit默认账号密码 admin/Dm2018Pwd123

### 安装salt-master
+ 环境准备

vim /etc/yum.repos.d/saltstack-rhel7.repo[saltstack-repo]

name=SaltStack repo for RHEL/CentOS $releasever

#baseurl=https://repo.saltstack.com/yum/redhat/$releasever/$basearch/latest

baseurl=https://archive.repo.saltproject.io/yum/redhat/7/x86_64/3000/

enabled=1

gpgcheck=0#gpgkey=https://repo.saltstack.com/yum/redhat/$releasever/$basearch/latest/SALTSTACK-GPG-KEY.pub

+ 安装

yum install salt-master -y

+ 创建目录并部署（/data/salt）

mkdir -p /data/salt/{states,pillar}

+ 修改配置（/etc/salt/master）

file_roots:

  base:

    - /data/salt/states

pillar_roots:

  base:

    - /data/salt/pillar

+ 启动

# 设置开启动systemctl enable salt-master

# 开启systemctl start salt-master

+ 管理密钥
    - 查询密钥

salt-key -L

+ 接受密钥

# 单个接受salt-key -a dm-1# 全部接受salt-key -A

### 配置salt-master
+ 从git上，拉取sls配置文件

# 数码项目sls文件git clone -b dm [http://192.168.51.223/platform/om-saltstack.gitcp](http://192.168.51.223/platform/om-saltstack.gitcp) -rf om-saltstack/pillar /data/salt/pillar cp -rf om-saltstack/states /data/salt/states # 口袋项目sls文件git clone  [http://192.168.51.223/platform/om-saltstack.gitcp](http://192.168.51.223/platform/om-saltstack.gitcp) -rf om-saltstack/pillar /data/salt/pillar cp -rf om-saltstack/states /data/salt/states 

### 配置区组入口
数码项目路径/data/ProjectDM，用户dm

口袋项目路径/data/ProjectPok，用户pok

+ 创建区组入口文件

## 数码mkdir -p /data/ProjectDMvim /data/ProjectDM/group.json#######[

    {

        "id": 1,

        "name": "xm",

        "version": "4.0",

        "group": "group",

        "channels":

        [

            {"id": 0, "urls": [""]},

            {"id": 210000, "urls": [""]},

        ]

    },

]

## 口袋mkdir -p /data/ProjectPokvim /data/ProjectDM/group.json#######[

    {

        "id": 1,

        "name": "xm",

        "version": "4.0",

        "group": "group",

        "channels":

        [

            {"id": 0, "urls": [""]},

            {"id": 210000, "urls": [""]},

        ]

    },

]######

+ 创建公告文件

rz notice.json

[notice-ad.json](https://tcs.teambition.net/storage/101w856a09c754293a5280c95b4a3c8f5d62?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTcxMzc4MTQ2NiwiaWF0IjoxNzEzMTc2NjY2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzEwMXc4NTZhMDljNzU0MjkzYTUyODBjOTViNGEzYzhmNWQ2MiJ9.vG_fYF10LArfPlqrj8y6dJqxUKVquStzV_qmAC2nzmY&download=notice-ad.json)

+ 创建提审和商品配置文件

rz package.jsonrz package_config.jsonmkdir pay

[package.json](https://tcs.teambition.net/storage/101we23d7e06a67e7384184df707ea5540bd?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTcxMzc4MTQ2NiwiaWF0IjoxNzEzMTc2NjY2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzEwMXdlMjNkN2UwNmE2N2U3Mzg0MTg0ZGY3MDdlYTU1NDBiZCJ9.DzfJBpRLnoe71HJpC2Y0yPhSFsPj1nYu2ZxYLOPNFyw&download=package.json)

[package_config.json](https://tcs.teambition.net/storage/101wafae2ab1c958f54cdbebf89566e5492f?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTcxMzc4MTQ2NiwiaWF0IjoxNzEzMTc2NjY2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzEwMXdhZmFlMmFiMWM5NThmNTRjZGJlYmY4OTU2NmU1NDkyZiJ9.9rTqY12YnINnOmHx4IVeeetgL4Sws8nly6zB22K1JbU&download=package_config.json)

+ 创建游戏入口文件server_list.json

### 数码cd  groupvim server_list.json{

    "id": 1,

    "name": "天使兽",

    "version_min": "4.0.0",

    "version_max": "4.0.94",

    "patch_url": "http://static.jz.hz.sthaozhe.com/pok/4.0.94.128043",

    "servers": [

        {

            "id": 1,

            "name": "天使兽",

            "state": 2,

            "urls_login": [

                "game-1.jz.hz.sthaozhe.com:10010"

            ],

            "urls_game": [

                "game-1.jz.hz.sthaozhe.com:9010",

                "game-1.jz.hz.sthaozhe.com:9011",

                "game-1.jz.hz.sthaozhe.com:9012",

                "game-1.jz.hz.sthaozhe.com:9013"

            ]

        },    ]}

### 口袋cd  groupvim server_list.json{

    "id": 1, 

    "name": "game", 

    "version_min": "1.0.0", 

    "version_max": "2.0.52", 

    "patch_url": "http://res.pok.hz.sthaozhe.com/2.0.52.128992", 

    "logins": [

        "139.9.207.141:10010", 

        "139.9.207.141:10020"

    ], 

    "games": [

        {

            "id": 1, 

            "name": "皮卡丘", 

            "state": 2, 

            "urls": [

                "ios-1.pok.hz.sthaozhe.com:9010", 

                "ios-1.pok.hz.sthaozhe.com:9011"

            ]

        },     ]}

