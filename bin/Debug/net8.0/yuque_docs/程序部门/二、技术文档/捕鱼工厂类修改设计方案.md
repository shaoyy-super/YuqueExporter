# 一、简介
内容：主要介绍捕鱼项目中有哪些系统，哪些模式，哪些可以组合使用

目的：将ECS中 C和S拆分清楚，确保逻辑可以复用，并提供工厂类来组装不同的业务逻辑





# 二、结构设计
内容：

:::tips
1. FishCreateSystem 耦合较为严重，有新手渔场的逻辑和大奖模式的逻辑，这里应该拆分成不同的系统
2. 各个系统的初始化都是由ECS:Init 初始化的时候决定，不同模式下，可能初始化的系统不一样，比如大奖模式并没有普通鱼场的逻辑，这里需要将初始化解耦
3. Component 中 子弹的逻辑分叉较多，不利于拓展，这里需要解耦

:::

目的：先对自己的功能大结构上的规划，才能指导后面逐步做更详细的设计



# 三、详细结构设计
内容：

:::info
1. 通用的模块：用UML类图给出全部对外接口的定义（要带参数）；如果涉及多个类或者脚本，要在类图中体现出依赖关系
2. 系统内重要的模块：用UML类图或XMind脑图给出重要数据结构定义，并且体现出模块间的依赖关系
3. 除类图、类结构的详细说明外，还应该给出功能涉及到的各种重要规则、用法的说明。

:::

目的：

:::info
1. 对重要的部分，深入思考实现细节。
2. 列出依赖关系，辅助思考设计是否合理。
3. 让其他人更直观的看到具体用法（主要是指通用的部分）

:::

注意点：

:::info
1. 通用模块，自身功能实现要完备（如：有开就要有关）。不要为了偷懒随意搞全局的东西出来
2. 通用模块，对外提供的接口要简洁易用
3. 标记依赖关系的时候，重点思考内聚、耦合问题

:::

![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1737355373739-02de802e-bd7a-45d2-bf20-490c93d083cf.png)

可以看到 这个系统除了，小鱼创建，还有鱼的波次创建，还有波次相关的boss创建

新手引导中，完全不需要这个系统

正常渔场只需要执行第一个函数，用来检测时间间隔



经过修改如下图



![](https://cdn.nlark.com/yuque/0/2025/png/49784329/1737362312403-9a308070-0371-4d46-8264-f1ddd57ca34e.png)

其中碰撞和鱼的系统合并

ActorSystem 在ECS重构完成之后再和 FishSystem 合并

子弹系统的设计，由于子弹扩展越来越多，需要拆分成不同的处理类型

```lua
--- 初始化
--- @param entity EntityBase
--- @param com BulletComponent
function BulletSystem:OnBulletInit(entity, com)
    if com.init == nil then
        com.destroyed = false
        local gun_com = self:GetGunCom(entity, com)
        if com.bullet_type == BulletType.Normal then
            local normal_bullet_config = ConfigMgr:GetConfigById(CfgEnum.Bullet, gun_com.config.normal_bullet)
            com.hit_prefab = normal_bullet_config.hit_prefab
            com.shot_effect_prefab = normal_bullet_config.shot_effect_prefab
            local position = CS4Lua.GameControl:GetBulletPosition(com.bullet_uid)
            com.move_speed = com.speed * FishTools.GetCameraRate(FishTools.CameraDistance - position.y);
        elseif com.bullet_type == BulletType.BigReward then
            local normal_bullet_config = ConfigMgr:GetConfigById(CfgEnum.Bullet, gun_com.config.normal_bullet)
            com.hit_prefab = normal_bullet_config.hit_prefab
            com.shot_effect_prefab = normal_bullet_config.shot_effect_prefab
            com.bomb_effect_prefab = 'P_FX_dajiangyu_paodan_boom'
        elseif com.bullet_type == BulletType.Special then
            local tool_bullet_config = ConfigMgr:GetConfigById(CfgEnum.Bullet, gun_com.config.tool_bullet)
            com.hit_prefab = tool_bullet_config.hit_prefab
            com.shot_effect_prefab = tool_bullet_config.shot_effect_prefab
            local position = CS4Lua.GameControl:GetBulletPosition(com.bullet_uid)
            com.move_speed = com.speed * FishTools.GetCameraRate(FishTools.CameraDistance - position.y);
        elseif com.bullet_type == BulletType.Laser then
            local laser_bullet_config = ConfigMgr:GetConfigById(CfgEnum.Bullet, gun_com.config.laser_bullet)
            com.hit_prefab = laser_bullet_config.hit_prefab
            com.shot_effect_prefab = laser_bullet_config.shot_effect_prefab
        end

        if com.target_id ~= 0 then
            local fish = FishMgr:GetFish(com.target_id)
            if fish then
                ---@type FishBase
                com.target_fish = fish
            end
        end
        if com.bullet_type == BulletType.Laser then
            com.last_time = com.interval_time
            self:InitFireEffect(entity, com)
            self:SetLaserEffect(entity, com)
        elseif com.bullet_type == BulletType.BigReward then
            self:OnBigRewardInit(entity, com)
        else
            self:InitFireEffect(entity, com)
        end
        com.init = true
    end
end
```

可以看到if判断的模块越来越多，需要整理成处理类



同样的还有GunSystem 相关的处理，也需要根据具体的炮的类型来处理选择的逻辑

# 四、流程设计
内容：用时序图描述模块间的交互流程；用流程图描述核心算法

目的：讲解流程。通过画图让自己思考更深入、让其他人看的更直观。



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

