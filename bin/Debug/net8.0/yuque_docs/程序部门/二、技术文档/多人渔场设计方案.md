# 一、简介
之前渔场功能只考虑通过AI模拟, 场内只存在一个真人. 现阶段提出需要支持多人功能, 但不排除取消AI的情况, 故针对多人渔场功能需要重新组织一些功能及结构.

考虑后续AI可能还会使用的情况, 故计划多人渔场实际为开发一个新的炮台, 该炮台只接收服务器消息作为其行为依据, 但当前炮台部分代码仍在C#层, 故临时用BattleMgr作为中转, 后续版本再考虑优化.

设计处理要点:

1. 服务器鱼的轨迹, 位置同步(房间时间+鱼的唯一id作为随机种子, 随机相关都走此种子, 可确保服务器鱼的同步).
2. <font style="color:#DF2A3F;">房间时间同步及误差较大时通过加速处理.</font>
3. 渔场状态还原(道具(需要服务器修改), 鱼的位置, 初始鱼直接拉后n秒, 出生tml后加入的玩家需要支持续播, 死亡tml后加入的玩家不处理).
4. 子弹同步方案(当前考虑做法为普通子弹同步方向, 鱼场道具同步命中目标).
5. 原有AI功能的处理. (先增加配置开关, 后续看需求是否需要重构).

总体方案简介: 客户端与服务器同步房间时间作为渔场内鱼同步的基准, 鱼的位置和生成都依赖于房间时间. 不同玩家之间房间时间是同样的, 轨迹与位置通过随机种子控制同步, 可以确保服务器鱼在不同玩家的手机上同步效果. 子弹同步方案见下方讨论.

# 二、结构设计
内容：

:::tips
GunAttr: 扩展一个新类型的炮台, 该炮台只接收服务器消息作为自己的行为依据.

BattleMgr: 处理一些全局的功能, 比如炮台镜像, 鱼的受击及死亡, 客户端模拟其他玩家打中小鱼的死亡.

UI_GameMain_Ctrl: 临时负责Lua和C#的中转, 接收服务器消息并将其加入GunAttr的行为堆栈. 同时负责处理玩家的进出及对应状态的刷新.

EF_AutoMove: 之前用于承载轨迹功能的脚本, 这次存在1. 多人之间精英鱼的轨迹和效果同步, 2. 进入进行到一半的房间时鱼轨迹的同步. 2个问题, 故需要对原有功能进行修改.

FisheryItemBase: 之前承载渔场道具的功能, 这次先将其扩展为接收服务器消息使用对应效果的.

:::

# 三、详细结构设计
内容：

:::info
![](https://cdn.nlark.com/yuque/0/2024/png/43288772/1729662321633-1c7db292-67f3-4b77-b2de-36dec7565619.png)

:::

临时先使用BattleMgr做玩家数据的缓存, 后续在PlayerInfo移到Lua之后考虑跟AI系统整合成一个数据层, 以便后续处理玩家信息和AI信息, 行为.

# 四、流程设计
内容：流程图:

![](https://cdn.nlark.com/yuque/0/2024/png/43288772/1729735661740-5e24e0c1-27d9-40c3-9240-0745ae588169.png)

时序图:

![](https://cdn.nlark.com/yuque/0/2024/png/43288772/1729666068225-bc5a6133-1bd9-494e-b89e-b695d4b80093.png)





# 五、提出问题
1. 子弹同步问题

基于当前服务器提供做法(客户端收集子弹发射信息, 每隔0.6s发给服务器做一次房间内广播), 以及项目情况(小鱼无法同步且锁定和狂暴道具会发放的较多), 提出做法: 

1. 不使用道具发射的普通子弹: 只同步数量和方向, 存在同步延迟, 发射之后命中小鱼的结算由各自玩家本地处理, 但不实际影响玩家数据, 可能存在命中前面的小鱼但后面服务器鱼炸了的情况, 依据之前讨论结果, 此情况可以接受.
2. 使用道具发射子弹: 同步命中目标, 存在同步延迟, 使用之后通过服务器通知的命中信息决定玩家锁定的目标, 使用此做法时不再同步数量和方向, 只依赖于道具的使用状态. 如果考虑AI情况及锁定小鱼情况, 可能存在空挡(1个玩家在打精英鱼, 但其他一个玩家手机上该鱼被AI打死了, 无法切换成正确目标, 或锁小鱼另外一边没有该种类小鱼, 或一条鱼刚被打死时(刚被打死时本身便会自动切换为鱼分最高的鱼, 故影响不大)), 空档期会自动切换为锁定渔场内鱼分最高的鱼(道具默认逻辑)

<font style="color:#DF2A3F;">讨论结果: 修改为同步发射状态, 取消0.6秒强制CD, 改为炮台攻击时做一次方向上的即时同步(不改变方向则不处理), 使用道具时在切换目标时同步一次目标, 切换目标改为点击避免拖按时频繁切换目标情况.</font>

2. <font style="color:#DF2A3F;">金币同步问题</font>

<font style="color:#DF2A3F;">优先客户端本地计算, 但隔一段时间会去同步一次实际值, 避免误差过大. (误差原因: 同步射击状态的网络延迟, 玩家触发其他获得金币功能).</font>

3. <font style="color:#DF2A3F;">异步加载过程中的数据过期问题</font>

<font style="color:#DF2A3F;">考虑通过消息队列暂存的形式, 在进入房间到整个渔场状态还原完成期间内收到的消息都经过延迟处理, 避免出现加载过程中的数据过期.</font>

4. <font style="color:#DF2A3F;">房间内的断线重连问题</font>

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

