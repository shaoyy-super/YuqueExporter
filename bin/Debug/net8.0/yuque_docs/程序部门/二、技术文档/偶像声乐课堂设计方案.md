# 一、简介
声乐课堂是偶像养成小游戏之一。

先由玩家选择导师、偶像和歌曲，然后开始播放音乐，在屏幕上显示一条随歌曲滚动播放的曲线，同时播放BGM和偶像演唱音频，此时玩家需要点击屏幕来保持音符位于曲线中间，否则偶像音准会偏高或者偏低，导致得分下降。最后根据得分进行结算。

声乐课堂的玩法入口界面如图：

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731045432977-3136b72d-aecb-4b2f-a105-df5211c33dc8.png)

声乐课堂的准备界面如图：![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731045496247-90cffbbd-7b4e-4c31-856c-5c88ca4f164f.png)

在这个界面可以选择导师、偶像、音乐。

玩法界面如图：

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731044865203-001f5c52-6c35-445f-9b7a-f35c660f283a.png)

# 二、结构设计
内容：

:::tips
1. 新增流程控制脚本
    1. Page_VocalTrain_Ctrl.lua，负责声乐课堂玩法的流程控制
2. 新增VM脚本
    1. VocalTrainVM.lua，负责声乐课堂玩法的数据管理和网络通信
3. 新增UI脚本
    1. UI_IdolTrain_Ctrl和UI_IdolTrain_Panel：玩法的总入口界面
    2. UI_VocalTrain_Ctrl和UI_VocalTrain_Panel：声乐课堂准备界面
    3. UI_VocalTeacher_Ctrl和UI_VocalTeacher_Panel:声乐课堂导师选择界面
    4. UI_VocalIdol_Ctrl和UI_VocalIdol_Panel:声乐课堂偶像选择界面
    5. UI_VocalMusic_Ctrl和UI_VocalMusic_Panel:声乐课堂音乐选择界面
    6. UI_VocalPlay_Ctrl和UI_VocalPlay_Panel:声乐课堂玩法界面
    7. UI_VocalResult_Ctrl和UI_VocalResult_Panel:声乐课堂结算界面
4. 使用的通用功能及组件
    1. 道具图标Icon：[通用道具组件使用文档 (yuque.com)](https://snh48group.yuque.com/lw0nsy/zeet2g/axzgdnh487gl3y12)
    2. 物品Tips：通过HintFacade.ShowItemTips(item_cfg_id)打开对应Tips界面
    3. 使用DanceFileManager.cs通过url下载歌曲。
    4. 使用Audio.lua播放音频文件。
    5. 使用DressActor.lua显示导师和玩家模型。
5. 资源管理
    1. 在Page_VocalTrain_Ctrl的Preload阶段加载导师模型，从四男四女中随机选择2男2女，退出玩法后删除模型。
    2. 在选择偶像时动态加载模型，缓存5个，超过的清除。
    3. 在点击开始训练后加载伴奏及偶像三个音准音频，返回准备界面或者退出玩法后删除。
    4. 音频文件加载时先判断本地是否有缓存文件，没有的再通过Url下载。
    5. 声乐课堂玩法默认场景Sce_vocalclass。

:::

# 三、详细结构设计
内容：

:::info
1. 音频文件的云端存储地址：[https://games-source.48.cn/vocal_data/配置音频文件名.ogg](https://games-source.48.cn/vocal_data/instrum_10101.ogg)
2. 音频播放策略
    1. 同时播放三首音乐：偶像正常音准音频、偶像偏高音准音频、偶像偏低音准音频。
    2. 同时只有一首音乐不静音，当球在曲线内时，正常音准音频不静音，其他两首音频静音；当球在曲线上方时，偏高音准音频不静音，其他两首音频静音；当球在曲线下方时，偏低音准音频不静音，其他两首音频静音。
3. 曲线播放策略
    1. 曲线的拼接：
        1. 两个曲线，后一个曲线应首尾反转，才能拼接上。![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731060388139-42b5780a-d122-4a85-9022-d37b3e8015f8.png)
        2. 曲线的层级结构如图：![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731060449464-69194193-6979-4993-949e-0ecf59f5723a.png)，母节点为曲线的遮罩（作用见下文），MoveRoot为曲线的移动节点，下面Curve1...为动态生成的曲线。
        3. 曲线的动态加载及回收：
            1. 默认先加载两个曲线。
            2. 当曲线一中点到达屏幕左边缘时，加载曲线三到曲线而右边。
            3. 当曲线一移出屏幕后，回收曲线一。
            4. 以此类推，循环加载
        4. 曲线需要根据当前播放状态改变颜色，如图![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731061841952-0818d300-b8b2-4630-b205-c0db3f496ba7.png)
            1. 播放完毕的显示深蓝色![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731061852330-d6c7f2b9-2e9e-4d5c-a840-9eec80f8093b.png)
            2. 正在播放且小球在正确位置的，显示浅蓝色![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731061860183-d3a8ed98-4252-452f-b004-90997ba85429.png)
            3. 正在播放且小球在错误位置的，显示红色![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731061885975-a8cbc28e-6a36-494e-b13f-c26246d3a71c.png)
            4. 还未播放的显示黄色![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731061901071-d0517d78-acec-4efd-b4c2-ffababb94fc9.png)
            5. 为了达成效果，需要同时播放四条不同颜色的曲线，用RectMask2D进行遮罩
            6. 层级如图![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731062088786-97d63d97-9f79-4af0-bf6d-5ed9743f1bf6.png)
            7. 遮罩范围如图![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731062258436-2e3865fc-d97b-4cad-8790-ea40a36f32a8.png)
            8. 中间Playing曲线，根据当前小球所在的位置正确与否，实时切换PlayingCorrect或PlayingWrong
    2. 小球的播放逻辑
        1. 小球的运动
            1. 当玩家不按屏幕时，小球匀速下落，最低不超过下屏幕。
            2. 当玩家按住屏幕时，小球匀速上升，最高不超过上屏幕
        2. 小球的位置判断
            1. 小球的判定点为上下顶点（均为空物体），当这两个点超出范围外则判定为音调偏离。（不使用小球图片本身边缘判断的原因是这样可以灵活调整边缘判定）![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731309354093-b83a3637-d942-439c-afd4-d54d27e0b677.png)
            2. 在Update中将判定点的坐标转为屏幕坐标，根据该坐标通过曲线图片的GetPixed()获取该位置的alpha值，不为0则在曲线内。
4. 类的依赖关系及重要方法![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731378631359-53db0f1b-347b-44ee-82bf-2b0687ce2b9d.png)

:::



# 四、流程设计
界面时序图：![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1731378987700-bc360b50-883a-479b-81e5-71f1221214ab.png)



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

