# 一.简介
该文档为鹦鹉团登录系统设计方案，登录过程包含了更新检测、SDK登录、账号注册登录等必要游戏启动流程，并展示游戏公告、用户协议、隐私政策、适龄提示、合规信息等相关内容，在登录成功并选择区服成功后，点击开始游戏进入创建角色或者进入游戏流程。

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721120310324-2da7181d-b754-4f68-b2c0-6ec3a61f0193.png?x-oss-process=image%2Fformat%2Cwebp)

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721371193208-6745969c-58b2-4ebe-8b73-3089ae04b95b.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1012%2Climit_0)

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721372077506-df47ee69-74a5-4110-bc63-19862c561390.png?x-oss-process=image%2Fformat%2Cwebp)

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721386102408-8c6432e7-e095-420c-ac83-ec58e7b9dd15.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1012%2Climit_0)

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721791205349-a17b354c-3112-4e0a-b7db-3cf99866f527.png?x-oss-process=image%2Fformat%2Cwebp)

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1721115843467-c4849196-9eff-44d9-9015-09404ea9fa26.png?x-oss-process=image%2Fformat%2Cwebp)





# 二.结构设计
+ **新增c#，**
+ **处理游戏启动到登录过程的逻辑**
    - **UILogoPanel.cs，**用来处理闪屏界面显示
    - **UICheckUpdatePanel.cs，**用来处理热更新界面显示
    - **UIForceUpdatePanel.cs，**用来处理整包更新逻辑
    - **UIPlayVideoPanel.cs，**用来处理登陆背景视频
+ **SDK相关逻辑**
    - **Meta48SDKMgr.cs，**处理sdk相关逻辑
+ **新增Lua脚本概述**

**1.新增界面相关脚本：**

        * 用户协议和隐私集合弹框： 
        * **UI_AgreementCollection_Ctrl.lua**和**UI_AgreementCollection_Panel.lua**
        * 用户协议和隐私二次弹框（点击注册登陆按钮，未勾选同意协议时弹出）： 
        * **UI_AgreementConfirm_Ctrl.lua和UI_AgreementConfirm_Panel.lua**
        * 游戏公告界面:   
        *  **UI_Announcement_Ctrl.lua**和**UI_Announcement_Panel.lua**
        * 登陆主界面：
        *  **UI_Login_Ctrl.lua**和**UI_Login_Panel.lua**
        * 适龄提示弹框：
        * ** UI_AgeSuggestion_Ctrl.lua和UI_AgeSuggestion_Panel.lua**
        * 实名认证弹框：
        * ** UI_IDVerificate_Ctrl.lua和UI_IDVerificate_Panel.lua**

**2.新增VM相关脚本：**

        * **LoginVM.lua**，包含设置和载入玩家登陆账号数据
        * **注：**发送和接收服务器协议数据，以及协议返回后逻辑在C#中，包括**IdleState.cs，LoggedState.cs**等登陆状态和流程管理沿用框架里的功能

       **3.新增SDK脚本:**

        * **SDKMgr.lua**，处理服务器信息，公告，隐私政策，版本号等



# 三.详细结构设计
**1.本地缓存登陆历史数据**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/44314719/1722307507643-094025d8-f6b1-4c7d-b01a-6bab4eda33e4.jpeg)

**2.本地缓存公告数据，登录流程结束清理**

+ 本地缓存公告数据（维护公告，活动公告，更新公告），目前服务器只支持纯文本

**3.类的依赖关系及重要方法。**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/44314719/1722324178230-179816d7-9d95-4402-8e3e-55f51b28e671.jpeg)

# 四.流程设计
**游戏启动:**

GameEntry.cs 

1、Managers，Camera，GlobalSetting初始化

2、LoadVersion，载入本地版本号  

LaunchMgr.cs 

StartUp()

1、sdk初始化

2、切换场景

3、加载支持多语言

4、加载视频显示

5、显示检测更新界面

6、下载配置文件

7、强更检测

8、热更检测

9、进入登录流程StepEnterLogin()

StepEnterLogin()

1、关闭检测更新界面

2、设置项目中资源管理器实例

4、各管理器初始化

5、预加载基础Bundle和Lua

6、敏感词初始化

7、多语言初始化

8、LoadVersion() //载入本地版本号

9、执行Lua.CallAction("Main.Main")//入口脚本

10、执行Lua.CallAction("Main.ShowLogin");//显示SDK登录窗口

11、lua调用C#loginMgr:OnLoginUIShow()

LaunchMgr.Inst.Finish();//启动流程结束

SDKManager.Inst.Login();//拉起SDK进行登录操作

**NoSDK登录流程：**

1、UI_LoginBox_Ctrl.lua //点击登录

2、loginMgr.cs //SDK登录成功

3、IdleState.cs.Login()

4、调用lua，CallLuaFunction("AccountLoginOk");

5、SDK登录成功，界面刷新

**进入游戏流程：**

1、UI_Login_Ctrl.lua//进入游戏

2、LoggedState.cs//发送登录协议

  ** (粗体参数必填，细体暂时不关注，后续看需求)**

    2.1  **STSLoginReq**(获取排队信息)

协议参数：**<font style="color:#000000;">nSDKID(分区号zoneid)，szAccountID(账号)，szVersion(版本号)， szGameUserID(openid)，</font>**<font style="color:#000000;">szDeviceID，szChannel，szPackageChannel，nPlatform，szPlayerSignature，nTimeTick</font>

协议返回：**<font style="color:#000000;">nNeedQueue（是否需要排队），LoginQueueInfo（排队信息，包含排队人数，预计排队时           间）</font>**

    2.2  **STSLoginNoti**（进入游戏通知）

协议返回：**<font style="color:#000000;">nServerTime（服务器时间，开始发送心跳）</font>**

    2.3  **ADBGetAccountInfoReq**（获取角色信息）

       协议参数：**<font style="color:#000000;">nZoneID(服务器ID)， szAccountID(账号)</font>**

协议返回：**<font style="color:#000000;">stRolePublicInfo（角色通用信息，值为空或roleid为0，则为新号，否则为老号），RolePrivateInfo（角色私有信息），AvatarInfo（Avatar信息），RoleBufferInfo（Buff信息），</font>**<font style="color:#000000;">recharge（未用），guild_id（未用），guild_name（未用），ban_play（未用）online（未用）</font>

    2.4  **STSEnterGameReq**（获取频道信息, 进入游戏）

协议参数：**<font style="color:#000000;">nSDKID(分区号zoneid)，szVersion(版本号)，szGameUserID(openid)， nRoleID  ， nLevel  ， nAge</font>****<font style="color:#DF2A3F;"> </font>****<font style="color:#000000;"> ，</font>**<font style="color:#000000;">nProvice，szDeviceID，szChannel，szPackageChannel，nPlatform</font>

协议返回：**<font style="color:#000000;">szChannelName（聊天渠道），nChannelID（聊天渠道ID）</font>**<font style="color:#000000;">，nRoleID（未用），                       szBanReason（未用）nBanEndTime（未用）</font>

流程图如下：

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/44314719/1722311166693-7d647578-657a-4a91-bc4a-cffd9f4d7c65.jpeg)

# 五.问题
1.公告图文混排格式，后续逐步实现

2.Jenkins打包、发布、部署不熟悉，还要进一步了解



## 
  
 

