# 一、简介
游玩界面：

![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740463060285-1638665d-b2ac-4c77-bf31-d0e10a19f396.png)

键雨玩法在界面自上到下显示六条轨道。

开始播放舞蹈和音乐后，按键会从区域上边出现并下落到判定区域。

按键一共有两种类型：

    1. 单键：![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740463561220-bfc5ce9b-ccf3-423a-b3fa-b897f6bf7855.png)到达判定区域后，按下对应按键即可。
    2. 长键：![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740463600686-60bf5930-528a-423c-b66e-1bf771dce0b5.png)长键后拖着一条直线，需要在开头的键处按下，直到直线结束松开按键。长键有一种特殊的形式：![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740463647221-e5a489d4-0054-4b80-bda3-264c5e0592f2.png)，此长键覆盖三条轨道，可以在任意轨道按下，并在判定期间滑动到其他两个轨道。

# 二、结构设计
:::info
1. **新增流程控制脚本**
    1. KeyFallingDanceMode.lua，用来控制整个键雨玩法的流程。
2. **新增界面相关脚本**
    1. UI_DanceKeyFallingMode_Ctrl.lua和UI_DanceKeyFallingMode_Panel.lua，作为键雨玩法的游玩UI。
3. **新增VM脚本**
    1. DanceKeyFallingVM.lua，用来存储键雨玩法游玩过程中的数据，并提供获取数据的接口

:::



# 三、详细结构设计
:::info
1. **键雨玩法谱面结构**

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1722252345720-04439285-6a5f-40fc-b498-2a03f68f96ca.png)



    1. id：从1开始依次递增，不可重复
    2. time：按键按下时机，按键出现的时机为time-800毫秒（800毫秒走配置）。
    3. type：1：单点； 2：长按；
    4. key：
            + 0：showtime
            + 1：左 宽长键
            + 2、3、4、5、6、7：对应屏幕从左到右六条轨道
            + 8：右 宽长键
    5. parameter：长按（type=2）时，记录长按的毫秒数。
2. **类的依赖关系及重要方法**

![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740464359063-efc4151d-92a5-4cb3-ad09-d555a8a16c41.png)

:::



# 四、流程设计
1. **界面时序图：**
    1. ![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740464420207-d935c664-8bd0-4d8c-acfc-7f1671710cb7.png)
2. **按键结构：**
    1. 单键：![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1722250120429-a8200cac-bdb2-4d0e-bee5-97de6716fb47.png)单个按键，显示一张Sprite，另外有一个特效挂点。
    2. 长键：![](https://cdn.nlark.com/yuque/0/2025/png/35004992/1740465092699-e1c68cf7-68de-4ae4-a836-2a8982debb4d.png)由一个单键及一个line连线组成。
3. **按键的移动**

每个按键提前800毫秒（可配置）出现，按一定速度移向判定区域。根据移动时间与总时间的比例计算按键的大小，实现透视效果。

4. **手机端和PC端的区别**
    1. PC端六条轨道对应按键：SDF JKL。
    2. 手机端直接点击轨道。
5. **判定结果：**
    1. 六种判定结果miss、cool、great、perfect、sperfect、sperfectplus。判定时间区域配表。
    2. sperfectplus比sperfect判定更难，显示都为SPerfect，用颜色区分。
6. **音效播放**
    1. 一共四种点击音效
        1. auKeyFallingClick：点击按键触发。
        2. auKeyFallingLong：按住长键连线时触发，循环，松开手指或按键后停止。
        3. auKeyFallingMiss：按失按键时触发。
7. **计分**

音符基础分值：

| <font style="color:rgb(0,0,0);">难度等级</font> | <font style="color:rgb(0,0,0);">基础分值</font> |
| :---: | :---: |
| <font style="color:rgb(0,0,0);">短键</font> | <font style="color:rgb(0,0,0);">1000</font> |
| <font style="color:rgb(0,0,0);">长键</font> | <font style="color:rgb(0,0,0);">1000</font> |


判定倍率：

| <font style="color:rgb(0,0,0);">打击结果</font> | <font style="color:rgb(0,0,0);">判定倍率</font> |
| :---: | :---: |
| <font style="color:rgb(0,0,0);">遗憾</font> | <font style="color:rgb(0,0,0);">0</font> |
| <font style="color:rgb(0,0,0);">很棒</font> | <font style="color:rgb(0,0,0);">1</font> |
| <font style="color:rgb(0,0,0);">优秀</font> | <font style="color:rgb(0,0,0);">1.1</font> |
| <font style="color:rgb(0,0,0);">完美</font> | <font style="color:rgb(0,0,0);">1.2</font> |
| <font style="color:rgb(0,0,0);">超完美</font> | <font style="color:rgb(0,0,0);">1.3</font> |
| <font style="color:rgb(0,0,0);">超完美+</font> | <font style="color:rgb(0,0,0);">1.3</font> |


连击倍率：

| <font style="color:rgb(0,0,0);">连击数（含）</font> | 连击倍率 |
| :---: | :---: |
| <font style="color:rgb(0,0,0);">1-49</font> | <font style="color:rgb(0,0,0);">1.0</font> |
| <font style="color:rgb(0,0,0);">50-99</font> | <font style="color:rgb(0,0,0);">1.1</font> |
| <font style="color:rgb(0,0,0);">100-199</font> | <font style="color:rgb(0,0,0);">1.2</font> |
| <font style="color:rgb(0,0,0);">200-499</font> | <font style="color:rgb(0,0,0);">1.5</font> |
| <font style="color:rgb(0,0,0);">500-999</font> | <font style="color:rgb(0,0,0);">2.0</font> |
| <font style="color:rgb(0,0,0);">1000及以上</font> | <font style="color:rgb(0,0,0);">2.5</font> |


    1. 单次实际得分=音符基础分值 * 判定倍率 * 连击倍率
    2. 实际总分=所有单次得分相加
    3. 最终显示总分：所有歌曲的总分是1000000分，需要将上一步计算出的总分通过公式：**显示总分=（总分/满分）*1000000**计算出最终得分。所有界面上显示的是最终显示总分。
    4. 超完美+得分：在超完美之上还有一个超完美+的判定，除了按超完美判定计入实际总分外，在计算完最终显示总分之后，还需要再加上一次超完美得分，使显示总分上限突破1000000分。
8. **结算评价规则：**

| <font style="color:rgb(0,0,0);">得分占比（含）</font> | 评价 |
| :---: | :---: |
| <font style="color:rgb(0,0,0);">95%</font> | <font style="color:rgb(0,0,0);">优+(SSS)</font> |
| <font style="color:rgb(0,0,0);">90%</font> | <font style="color:rgb(0,0,0);">优(SS)</font> |
| <font style="color:rgb(0,0,0);">80%</font> | <font style="color:rgb(0,0,0);">优-(S)</font> |
| <font style="color:rgb(0,0,0);">65%</font> | <font style="color:rgb(0,0,0);">良+(A)</font> |
| <font style="color:rgb(0,0,0);">50%</font> | <font style="color:rgb(0,0,0);">良(B)</font> |


9. **判定失败时角色播放失败动画**

在播放失败动画期间再次判定失败，不会打断当前动画的播放。

---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

