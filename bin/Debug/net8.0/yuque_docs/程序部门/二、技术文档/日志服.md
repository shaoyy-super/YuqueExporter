![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176647375-f5f1a215-8098-4e0e-89c7-01600a4c776d.png)

### 机器初始化
参考[thoughts 文档](https://thoughts.teambition.com/workspaces/5dfb64dfdd03ff001360619e/docs/5dfdbb0ae8307b00012b8809)

### 准备基础环境
```shell
apt install -y supervisor
sed -i -e '/minfds/s/1024/65536/' -i -e '/minprocs/s/200/1024/' /etc/supervisord.conf
systemctl enable supervisord
systemctl start supervisord
mkdir /data/elkdata/{logs,data} -p
useradd elastic
chown -R elastic.elastic /data/elkdata
echo "vm.max_map_count=262144" >> /etc/sysctl.conf
sysctl -p
```

### 安装JDK
+ 安装

```shell
sudo apt install default-jdk
```

+ 检查版本

```shell
java -version
```

### 安装Elasticsearch
+ 安装

```lua
su - elastic
tar xf  elasticsearch-7.2.0-linux-x86_64.tar.gz
```

+ 修改配置

```lua
cd elasticsearch-7.2.0/config
vim elasticsearch.yml 
#####
path.data: /data/elkdata/data
path.logs: /data/elkdata/logs
network.host: 0.0.0.0
http.port: 9200
discovery.type: single-node
#####

vim jvm.options #java虚拟机的内存设置，建议为机器内存的一半
####
-Xms8g
-Xmx8g
####

注:8.0以上的版本默认开启了https,可以把配置关闭否则logstash连不上
```

+ 创建supervisor管理文件

```lua
vim /etc/supervisord.d/elastic.ini 
[program:elasticsearch]
command=/data/elk/elasticsearch-7.2.0/bin/elasticsearch
directory=/data/elk/elasticsearch-7.2.0   
autostart=true                
autorestart=true              
minfds=65536
startsecs=10                  
startretries=3               
exitcodes=0,2               
stopsignal=TERM               
stopwaitsecs=10               
user=elastic                  
redirect_stderr=true          
stdout_logfile=/data/elk/elasticsearch-7.2.0/logs/elasticsearch.log
stdout_logfile_maxbytes=10MB   
stdout_logfile_backups=10     
stdout_capture_maxbytes=1MB   
stdout_events_enabled=false   
stderr_logfile=/data/elk/elasticsearch-7.2.0/logs/error.log        
stderr_logfile_maxbytes=10MB   
stderr_logfile_backups=10        
```

+ 启动

```shell
supervisorctl update ## 新增配置文件后，自动加载新配置
supervisorctl start elasticsearch

```

+ 设置密码

```shell
su - elastic
cd elasticsearch-7.2.0
./bin/elasticsearch-setup-passwords  interactive

#重置密码
./bin/elasticsearch-reset-password -u elastic
```

### 安装Logstash
+ 安装

```lua
su - elastic
tar xf logstash-7.2.0.tar.gz
```

+ 日志处理相关配置

```lua
mkdir logstash-7.2.0/{confs,patterns}
echo "CESTR [\u2e00-\ufff5_a-zA-Z0-9]*" > logstash-7.2.0/patterns/patterns
#上传配置文件至logstash-7.2.0/confs目录下（见附件）
mv logstash-7.2.0/confs/logstash1.conf  logstash-7.2.0/confs/logstash.conf
##日志处理相关配置 
#替换密码
user => "elastic"
password => "changeme"
#如需将日志导入数数平台（TA），需添加对应渠道的产品的appid,并且需要安装相关插件
#如：
thinkingdata {
	url => "https://receiver-thinkingdata.longame.cn/logbus
	appid => "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}
#安装插件
 /data/elk/logstash-7.2.0/bin/logstash-plugin install logstash-output-thinkingdata
```

+ logstash工具相关配置

```lua
#日志数据改为存盘，防止数据堆积
vim /data/elk/logstash-7.2.0/config/logstash.yml
####
queue.type: persisted
####
#开启监控
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch.username: elastic
xpack.monitoring.elasticsearch.password: ESPASSWORD  #更改为es的密码
xpack.monitoring.elasticsearch.hosts: ["http://127.0.0.1:9200"]
xpack.monitoring.collection.interval: 10s
xpack.monitoring.collection.pipeline.details.enabled: true
```

+ 创建supervisor的管理文件

```lua
vim /etc/supervisord.d/logstash.ini 
[program:logstash]
command=/data/elk/logstash-7.2.0/bin/logstash -f confs/logstash_sample.conf
directory=/data/elk/logstash-7.2.0
autostart=true                
autorestart=true              
startsecs=10                  
startretries=3               
exitcodes=0,2               
stopsignal=TERM               
stopwaitsecs=10               
user=elastic                  
;redirect_stderr=true          
;stdout_logfile=/data/elk/elasticsearch-7.2.0        
;stdout_logfile_maxbytes=1MB   
;stdout_logfile_backups=10     
;stdout_capture_maxbytes=1MB   
;stdout_events_enabled=false   
;stderr_logfile=/a/path        
;stderr_logfile_maxbytes=1MB   
;stderr_logfile_backups=10
```

+ 启动

```lua
supervisorctl start logstash
```

### 安装kibana
+ 安装

```shell
su - elastic
tar xf kibana-7.2.0-linux-x86_64.tar.gz
mkdir kibana-7.2.0-linux-x86_64/logs
```

+ 修改配置

```lua
vim kibana-7.2.0-linux-x86_64/config/kibana.yml
#####
host: "0.0.0.0"
server.basePath: "/log"
#####
```

+ 创建supervisor管理文件

```lua
vim /etc/supervisord.d/kibana.ini
[program:kibana]
command=/data/elk/kibana-7.2.0-linux-x86_64/bin/kibana 
directory=/data/elk/kibana-7.2.0-linux-x86_64
autostart=true                
autorestart=true              
startsecs=10                  
startretries=3               
exitcodes=0,2               
stopsignal=QUIT               
stopwaitsecs=10               
user=elastic                  
redirect_stderr=true          
stdout_logfile=/data/elk/kibana-7.2.0-linux-x86_64/logs/kibana_out.log
stdout_logfile_maxbytes=10MB   
stdout_logfile_backups=10     
stdout_capture_maxbytes=1MB   
stderr_logfile=/data/elk/kibana-7.2.0-linux-x86_64/logs/kibana_err.log        
stderr_logfile_maxbytes=10MB   
stderr_logfile_backups=10  
```

+ 启动

```lua
supervisorctl start  kibana
```

配置token

```lua
bin/elasticsearch-create-enrollment-token -s kibana
```

