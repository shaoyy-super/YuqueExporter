# 一、简介
商城系统的功能如下：

1. 根据分类展示各种类型服装及道具

![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1728630413346-5a29bd03-1b80-4958-bea9-ae21e0611065.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)

2. 展示玩家角色的模型及当前的穿着，并且可以通过点击商城内的服装进行换装。
3. 长按道具图标后，显示对应的道具详情弹窗，可以查看道具的获取途径。
4. 在商城界面可以对角色模型进行旋转缩放等操作。
5. 点击商城界面角色模型旁边的预览按钮，可以打开预览界面，在这个界面可以切换单人或者双人的展示。如果最后一个装备的服装是套装的一部分，可以切换展示整个套装。
6. 当前角色试穿的服装将加入到购买列表，点击左下角的购买会弹出试穿购买界面，列出待购买物品供玩家购买。![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1721811002087-de4fc290-bd1b-4138-a22f-51dce7108aaa.png?x-oss-process=image%2Fformat%2Cwebp)
7. 可以将物品加入购物车，点击购物车按钮后打开购物车列表供玩家购买。界面同试穿购买。
8. 可以单件购买物品。单件购买的界面分两种，
    1. 服装购买![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1722245822828-9e3ddb1e-3f93-442c-b78a-625735a03d0f.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)
    2. 物品购买![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1721811026168-77d6be04-d524-4714-9a0a-93c78cc8122c.png?x-oss-process=image%2Fformat%2Cwebp)
9. 购买后弹出通用物品获得界面。![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1721034511305-92afb180-6bab-4834-b7cb-dfee159abce5.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)



# 二、结构设计
内容：

:::info
1. **新增流程控制脚本**
    1. Page_Shop_Ctrl，负责商城系统的跳转管理及角色管理。
2. **新增VM脚本**
    1. ShopVM，负责商城数据的管理及服务器协议的收发。
    2. ActorVM，C#端换装缓存ActorCacheMgr从这里注册获取换装数据的回调。
3. **新增UI脚本**
    1. UI_Shop_Ctrl和UI_Shop_Panel，负责商城的显示逻辑
    2. UI_Shop_Item，负责商城系统中单个物品的显示逻辑
    3. UI_BuyItem_Ctrl和UI_BuyItem_Panel，负责单个道具购买的显示逻辑
    4. UI_BuyCloth_Ctrl和UI_BuyCloth_Panel，负责单件衣服购买的显示逻辑
    5. UI_ReceiveItem_Ctrl和UI_ReceiveItem_Panel，负责通用物品获得的显示逻辑
4. **使用通用功能及组件**
    1. 道具图标Icon：[通用道具组件使用文档 (yuque.com)](https://snh48group.yuque.com/lw0nsy/zeet2g/axzgdnh487gl3y12)
    2. 物品Tips：通过HintFacade.ShowItemTips(item_cfg_id)打开对应Tips界面
    3. 道具获取途径Tips：UI_ItemGainWay
    4. 服装预览：UI_ClothPreview
5. **产出通用功能及组件**
    1. 单件道具购买，对应脚本UI_BuyItem_Ctrl和UI_BuyItem_Panel![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1721811026168-77d6be04-d524-4714-9a0a-93c78cc8122c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)显示单个道具信息，提供购买数量选择，参数goods_info对应数据类型GoodsInfo，参数mall_type对应当前商城的类型![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728961113092-2f6f31ce-711d-453a-b001-e9c32f2153f0.png)
    2. 单件服装购买，对应脚本UI_BuyCloth_Ctrl和UI_BuyCloth_Panel![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1722245822828-9e3ddb1e-3f93-442c-b78a-625735a03d0f.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0%2Fresize%2Cw_1125%2Climit_0)显示单个服装信息，提供服装有效期选择，参数goods_info对应数据类型GoodsInfo，参数mall_type对应当前商城的类型![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728961129697-9aaad366-3859-4b33-9fef-94af61a37aa0.png)
    3. 物品获得展示，对应脚本UI_ReceiveItem_Ctrl和UI_ReceiveItem_Panel![](https://cdn.nlark.com/yuque/0/2024/png/38390214/1721034511305-92afb180-6bab-4834-b7cb-dfee159abce5.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0%2Fresize%2Cw_1125%2Climit_0)传入参数为ItemUnit列表，可左右滑动或点击箭头向左\右移动一格。

:::



# 三、详细结构设计
内容：

:::info
1. **商城数据获取**
    1. 请求时机：第一次进入Page_Shop_Ctrl时请求服务器商品数据并缓存下来。
    2. 请求商品协议：IDBGetGoodsListReq
        1. 参数1：nRoleID，玩家ID
        2. 参数2：gender，玩家性别
        3. 参数3：arrCategory，货架类型
    3. 获取商品响应：IDBGetGoodsListResp
        1. 参数1：nErrorCode，错误码
        2. 参数2：nRoleID，玩家ID
        3. 参数3：gender，玩家性别
        4. 参数4：arrCategoryInfo，商品的分类信息，列表
2. **商品购买**
    1. 购买商品请求协议：IDBBuyReq
        1. 参数1：nRoleID，玩家ID
        2. 参数2：buyType，购买类型
        3. 参数3：arrGoodsInfo，购买的商品信息，列表
        4. 参数4：arrTickets，商城券，可以选择使用商城券打折购买，暂不开发
    2. 购买商品相应协议：IDBBuyResp
        1. 参数1：nErrorCode，错误码
        2. 参数2：nRoleID，玩家ID
        3. 参数3：arrItemUnit，购买到的物品列表，列表
3. **数据结构**
    1. CategoryInfo，商品的分类信息，包含分类类型及该类型下的商品列表![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728884292278-6175c523-c5b7-4db5-a9d1-f50a245cdc26.png)
    2. GoodsCategory，商品的货架类型![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728884410185-71754d91-887e-484d-b691-f94d592e04b1.png)
    3. GoodsInfo，单个商品数据![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728884449918-543d3a9c-ce3a-4f6f-9a23-320be6c1d458.png)
    4. GoodsPriceInfo，商品的售价信息![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728884492075-6d177f7b-b197-4d9b-ab6b-44f3222bc5e6.png)
    5. BuyType，商品购买方式![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728884547391-7ff09089-00a5-4ec4-b57b-0ce42668649a.png)
    6. MallType，商城类型![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728961179032-55f349d7-bbd6-4571-aec9-ba8e99ba5d3a.png)
4. **推荐搭配展示**
    1. 选中一件服装后，如果该服装有配套的套装，左边详细信息下方会显示套装内所有服装，点击可以试穿，如果该服装未购买，就加到试穿购买列表中，再次点击可以脱下![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728887658839-3c5a5bbc-fe3c-46d4-88de-722b6ed90d1c.png)
5. **类的依赖关系及重要方法**
    1. ![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728961463257-e274f836-b9d1-467d-a58a-0eec502e22f5.png)

:::

# 四、流程设计
1. 商城系统流程
    1. ![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1728957255568-404f319b-5c29-4e92-8a26-64627258867d.png)



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

