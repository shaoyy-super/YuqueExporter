# 一.简介
该文档为鹦鹉团【我的创作】模块设计方案，包含了音乐选择、作品创作、作品上传、作品分享等内容，是项目鹦鹉团UGC模块的最小闭环形态。

![](https://cdn.nlark.com/yuque/0/2024/png/46026893/1720674376462-fc0bde29-baa2-43cd-abea-1a221f9bf3ee.png)

# 二.结构设计
+ **新增脚本概述**

**1.新增Page_CreationPreview_Ctrl.lua脚本，用来作为【我的创作】预览功能入口的跳转管理。**

**2.新增界面相关脚本：**

        * 音乐选择界面： **UI_CreationSelect_Ctrl.lua**和**UI_CreationSelect_Panel.lua**
        * 作品设置界面:    **UI_CreationSetting_Ctrl.lua**和**UI_CreationSetting_Panel.lua**
        * 作品预览界面:    **UI_CreationPreview_Ctrl.lua**和**UI_CreationPreview_Panel.lua**
        * 作品上传界面： **UI_CreationUpLoad_Ctrl.lua**和**UI_CreationUpLoad_Panel.lua**
        * 分享界面：        **UI_CreationShare_Ctrl.lua**和**UI_CreationShare_Panel.lua**

**3.新增VM相关脚本：**

        * 音乐创作功能的VM：**CreationMainVM.lua**，包含作品创作数据存储，请求歌曲列表方法，请求增加本地曲目接口，请求调用AI接口(C#侧)，请求生成谱面函数接口。
        * 创作预览功能的VM：**CreationPreviewVM.lua**，包含请求数据打包Data(C#侧)，请求获取二维码数据(C#侧)。

       **4.新增全局函数调用脚本：**

        * 文件夹选择文件全局脚本：**OperateFolderFile.lua**，请求唤起选择mp3/ogg格式文件，请求唤起选择png格式文件，请求保存图片到本地相册相关

       **5.新增数据枚举类型脚本:**

        * 音乐选择类型定义脚本： **CreationMainDefine**，枚举类型OfficalMusic(官方)，localMusic(本地)，或通过配置获取定义。玩法枚举类型NormalPlay(传统玩法)，OtherPlay(流星玩法等).....。 难度枚举类型Easy(简单)，Normal(一般)，Hard(困难)，Master(大师)

**6.新增资源管理器类:**

        * 音乐选择资源管理器类：**CreationMainResMgr.lua**，用来存储在音乐选择时刻下载的Clip资源列表。
+ **文件目录概述**

![](https://cdn.nlark.com/yuque/0/2024/png/46026893/1720764363279-f15afb71-d33f-4888-bd19-dffb46020f49.png)

+ **界面资源加载和释放概述**

![](https://cdn.nlark.com/yuque/0/2024/png/46026893/1720764054849-86fa305e-a1ad-4019-967f-3a50ed2aa14c.png)

# 三.详细结构设计
**1.官方和本地曲目的数据结构**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1720691088254-e7d72d83-4518-4032-8e42-7d26e1284d35.jpeg)

**2.作品设置选择的难度和星级通过调用AI接口生成的BPM和舞步数据，根据策划规则通过难度和BPM生成谱面数据。**

+ 组合界面选择的数据CreationSettingData

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1720691087928-1e92cdc6-4710-4487-80a0-529c8c548268.jpeg)

+ 使用CreationSettingData+歌曲信息作为参数调用AI接口生成舞步数据DanceData(应该是一个json文件或json文件地址)。
+ 使用CreationSettingData+歌曲信息作为参数调用AI接口生成BPMData。
+ 使用BPMData根据策划规则生成谱面信息MSData(应是一个json文件或者json文件地址)。

**3.进入作品预览的参数数据结构**

+ 使用上一步生成的舞步数据DanceData和谱面数据MSData作为参数进入作品预览，调用进入传统玩法游玩入口。

**4.进入试玩界面的参数数据结构**

+ 使用上一步生成的舞步数据DanceData和谱面数据MSData作为参数进入试玩模式，调用进入传统玩法游玩入口。

**5.作品上传的数据结构**

+ 组合上传作品的数据结构UpLoadData

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1720670286439-2aa410bb-6b69-4e64-a60e-aea90d7e6b65.jpeg)

+ 将组合的数据UpLoadData使用PHP接口提交到腾讯云

**6.二维码获取以及保存至本地相册**

**7.类的依赖关系及重要方法。**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1721031127022-0b22706c-f444-4a44-9937-74623108b078.jpeg)

# 四.流程设计
**1.【我的创作】功能流程图：**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1720683159272-84826ed1-60e1-4a78-9974-1482fa7eec0d.jpeg)

**2.资源加载和保存:**

a.歌曲列表：通过请求服务器或者其他形式获取的歌曲列表SongDatas并缓存在**CreationMainVM**，确保重复打开界面不请求。进入预览情景的时候，卸载之前缓存的歌曲列表信息。

b.歌曲资源：选择某个歌曲信息后，缓存歌曲的信息SongData，并通过SongPath地址加载歌曲资源Clip并缓存在**CreationMainResMgr**，通过唯一ID缓存所有加载过的Clip，避免切歌重新下载，添加CatchCount数量，超过CatchCount则卸载最早的入栈歌曲资源。在退出【我的创作】系统后**CreationMainResMgr**的歌曲资源就全部卸载。

c.舞步/谱面/歌曲信息：根据SongData根据AI接口生成舞步数据DanceData缓存在**CreationMainVM，**根据AI接口生成BPMData缓存在**CreationMainVM，**根据规则生成的谱面信息**MSData缓存在CreationMainVM。**

d.预览情景资源：进入预览情景，卸载所有缓存的歌曲资源Clip，**UI_CreationPreview_Ctrl**脚本同时将**CreationMainVM**和**CreationPreviewVM**绑定到**UI_CreationPreview_Panel**，传递舞步/谱面/歌曲信息，在加载界面加载预览情景中的场景资源、角色资源，歌曲资源(clip)。

e.上传作品信息：临时获取封面Tex.Jpg，不缓存，根据舞步/谱面/歌曲组成数据UpLoadData，缓存在**CreationPreviewVM**，并提交到腾讯云。

f.二维码获取并保存本地：获取二维码临时数据Byte[]，生成二维码图片，截图作品的卡片信息常驻保存在本地相册。

**3.UGC音乐舞蹈流程说明**

[链接](https://snh48group.yuque.com/qim4en/ehdkuc/xqx9yuuw6plqrf0w)

# 五.问题
1.每次请求AI接口时间很长，要怎么处理。

