简介

本系统由三个界面组成，分别为战斗胜利时的人物宠物经验提升展示界面（下称胜利界面），胜利时的物品奖励界面（下称奖励界面）以及失败时的养成跳转界面（下称失败界面）

具体如下

胜利界面

![](https://cdn.nlark.com/yuque/0/2024/png/43733777/1721887657936-0fd6277b-da70-4d23-b6c4-dd0accb9faa6.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1078%2Climit_0)

奖励界面

![](https://cdn.nlark.com/yuque/0/2024/png/43733777/1721889757913-ea1e296e-1d50-4be8-a198-57f793625e6e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1073%2Climit_0)

失败界面

![](https://cdn.nlark.com/yuque/0/2024/png/43733777/1721889912466-f9e78641-9d88-4231-8591-f5d6bd4c3237.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1075%2Climit_0)

效果

[此处为语雀卡片，点击链接查看](https://www.yuque.com/lw0nsy/zeet2g/nxun5uw995anp9pb#hCuzB)

设计理念（框架）

![](https://cdn.nlark.com/yuque/0/2024/png/44684279/1722843696203-a9434be9-299f-47ba-9b6b-28803144b304.png)

考虑到后期的可扩展性，以及对于不同战斗的适配，决定采用在同一个界面上动态生成预制体的方式。

具体结构大致如下

![](https://cdn.nlark.com/yuque/0/2024/png/44684279/1722309130699-dda0c818-603d-4d38-a79f-ef5180815c85.png)

因此可以复用现有的UI_BattleResult_Panel，相关命名采用BattleResult

按照目前的需求，在可替换节点下目前可以生成3种不同的节点，均挂载C4L，名称暂定：UI_BattleExpResult，UI_BattleItemResult, UI_BattleCultivateResult

将上述三个（未来可能多个）可替换节点作为枚举注册，等待传入

需要一个存储GameObject和lua代码与 id的对应表

在OnShowUI时会读入1个数据，为param，此数据中需要包含三部分内容：

1. 胜利与否is_win
2. 可替换节点显示顺序，为名为id的table
3. 所有可替换节点需要的数据，为一个名为data的table，现阶段包含Exp（player_exp,pet_exp)和Item两方面

各函数功能

1. OnCreate：注册点击事件
2. OnShowUI: OnShowUI会显示显示id中第一位的可替换节点，通过一个叫LoadNode的函数加载此节点，会在其中改变胜利失败的显示文本内容并将当前显示页面的index设为1，（now_loading_index)
3. LoadNode：LoadNode将调用枚举对应节点的构造方法，并将data传入，预制体将自己读取所需数据，通过c4l:InstantiateAsset调用AssetHolder创建GO，并交给Ctrl构造方法创建lua代码实例,需要维护index_to_go index_to_lua两个表，以记录已经加载的方法，它会获取data中的cfg，读入一个表win_pages，对应BattleResult表中的内容
4. OnClickBg：将获取现在显示的可替换节点，并加载下一个节点，如果下一个节点不存在则回到主城或者再次挑战，加载下一个节点时删除上一个节点，当anim_flag等于true的时候按下则立刻将anim_flag设为true并
5. GetAnimState：返回所有页面下的动画是否有正在播放的
6. SetValue：传入Data，设置节点下所有的值
7. EndAnimAndSet：关掉所有正在播放的动画，并瞬间设置所有的值为最终值



胜利界面节点

![](https://cdn.nlark.com/yuque/0/2024/png/44684279/1722311395009-a6a86e67-d132-488c-bd20-bff7963ce675.png)

构造方法中调用显示数值对应内容即可，玩家等级和exp条使用UIExpBar

使用UIPrefabHelper加载宠物图标

1. Ctor：传入go，获取c4l，调用SetStartValue设置初始值和宠物头像
2. SetStartValue，设置宠物头像和初始值
3. SetValue，设置最终值，可以直接设置或者通过动画设置
4. GetAnimState，获取是否有正在播放的动画
5. StopTween, 停止所有动画播放，并设置为最终值



奖励界面节点

![](https://cdn.nlark.com/yuque/0/2024/png/44684279/1722311657738-772638fa-9d6e-4ffb-ae99-719eb8d7ca98.png)

基本同上，只是需要添加拉动条功能

1. Ctor：传入go，获取c4l
2. SetItems：采用UI_CommonReward的相关方法设置查表后获取到的item

失败界面节点

![](https://cdn.nlark.com/yuque/0/2024/png/44684279/1722311741940-c7c49ce9-2146-426a-b9c2-71ea5e4bec86.png)

1. Ctor：传入go，获取c4l绑定按钮事件
2. OnPetClick：响应绑定的按钮事件，跳转到对应的PetDevelop界面



UIExpBar

大致和UIHpBar相同，通过SetPercent设置值，可以选择是否需要缓动和是否需要回调函数

SetPercentMultipleTimes可以通过回调函数递归，实现连续的升级效果，传入次数times，每次最高值percent，是否需要缓动need_tween, 单次结束后的回调on_update,全部结束后的回调text_call_back









