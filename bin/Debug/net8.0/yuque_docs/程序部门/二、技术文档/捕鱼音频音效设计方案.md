一、简介

内容：游戏里实现场景音效与背景音乐的播放。

目的：捕鱼游戏系统里，音频与音效控制。实现声音播放控制需求。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731061674411-05ea7082-8005-415d-8bb0-72893ba91f76.png)

# 二、结构设计
内容：

:::tips
1. 用混音器分组实现多个层级控制音频播放优先级。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731033665902-0cf72b62-fa4f-47e5-948a-e90646ebb901.png)

:::

根据音效与音乐播放暂定分为5个等级组，并在Audio配置表里配置，用于决定待加入音轨类型。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731052120154-0339d85c-f721-42e9-8600-21655d6ead4d.png)



第一层级，优先级最低设置为场景背景音乐与场景背景环境音。

第二层级，Boss出场音乐，根据Boss类型加队列里逻辑控制。

第三层级，Boss结算加队列里逻辑控制。

第四层级，语音层级。（预留）

第五层级，UI界面层级，优先级最高。

AudioMgr层级为大层级，高优先级播放时，会屏低优先级音频播放。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731064893101-391a1848-7d63-4165-b6af-b9feefac978f.png)





目的：通过配置层级设置混音器中Audio Source Priority控制实现优先级的播放，控制声音播放优先级。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731048555833-f38f08bb-bbe9-422b-b739-80e2cbd87ec1.png)



音频大层级里，要求背景音乐与音效通过混音同时播放。背景音乐BGM,BossEnter,BossRecult层通过当前条件，实现背景音乐层级互斥播放。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731294822899-84466b7a-dd61-4b5d-a3cb-4486666d357f.png)





# 三、Boss背景音乐详细结构设计
内容：因为Boss出生背景音乐播放要求在Born和Run Tml中持续播放，结算音乐播放在die Tml前时机播放，所以Boss背景音乐和结算背景音乐拟在配置表配置，程序队列逻辑控制。

拟配置FishType表里添加入场背景音乐与结算音乐字段关联AudioConfig表。方便满足条件时程序调用。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731053901444-4eee9e25-4ca5-4ffd-bfb2-2b65a82bb8b6.png)

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731054010392-8524d28a-222c-4c32-b8d4-c4df351913a6.png)

:::info
1. 管理器控制配置音效的播放，暂停与停止，优先级控制。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731048348278-34a8debe-e0a5-4bb2-8519-0718aa903f88.png)

2. 因为Boss和结算有优先级控制并互斥播放，队列控制Boss背景音乐或结算背景音乐播放。Boss入场音乐优先级类型由FishAttr表Boss类型取得。Boss入场根据渔场中鱼唯一id进入当前Boss队列逻辑，并与当前播放优先级比较，如高于当前播放等级，停止当前背景音乐播放等级，改为播放现背景音乐，并刷新当前背景音乐播放等级。鱼离开时调用BossLeave方法从当前队列中移除，如果当前移除播放鱼背景音乐为当前队列最高播放等级播放中，从队列中取出次高播放等级的鱼背景音乐恢复播放。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731059288451-3a879f79-0584-42d1-b886-3a614a24327a.png)

AudioBossMgr中调用AudioMgr的Play,Pause,UnPause,Stop接口方法。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731052631656-458f797e-3056-4741-926d-a82c2411d3d3.png)在OnFishenter方法里，如果是Boss等级，调用AudioBossMgr的BossEnter方法判定是否是当前最高等级背景音乐，执行是否播放逻辑。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731053585804-4523628d-3cc4-4a35-98fa-a2fec56f1070.png)在Destroy方法里，如果是Boss等级，如果当前是4级Boss并在队列中，从队列中移除。调用AudioBossMgr的BossLevae方法查找队列里是否还有未离场4级Boss，有的话继续播放4级Boss背景音乐。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731053068641-5b114ba4-5f64-49fb-be13-53475d295aca.png)在CallCSFishDie方法里，进入结算音乐判定，如果当前播放是4级Boss背景音乐，并还不在队列中，4级Boss音乐入队列。当结算音乐是最高等级背景音乐时播放结算音乐。

:::

Tml Boss入场音效需求目前是播放一次后结束，不做程序里控制逻辑操作。如需根据Boss优先级设置Priority,可在Tml里直接设置引用Audio Source的优先级。

![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731049686545-7da67ae1-b248-49fc-8e6c-7e530c7b9bb1.png)

目的：

:::info
1. 大层级控制整体层级播放优先级。
2. 同一层级中，AudioBossMgr逻辑控制Boss入场背景音乐优先级。

:::



# 四、流程设计
![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731304016800-2323f881-e636-4a40-b6dd-303a94454a78.png)



![](https://cdn.nlark.com/yuque/0/2024/png/43734381/1731309514230-8755d3f5-c7c0-45c4-a3b8-9641c88831c4.png)



# 五、提出问题
是否鱼消除后或者当前背景音乐播放完成后判定恢复低优先级背景音乐播放。



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

