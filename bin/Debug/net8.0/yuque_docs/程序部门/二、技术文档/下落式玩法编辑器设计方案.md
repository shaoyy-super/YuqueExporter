# 一、简介
下落式玩法编辑器是一套可视化的工具和界面，能帮助音乐制作人、音乐爱好者等用户直观地设计和调整下落式玩法的按键、动作等功能，使其更加高效、便捷地创建和编辑游戏谱面。

主要功能如下![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1733982394042-169c5843-a347-4a98-8c40-01884b2c37c2.png)

主界面如图![](https://cdn.nlark.com/yuque/0/2024/png/44683805/1728547081387-8ff4b386-bd17-4c83-9ccf-8c7cb72f535a.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)

左边展示歌曲信息和提供预览，右边为按键编辑区域。



# 二、结构设计
内容：

:::tips
1. **新增流程控制脚本**
    1. Page_FloatDownEditor_Ctrl，控制整个编辑器流程
2. **新增UI脚本**
    1. UI_FloatDownEditor_Ctrl和UI_FloatDownEditor_Panel，负责编辑器UI显示
    2. UI_FloatDownEditorPreview_Ctrl和UI_FloatDownEditorPreview_Panel，负责预览UI功能
    3. UI_FloatDownEditorBeatMap_Ctrl和UI_FloatDownEditorBeatMap_Panel，负责音符编辑UI功能
3. **新增按键控制脚本**
    1. UI_FloatDownEditorSingleKeyItem，负责单音符的逻辑
    2. UI_FloatDownEditorLongKeyItem，负责长音符的逻辑
4. **新增轨道小节显示脚本**
    1. UI_FloatDownEditorBeatItem，负责在轨道中显示每小节分割线
5. **新增VM脚本**
    1. FloatDownEditorVM，负责整个编辑器流程的数据存储及服务器通讯

:::



# 三、详细结构设计
:::info
1. **歌曲信息获取**
    1. 按照游戏流程，需要先选中歌曲才能进行谱面编辑，所以当前选中歌曲信息可以通过UGCMainVM:GetSelectUGCCreationData()获取。
    2. 获取信息包括：作品名、BPM、舞步、当前谱面、歌曲Clip等
2. **预览功能实现**
    1. 加载默认舞台场景和默认角色，通过RenderTexture显示到预览区
    2. 全屏预览通过放大RenderTexture实现
    3. 如果有舞蹈动作，播放舞蹈动作，否则播放角色待机动作
    4. 根据当前时间推算音符出现的位置
    5. 预览界面只能显示，无法进行游玩，判定时播放完美判定。
3. **音符编辑区域**
    1. **音符轨道显示**
        1. 轨道长度计算：总长度=总节拍数*每节拍像素长度*缩放
        2. 总节拍数=音乐长度（秒）/每节拍长度（秒）
        3. 每节拍长度=60 / bpm
        4. 缩放：通过点击高级设置中的加减按钮，调整缩放值，默认为1，每次点击加号缩放*2，点击减号缩放/2
        5. 使用UIScrollRect显示节拍分割线
            1. 子物体结构如图![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1733992080427-2e568edd-22cb-45de-bc54-63fed583206f.png)，显示如图![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1733992101792-4ce36ac4-3a68-4a33-8d55-873f5b5b4503.png)
            2. BeatLine为最上面横着的线，表示该节拍在轨道中结束点
            3. TrackGroup下根据当前选择的轨道数，当前版本默认4条轨道，后续需要支持动态修改，这里TrackLine根据轨道数动态生成。
            4. BeatItem宽度固定，长度=每节拍像素长度*缩放/每小节节拍数
            5. 每小节节拍数可以通过设置按钮动态调整，![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1733993274694-1ae3076d-651d-449b-9b4c-cf2651789d0e.png)
    2. **音符显示逻辑及其结构**
        1. **单音符：**![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734314279247-85794d7e-bfea-470f-8444-1bcf93a0eeae.png)，单个GameObject，Image组件显示图标，Button组件接收点击事件。
        2. **长音符：**![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734314327309-9abd65ec-95ea-4cd5-a66e-26a589a9a06d.png)，父节点同单音符，子节点Line使用LineRenderer绘制连线。
    3. **音符操作逻辑**
        1. **添加**，选中左边音符类型（单音符、长音符），点击轨道区域进行添加
            1. 通过BeatItem接收点击事件，获取点击的具体坐标点，通过事件通知UI绘制音符。
            2. **对齐至格线**：高级设置中，勾选对齐至格线，取鼠标点击位置下方最近小节线放置音符，否则取鼠标点击位置放置音符。
            3. 单音符添加规则：
                1. 无法放置于负数时间段
                2. 同一时间同一轨道只能放置一个
            4. 长音符点击轨道后放置第一个节点，然后进入绘制状态，点击其他位置会从第一个节点绘制连线到点击位置，直到点击单音符或多选按钮或鼠标中键，退出长音符绘制状态。
            5. 长音符的绘制规则：
                1. 首个音符放置规则同单音符
                2. 新节点无法放置在比最近节点更早的小节，比如![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734056066199-0bd77ee8-5a26-4f90-bd6f-78bf345bbebd.png)，新节点无法放置在红框及以下小节。
                3. 新节点如果与最近节点在同一小节，并且方向相反，则会删除最近节点，比如![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734055962208-174ffdfc-393d-4e65-8a58-fcc9e41976da.png)，如果新节点在第二小节第二轨道，则会变成这样![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734056011134-e009f9cc-0495-4980-8588-30b561e1a149.png)
        2. **删除**
            1. **单音符：**右键点击删除
            2. **长音符：**右键点击依次从最新节点开始删除
        3. **移动**
            1. **单音符：**拖拽
            2. **长音符：**拖拽首个音符
        4. **多选**
            1. 点击多选按钮，进入框选状态，按住左键拖拽会显示蓝色框选区域，松开左键后，框选区域内的音符全部进入选择状态，之后可以使用鼠标或快捷键进行删除、复制、移动。
            2. 由于音符无法重叠，需要将复制的新音符进行偏移。
        5. **撤销**
            1. 使用栈存储操作步骤，撤销时依次从栈顶取出操作步骤进行还原。
        6. **恢复**
            1. 使用单独的栈存储撤销的步骤，恢复时依次从栈顶取出撤销步骤进行恢复。
        7. **暂存**
            1. 点击暂存按钮，将最新谱面保存到本地，下次进入该作品的谱面编辑，先检查是否有暂存谱面，优先加载。
        8. **完成**
            1. 点击完成按钮，提交最新谱面到服务器
            2. 通过CreationHttpManager.Inst.UploadFileToCos()将谱面json文件提交到云端。
            3. 提交完毕后调用CreationHttpManager.Inst.PostCreation()通知服务器更新作品状态。
4. **类的引用关系**

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734335989622-c1af79b4-98e0-4bf7-9b21-9b6957c184d2.png)

:::





# 四、流程设计
**时序图：**

![](https://cdn.nlark.com/yuque/0/2024/png/35004992/1734336535178-2199b231-5674-40a1-b6d0-c326d437a5d2.png)



# 五、提出问题
如果存在重点、难点问题的解决方案没想清楚，可提出问题在会上讨论



---

# 六、总结整理（开发完成后撰写）
开发过程中，很可能产生跟上面方案不一致的地方。可能补充了更多的细节内容，可能由于某些未想到的原因推翻了方案中的一些设定。

所有开发完成后有价值的内容，都可以记录在这里。

