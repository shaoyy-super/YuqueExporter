![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176935998-6a7c4a54-854f-4cae-b727-5623de0b11ea.png)

合服举例，以10,11,12,13合服，10区作为主服

### 关服
+ 关闭需要合并的服务器

salt 'dm-1' state.apply game.stop pillar='{"zone": "10"}'salt 'dm-1' state.apply game.stop pillar='{"zone": "11"}'salt 'dm-1' state.apply game.stop pillar='{"zone": "12"}'salt 'dm-1' state.apply game.stop pillar='{"zone": "13"}'

+ 备份数据库

salt 'dm-1' state.apply game.backupdb pillar='{"zone": "10"}'salt 'dm-1' state.apply game.backupdb pillar='{"zone": "11"}'salt 'dm-1' state.apply game.backupdb pillar='{"zone": "12"}'salt 'dm-1' state.apply game.backupdb pillar='{"zone": "13"}'

### 合并数据
+ 登陆合服的主区，切换目录至/data/zones/dm10/merge/

su - dm10cd /data/zones/dm10/merge/

+ 执行合服命令（确保合服脚本是否为最新）

sh merge.sh -s 11@10.104.6.212 -t 10@10.104.131.214 -u root -p Dm2018Pwd123

sh merge.sh -s 12@10.104.6.212 -t 10@10.104.131.214 -u root -p Dm2018Pwd123

sh merge.sh -s 13@10.104.6.212 -t 10@10.104.131.214 -u root -p Dm2018Pwd123

### 修改config配置
+ 切换目录至/data/zones/dm10/config
+ 编辑文件config.xml，修改conzones和zones段

vim config.xml

![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176936206-2e35ae74-a73e-4c37-971d-89d3bcf3bb5c.png)![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176936428-179d5b2c-fd9e-4625-a0e5-8f18ae7cb280.png)

### 修改入口
+ 使用dm用户登陆目录服，切换目录至/home/dm/ProjectDM/group/

su - dmcd /home/dm/ProjectDM/group/

+ 编辑server_list.json文件，将11,12,13区的入口，修改为10区的

vim server_list.json

![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176936733-f3678825-bf87-4596-a4d3-66b165f08e06.png)

### 关闭备份
+ 在目录服执行关闭被合区服的备份定时任务

salt '*' state.apply game.stop-backupdb pillar='{"zone": "11"}'salt '*' state.apply game.stop-backupdb pillar='{"zone": "12"}'salt '*' state.apply game.stop-backupdb pillar='{"zone": "13"}'

+ 注释目录服上pillar文件中被合区服的信息

### 启服
+ 登陆10区的服务器，切换至目录/data/zones/dm10

su - dm10cd  /data/zones/dm10

+ 执行启服命令

sh start.sh 4.0.10.102324 -m

+ 通知运营，合服完成，已对外。

