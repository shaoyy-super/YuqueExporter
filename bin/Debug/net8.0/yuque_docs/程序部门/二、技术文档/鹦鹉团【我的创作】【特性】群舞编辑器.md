# 一.简介
该文档为多人舞蹈编辑器策划案，用于制作人养成，给予玩家编排多人舞蹈的体验。本编辑器建立在导入的音乐有对应的AI生成舞步序列的基础之上，玩家导入歌曲，并在舞步序列基础上编辑多人舞蹈的阵型变化、灯光、镜头等等，初版只可编辑阵型变化，并选择预设开场。

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1728461330244-7e46c27b-2552-4469-b525-cc60c4e95931.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1406%2Climit_0)

# 二.结构设计
**脚本概述**

1.**数据管理**

+ ModuleDataVM，模组数据管理器，管理ModuleDataBase
+ ModuleDataBase，模组数据基类
+ <font style="color:rgb(51, 51, 51);">FormationModule</font>DataBase：ModuleDataBase，阵型数据类型基类
+ Nor<font style="color:rgb(51, 51, 51);">Formation</font>ModuleData：<font style="color:rgb(51, 51, 51);">FormModule</font>DataBase，普通阵型数据类型（待定）
+ Start<font style="color:rgb(51, 51, 51);">FormationModule</font>Data：<font style="color:rgb(51, 51, 51);">FormModule</font>DataBase，开场阵型数据类型（待定）



+ TrackDataVM，轨道管理器，管理TrackData。
+ TrackData，轨道数据脚本，管理CliptDataBase。
+ ClipDataBase，轨道片段数据，由TrackData管理。
+ <font style="color:rgb(51, 51, 51);">Formation</font>SlotClipData：ClipDataBase，阵型槽位片段数据



**2.时间管理**

+ TimeMgr，时间管理器，管理当前轨道时间，提供查询总时间等。

**3.界面管理**

+ WindowMgr界面总管理器脚本，管理所有界面，管理数据初始化，界面初始化/释放等等，以及用于编辑器的Tick。
+ <font style="color:rgb(51, 51, 51);">Formation</font>WinodowMgr：WindowMgr阵型界面总管理脚本
+ PanelBase界面基类。



+ <font style="color:rgb(51, 51, 51);">Formation</font>WindowPanel，编辑器整体界面，包含了退出，保存等功能。



+ <font style="color:rgb(51, 51, 51);">Formation</font>ModulePanel：PanelBase，模组界面，管理<font style="color:rgb(51, 51, 51);">Formation</font>ModuleItem
+ ItemBase：组件基类，包含拖拽基类功能
+ <font style="color:rgb(51, 51, 51);">Formation</font>ModuleItem：ItemBase，阵型模组组件。



+ TrackPanel，管理轨道界面脚本，管理TrackItem。
+ TrackItem，管理ClipItemBase。
+ ClipItemBase：ItemBase，clip组件基类
+ <font style="color:rgb(51, 51, 51);">FormationSlot</font>ClipItem：ClipItemBase，阵型片段组件



+ TrackBgPanel，管理轨道刻度线，滑动线等。
+ DragMgr，拖拽管理器

**4.创建工厂**

+ DataFactory，数据工厂，创建数据对象
+ ItemFactory，组件工厂，预制体组件创建

**5.指令管理器**

+ CommandMgr，指令管理器，指令存储，向前/后撤销的指令管理器。
+ ICommond，指令接口

**6.导出/入管理工具**

+ DataTool，管理数据读取和存储

**7.全局定义变量**

+ BeamEditorConst，编辑器的一些参数，缩放值，播放倍率，分割线数量等等。
+ BeamEditorDefine，枚举等

**8.音频播放管理**

+ AudioMgr，简单管理歌曲播放，场景的AudioSource。

**9.界面脚本**

+ UI_FormationEditor_Panel.lua，阵型界面Panel脚本
+ UI_FormationEditor_Control.lua，阵型界面Control脚本

**10.场景角色等管理脚本**

+ FormationStageMgr.lua，阵型编辑的舞台管理器类，包含舞台预制体，灯光、相机等
+ FormationActor.lua，阵型角色类
+ FormationActorMgr.lua，阵型的角色管理器，管理FormationActor
+ FormationData.lua，阵型槽位信息
+ FormationDataVM.lua，阵型信息数据管理，管理FormationSlotData，并可以用来判断当前时刻进入了哪一个阵型槽位
+ Page_FormationEditor_Ctrl.lua，阵型编辑的page，用来预加载/退出卸载等

**11.玩家操作的摄像机脚本**

+ CameraControlMgr**，**玩家操作的摄像机脚本





**文件目录概述**

**1.编辑器功能文件夹**

# 三.详细结构设计
**1.模组基类数据结构，模组子类可能包括，按键模组，动作模组，阵型模组等**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1728700509418-8d313151-8402-491d-ae44-0de4a41a360e.jpeg)

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1728729227765-1c8789c9-3ec7-4967-abe3-19075e24649f.jpeg)

FormationModuleDataBase : <font style="color:rgb(88, 90, 90);">ModuleDataBase</font>

ModuleDataVM管理ModuleDataBase。

**2.阵型槽位片段数据结构**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1728700932694-3b4603a6-f0c5-440c-b170-e2496254c5a7.jpeg)

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1729050314081-17d8a5c8-f06c-4861-8121-80a302e6e2c8.jpeg)

<font style="color:rgb(88, 90, 90);">FormationSlotClipData : </font>ClipDataBase

通过拖拽将按键模组拖入指定区域，根据ModuleData的类型来生成片段数据ClipData，由TrackData管理。

**3.轨道数据结构**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1724811037077-a4e23644-7800-4424-9958-befd661243f9.jpeg)

轨道数据TrackData由TrackDataVM数据层管理。

**4.指令数据结构**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1728709742461-3588ac59-4a2c-427f-be10-f1cc00093f6f.jpeg)

对ClipDataBase的增删查改都需要通过命令模式，所有命令执行/缓存由CommondMgr管理器统一管理。

**5.类的依赖关系及重要方法。**

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/46026893/1728871352372-a0ae2107-78d8-4e22-a1ad-e40d95f5577a.jpeg)

**6.FormationModuleData需要的配置结构**

+ 阵型模组配置表结构。

    ![](https://cdn.nlark.com/yuque/0/2024/png/46026893/1728717609091-47e1fdc2-ee06-43e1-ae22-324533ba95b0.png)

阵型切换角色移动速度的配置表结构。

![](https://cdn.nlark.com/yuque/0/2024/png/46026893/1728717397672-b0f25a6b-e5f7-49f2-9d09-c7bd121e2f2a.png)

**7.导出的舞步阵型配置json信息**

"KeyClipList":[{"StartTime":12.960001,"EndTime":15.1200008,"ConfigId":1, "DanceType":1},{"StartTime":17.28,"EndTime":19.44,"ConfigId":101, "DanceType":1},{"StartTime":50,"EndTime":70,"ConfigId":0, "DanceType":2}]

ConfigId = 0表示当前阵型槽位没有阵型模组

DanceType = 0表示当前阵型槽位跳舞的类型

# 四.流程设计
+ **重点界面信息**

![](https://cdn.nlark.com/yuque/0/2024/png/45413786/1728461330244-7e46c27b-2552-4469-b525-cc60c4e95931.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1406%2Climit_0)

区域1,2：模组界面，可以拓展谱面编辑器的模组代码。

区域5：   轨道界面， 可以拓展谱面编辑器的轨道组件。

+ **编辑流程**

1.读取阵型模组配置表，生成阵型模组，包括开场阵型和普通阵型。

2.读取/新建配置，根据阵型配置json文件生成轨道信息。

3.拖拽阵型模组进入轨道界面。

4.根据播放的当前时间结合轨道片段信息播放角色动作以及位移，相机信息（如有）等。



# 五.问题
