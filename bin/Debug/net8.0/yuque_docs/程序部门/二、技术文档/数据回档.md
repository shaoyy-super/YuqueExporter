![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713175063488-6530d5b7-3b71-4799-80f4-a1469c7b64e0.png)

### 关闭区服
+ 执行关服命令

salt 'ad-1' state.apply game.stop pillar='{"zone": "2"}'salt 'ad-1' state.apply game.stop pillar='{"zone": "3"}'salt 'ad-1' state.apply game.stop pillar='{"zone": "4"}'salt 'ad-1' state.apply game.stop pillar='{"zone": "5"}'

### 备份数据
+ 执行备份命令

 salt 'ad-1' state.apply game.backupdb pillar='{"zone": "2"}' salt 'ad-1' state.apply game.backupdb pillar='{"zone": "3"}' salt 'ad-1' state.apply game.backupdb pillar='{"zone": "4"}' salt 'ad-1' state.apply game.backupdb pillar='{"zone": "5"}'

### 回档数据
+ 找到指定日期备份的数据，修改目录服的import-gamedb.sls和import-logindb.sls文件中的路径，修改时间日期

# vim import-gamedb.sls{# 游戏版本 #}

{% set version = pillar['version'] %}

{# 根目录 #}

{% set root_dir = pillar['game']['root_dir'] %}

{# MySQL配置 #}

{% set mysql = pillar['game']['mysql'] %}

{# id:1 jz 2:gp #}

{% set id = pillar['game']['id'] %}





{# 所有区服或指定区服 #}

{% for zone, info in pillar['game']['zones'].items() %}

  {% if grains["id"] == info.host %} 

    {% if pillar['zone'] == '*' or pillar['zone'] == zone|string %}

      {# 查询在线玩家 #}

      import game_{{ zone }} db:

        cmd.run:

          - name: mysql -h localhost -u root -p{{ mysql.password }} < /data/backup/db/9/202006010000/{{ zone }}/game.sql

          - runas: root

    {% endif %}

  {% endif %}

{% endfor %}# vim import-logindb.sls{# 游戏版本 #}

{% set version = pillar['version'] %}

{# 根目录 #}

{% set root_dir = pillar['game']['root_dir'] %}

{# MySQL配置 #}

{% set mysql = pillar['game']['mysql'] %}

{# id:1 jz 2:gp #}

{% set id = pillar['game']['id'] %}





{# 所有区服或指定区服 #}

{% for zone, info in pillar['game']['zones'].items() %}

  {% if grains["id"] == info.host %} 

    {% if pillar['zone'] == '*' or pillar['zone'] == zone|string %}

      {# 查询在线玩家 #}

      import game_{{ zone }} db:

        cmd.run:

          - name: mysql -h localhost -u root -p{{ mysql.password }} < /data/backup/db/9/202006010000/{{ zone }}/login.sql

          - runas: root

    {% endif %}

  {% endif %}

{% endfor %}

+ 执行回档命令

# 恢复game数据库salt 'ad-1' state.apply game.import-gamedb pillar='{"zone": "2"}'salt 'ad-1' state.apply game.import-gamedb pillar='{"zone": "3"}'salt 'ad-1' state.apply game.import-gamedb pillar='{"zone": "4"}'salt 'ad-1' state.apply game.import-gamedb pillar='{"zone": "5"}'# 恢复login数据库salt 'ad-1' state.apply game.import-logindb pillar='{"zone": "2"}'salt 'ad-1' state.apply game.import-logindb pillar='{"zone": "3"}'salt 'ad-1' state.apply game.import-logindb pillar='{"zone": "4"}'salt 'ad-1' state.apply game.import-logindb pillar='{"zone": "5"}'

