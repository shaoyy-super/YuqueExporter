![](https://cdn.nlark.com/yuque/0/2024/png/43288467/1713176694684-2170f500-afc9-4a00-842c-6716d5306145.png)

### 机器初始化
参考[thoughts 文档](https://thoughts.teambition.com/workspaces/5dfb64dfdd03ff001360619e/docs/5dfdbb0ae8307b00012b8809)

### 安装mariadb（有云数据库的无需安装server端，只需安装数据库客户端工具即可）
+ 安装Mariadb

yum install mariadb-server -y

+ **注：若有云数据库，则后续数据库操作可省略**
+ 修改配置

vim /etc/my.cnf

# 替换下面字段datadir=/data/mysql

socket=/data/mysql/mysql.sock

innodb_file_per_table = 1log_bin=mysql-bin

log_bin_index=mysql-bin.index

expire_logs_days=7

binlog_format=mixed

max_binlog_size=100m

binlog_cache_size=4m

max_binlog_cache_size=512m

+ 创建数据目录

mkdir -p /data/mysqlchown -R mysql.root /data/mysql/

+ 链接sock文件

ln -s /data/mysql/mysql.sock  /var/lib/mysql/

+ 启动服务

systemctl start mariadb.servicesystemctl enable mariadb.service

+ 查看端口

netstat -tnlp | grep 3306

+ 设置密码

# 设置密码（Dm2018Pwd123）mysql_secure_installation

### 安装salt-minion
+ 添加salt-repo仓库

vim /etc/yum.repos.d/saltstack-rhel7.repo[saltstack-repo]

name=SaltStack repo for RHEL/CentOS $releasever

baseurl=https://archive.repo.saltproject.io/yum/redhat/7/x86_64/3000/

enabled=1

gpgcheck=0

+ 安装salt-minion

yum install salt-minion -y

+ 添加解析

echo "your-master-ip  salt" >> /etc/hosts

+ 修改配置

vim /etc/salt/minion# 修改下面字段

id: game-1

grains:

  roles:

   - game

  network:

    #替换为对应的公网ip和域名   - 106.75.48.251

   - jljx-4s42-hz.sthaozhe.com

+ 启动服务

systemctl enable salt-minion

systemctl start salt-minion

+ 查看进程

ps axu | grep salt-minion

### 安装filebeat
+ 安装supervisor

 yum install -y supervisor

+ 安装filebeat

cd /data/elktar xf filebeat-7.2.0-linux-x86_64.tar.gz

+ 修改配置

vim filebeat-7.2.0-linux-x86_64/filebeat.yml#以下为部分配置filebeat.inputs:

- type: log

  enabled: true#日志收集路径根据实际路径可做对应修改

  paths:

     - /data/zones/*/log/etl-*.log.*

     - /data/zones/*/log/bourse-*.log.*  #口袋2独有

  multiline.pattern: ^[2][0]

  multiline.negate: true

  multiline.match: after

  ignore_older: 48h

  clean_inactive: 72h



#日志输出到logstash，单节点只写一个即可，多节点如下output.logstash:

  hosts: ["10.9.118.148:5044","10.9.57.231:5044","10.9.12.250:5044"]

  loadbalance: true  #单节点不需要此配置

+ 创建supervisor的配置文件

vim /etc/supervisord.d/filebeat.ini######################

[program:filebeat]

command=/data/elk/filebeat-7.2.0-linux-x86_64/filebeat -e

process_name=%(program_name)s

numprocs=1

directory=/data/elk/filebeat-7.2.0-linux-x86_64

umask=022

priority=999

autostart=true

autorestart=true

startsecs=10

startretries=3

exitcodes=0,2

stopsignal=TERM

stopwaitsecs=10

user=root

redirect_stderr=true

stdout_logfile=/data/elk/filebeat-7.2.0-linux-x86_64/logs/filebeat_stdout.log

stdout_logfile_maxbytes=1MB

stdout_logfile_backups=10

stdout_capture_maxbytes=1MB

stdout_events_enabled=false

stderr_logfile=/data/elk/filebeat-7.2.0-linux-x86_64/logs/filebeat_stderr.log

stderr_logfile_maxbytes=1MB

stderr_logfile_backups=10

+ 创建filebeat日志文件

mkdir /data/elk/filebeat-7.2.0-linux-x86_64/logs/

+ 启动进程

systemctl enable supervisord

systemctl start supervisord

+ 查看进程

supervisorctl status

### 安装ossutil
+ 下载

wget [http://gosspublic.alicdn.com/ossutil/1.6.13/ossutil64](http://gosspublic.alicdn.com/ossutil/1.6.13/ossutil64) mv ossutil64  /usr/sbin/

+ 修改权限

chmod 755 /usr/sbin/ossutil64

+ 配置

./ossutil64 configendpoint:  [http://oss-cn-shanghai.aliyuncs.comaccessKeyID:](http://oss-cn-shanghai.aliyuncs.comaccessKeyID:) yourAccessKeyID accessKeySecret: yourAccessKeySecret

