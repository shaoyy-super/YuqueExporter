# <font style="color:black;">AB包构建选项</font>
### 脚本：<font style="color:black;">RSBundleBuildOption.cs</font>
### 说明：AB构建选项（通过目录区分不同资源类型的资源）
![](https://cdn.nlark.com/yuque/0/2024/png/35803056/1723703518369-fab99466-7b2f-4a98-b4b2-317fb9f0e937.png)

![](https://cdn.nlark.com/yuque/0/2024/png/35803056/1723703527138-dd3d7bee-aab8-41f5-9561-68f8abb562fd.png)

# <font style="color:black;">AB构建规则</font>
### 脚本：<font style="color:black;">ABBuildRule.cs</font>
### 说明：AB包分包规则
```plain
public enum RuleApplyType
{
	[Tooltip("当前目录下每个文件一个包")]
	EveryFileInCurDir,
	[Tooltip("一级子目录下每个文件一个包(仅包含这一级目录下的文件，更深层的文件忽略)")]
	EveryFileInFirstSubDir,
	[Tooltip("整个目录下所有文件一个包")]
	EveryFileInTheWholeDir,
	[Tooltip("一级子目录下每个文件一个包(包含更深层的文件)")]
	EveryFileInEverySubDir,
	[Tooltip("整个目录打一个包")]
	TheWholeDir,
	[Tooltip("每个一级子目录一个包")]
	EveryFirstSubDir,
	[Tooltip("每个二级子目录一个包")]
	EverySecondSubDir,
	// 按尺寸分别时，只能一条Rule一个分包
	[Tooltip("目录整个打一个包(按大小分包)")]
	WholeDirCutBySize,
}
/// <summary>
/// AB包生成变体的类型
/// </summary>
public enum VariantType
{
	[Tooltip("无变体")]
	None,
	/// <summary>
	/// 1、EveryFileInCurDir、EveryFileInFirstSubDir、EveryFileInTheWholeDir、EveryFileInEverySubDir
	///		文件所属的规则目录名，作为变体名；通常不是ApplyPath配置的目录
	/// 2、EveryFirstSubDir
	///     子级目录名作为变体，当前目录作为包名；如果没有子目录，则视为无变体包；
	/// </summary>
	[Tooltip("用匹配到的目录名作为变体名（原Auto），通常单文件打包会用")]
	VariantByDir,
	[Tooltip("用规则匹配目录的父目录做变体名")]
	VariantByParentDir,
	[Tooltip("用规则匹配目录的子目录做变体名：要重做打包信息，把每个子目录作为一个包")]
	VariantByChildDir,
}
/// <summary>
/// 拓展说明：
/// 增加资源类型时
/// 1、ABBuildUtility.GetAssetType()里要增加通过拓展名识别Type的case
/// 2、如果是SubAsset， ABBuildUtility.GetAssetType要添加映射
/// 3、枚举的Value尽量跟AssetClassID里的对应关系保持一致
/// </summary>
public enum AssetType
{
	/// <summary>
	/// 非法资源类型
	/// </summary>
	None = -1,
	[Tooltip("代表全部资源")]
	Object = 0,
	Prefab = 1,
	Material = 21,
	Texture = 27,
	Shader = 48,
	Text = 49,
	AnimationClip = 74,
	AudioClip = 83,
	AnimatorController = 93,
	Sprite = 213,
	AudioMixer = 240,
	[Tooltip("包含场景")]
	SceneAsset = 1032,
}
/// <summary>
/// 拆分子包的配置
/// </summary>
[Serializable]
public class SubBundle
{
	[Header("要拆分到子包的资源类型")]
	public AssetType[] AssetTypes;
	[Header("要拆分到子包的文件名后缀（部分资源无法用资源类型识别出来）")]
	public string[] MatchSuffix;
	[Header("子包在主包基础上加的后缀")]
	public string NameSuffix;
}

```

# <font style="color:black;">资源导入格式设置</font>
### 脚本：<font style="color:black;">AssetFormatSetting.cs</font>
### 说明：对指定目录先指定命名规则的资源设置导入格式
![](https://cdn.nlark.com/yuque/0/2024/png/35803056/1723704090926-38abe402-e3ad-411a-9098-ae6cb79b6df8.png)

# <font style="color:black;">打AB包管理类</font>
### 脚本：<font style="color:black;">ABBuildMgr.cs</font>
### 说明：AB包打包管理工具
1. <font style="color:black;">完整打包（比增量打包多一步清理目录）：public static void FullBuild(string platform)</font>
2. <font style="color:black;">增量打包：public static void IncrementalBuild(string platform)</font>
3. <font style="color:black;">根据规则打包：private static void _BuildByRule()</font>
4. <font style="color:black;">控制整个流程的Pipeline，进行整体上的处理：public static Pipeline<FlowResult, FlowTask> GetFlowPipeline()</font>
    1. <font style="color:black;">根据规则生成全部AB包列表：public static bool GenAll(ABPackager.FlowTask flowTask)</font>
    2. <font style="color:black;">合并同名的Bundle：public static bool MergeSameBundle(ABPackager.FlowTask flowTask)</font>
    3. <font style="color:black;">整理生成AssetMap信息：public static bool CollectAssetMap(ABPackager.FlowTask flowTask)</font>
5. <font style="color:black;">执行打AB包：AssetBundleManifest manifest = BuildPipeline.BuildAssetBundles(path, allBundleBuild, options, target);</font>
6. <font style="color:black;">生成FileList内容：记录AB包的大小、Hash等：private static IFileList _GenFileList(AssetBundleManifest manifest, IList<AssetBundleBuild> bundleBuildList)</font>
    1. <font style="color:black;">生成hash码：public static string[] ComputeInJob(string[] filePaths)</font>

# 资源版本
### 脚本：ClientConfig.cs
### 说明：客户端配置
![](https://cdn.nlark.com/yuque/0/2024/png/35803056/1723704774265-c1a023b4-ab0f-4e82-ad61-052a1f5bf6b3.png)

# 热更新
### 脚本：PatchSys.cs，PatchSystem.cs
### 说明：补丁系统（热更新系统的对外接口）
### 获取补丁信息：public static IEnumerator FetchPatchInfo()
### 下载补丁：public static IEnumerator DownloadPatches()
## 文件下载器
### 脚本：HttpDownloader.cs
### 说明：文件下载器
### 设置下载的基础控制参数：public void Setting(int timeoutSeconds, int retryTimes, int maxUpdateCnt)
### 下载文件：public void Download(string url, Action<DownloadResult> onFinish)
### 下载并将其写入本地文件：public void SaveTo(string url, string savePath, Action<DownloadResult> onFinish)
### 中断指定的下载任务：public void Abort(string url)
## 补丁生成器
### 脚本：PatchGenerator.cs
### 说明：通过hash值对比获取需要热更新的文件列表
### 填充参与处理的文件列表（本地可用列表和远端完整列表）：public void Generate(IEnumerable<IFileEntity> fullFiles, IEnumerable<IFileEntity> usableFiles,	Func<IFileEntity, bool> canPatch = null)
### 获取要下载的补丁大小（bytes）：public ulong PatchSize
### 获取补丁文件列表：public List<IFileEntity> PatchFiles
